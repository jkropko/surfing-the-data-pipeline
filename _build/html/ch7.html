

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>7. Database Queries &#8212; Surfing the Data Pipeline with Python</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'ch7';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="8. Data Wrangling with pandas" href="ch8.html" />
    <link rel="prev" title="6. Creating and Connecting to Databases" href="ch6.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/surf.jpg" class="logo__image only-light" alt="Surfing the Data Pipeline with Python - Home"/>
    <script>document.write(`<img src="_static/surf.jpg" class="logo__image only-dark" alt="Surfing the Data Pipeline with Python - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Surfing the Data Pipeline with Python
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Get Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ch1.html">1. Getting Yourself Unstuck</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Get Data</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ch2.html">2. Loading Data from Electronic Data Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch3.html">3. Loading, Converting, and Writing JSON Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch4.html">4. Acquiring Data from APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch5.html">5. Web Scraping Using <code class="docutils literal notranslate"><span class="pre">BeautifulSoup</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch6.html">6. Creating and Connecting to Databases</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Wrangle Data</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">7. Database Queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch8.html">8. Data Wrangling with <code class="docutils literal notranslate"><span class="pre">pandas</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch9.html">9. Reshaping and Merging Data and Working with Strings, Dates, and Times</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Explore and Communicate Data</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ch10.html">10. Exploratory Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch11.html">11. Static Data Visualizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch12.html">12. Interactive Data Visualizations and Dashboards</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/ch7.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Database Queries</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-the-history-of-the-structured-query-language-sql">7.1. Introduction: The History of the Structured Query Language (SQL)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#declarative-and-procedural-languages">7.1.1. Declarative and Procedural Languages</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#popularity-of-sql">7.1.2. Popularity of SQL</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-read-update-and-delete-crud-operations">7.2. Create, Read, Update, and Delete (CRUD) Operations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sql-style-capitalization-quotes-new-lines-indentation">7.3. SQL Style: Capitalization, Quotes, New Lines, Indentation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sql-joins">7.4. SQL Joins</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-database-nfl-and-nba-teams">7.4.1. Example Database: NFL and NBA Teams</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#types-of-joins">7.4.2. Types of Joins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inner-joins">7.4.3. Inner Joins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#left-and-right-joins">7.4.4. Left and Right Joins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#full-outer-join">7.4.5. Full (Outer) Join</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#anti-joins">7.4.6. Anti-Joins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#natural-joins">7.4.7. Natural Joins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-joins">7.4.8. Cross Joins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-joins-in-one-query">7.4.9. Multiple Joins in One Query</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#joins-on-more-than-one-index">7.4.10. Joins on More Than One Index</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sql-create-update-and-delete-operations">7.5. SQL Create, Update, and Delete Operations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-new-records">7.5.1. Creating New Records</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#editing-existing-records">7.5.2. Editing Existing Records</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deleting-records">7.5.3. Deleting Records</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cleaning-and-manipulating-data-with-sql-read-operations">7.6. Cleaning and Manipulating Data with SQL Read Operations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-wine-reviews">7.6.1. Example: Wine Reviews</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-columns">7.6.2. Selecting Columns</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#logical-statements">7.6.3. Logical Statements</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#filtering-rows">7.6.4. Filtering Rows</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sorting-data">7.6.5. Sorting Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#renaming-columns-and-transforming-data-values">7.6.6. Renaming Columns and Transforming Data Values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-aggregation">7.6.7. Data Aggregation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#subqueries">7.6.8. Subqueries</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sql-security">7.7. SQL Security</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mongodb-queries">7.8. MongoDB Queries</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-and-deleting-records">7.8.1. Creating and Deleting Records</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-data-and-selecting-records">7.8.2. Reading Data and Selecting Records</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-features">7.8.3. Selecting Features</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#updating-records">7.8.4. Updating Records</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-text-searches">7.8.5. Performing Text Searches</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="database-queries">
<h1><a class="toc-backref" href="#id1" role="doc-backlink"><span class="section-number">7. </span>Database Queries</a><a class="headerlink" href="#database-queries" title="Permalink to this heading">#</a></h1>
<nav class="contents" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#database-queries" id="id1">Database Queries</a></p>
<ul>
<li><p><a class="reference internal" href="#introduction-the-history-of-the-structured-query-language-sql" id="id2">Introduction: The History of the Structured Query Language (SQL)</a></p>
<ul>
<li><p><a class="reference internal" href="#declarative-and-procedural-languages" id="id3">Declarative and Procedural Languages</a></p></li>
<li><p><a class="reference internal" href="#popularity-of-sql" id="id4">Popularity of SQL</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#create-read-update-and-delete-crud-operations" id="id5">Create, Read, Update, and Delete (CRUD) Operations</a></p></li>
<li><p><a class="reference internal" href="#sql-style-capitalization-quotes-new-lines-indentation" id="id6">SQL Style: Capitalization, Quotes, New Lines, Indentation</a></p></li>
<li><p><a class="reference internal" href="#sql-joins" id="id7">SQL Joins</a></p>
<ul>
<li><p><a class="reference internal" href="#example-database-nfl-and-nba-teams" id="id8">Example Database: NFL and NBA Teams</a></p></li>
<li><p><a class="reference internal" href="#types-of-joins" id="id9">Types of Joins</a></p></li>
<li><p><a class="reference internal" href="#inner-joins" id="id10">Inner Joins</a></p></li>
<li><p><a class="reference internal" href="#left-and-right-joins" id="id11">Left and Right Joins</a></p></li>
<li><p><a class="reference internal" href="#full-outer-join" id="id12">Full (Outer) Join</a></p></li>
<li><p><a class="reference internal" href="#anti-joins" id="id13">Anti-Joins</a></p></li>
<li><p><a class="reference internal" href="#natural-joins" id="id14">Natural Joins</a></p></li>
<li><p><a class="reference internal" href="#cross-joins" id="id15">Cross Joins</a></p></li>
<li><p><a class="reference internal" href="#multiple-joins-in-one-query" id="id16">Multiple Joins in One Query</a></p></li>
<li><p><a class="reference internal" href="#joins-on-more-than-one-index" id="id17">Joins on More Than One Index</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#sql-create-update-and-delete-operations" id="id18">SQL Create, Update, and Delete Operations</a></p>
<ul>
<li><p><a class="reference internal" href="#creating-new-records" id="id19">Creating New Records</a></p></li>
<li><p><a class="reference internal" href="#editing-existing-records" id="id20">Editing Existing Records</a></p></li>
<li><p><a class="reference internal" href="#deleting-records" id="id21">Deleting Records</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#cleaning-and-manipulating-data-with-sql-read-operations" id="id22">Cleaning and Manipulating Data with SQL Read Operations</a></p>
<ul>
<li><p><a class="reference internal" href="#example-wine-reviews" id="id23">Example: Wine Reviews</a></p></li>
<li><p><a class="reference internal" href="#selecting-columns" id="id24">Selecting Columns</a></p></li>
<li><p><a class="reference internal" href="#logical-statements" id="id25">Logical Statements</a></p></li>
<li><p><a class="reference internal" href="#filtering-rows" id="id26">Filtering Rows</a></p></li>
<li><p><a class="reference internal" href="#sorting-data" id="id27">Sorting Data</a></p></li>
<li><p><a class="reference internal" href="#renaming-columns-and-transforming-data-values" id="id28">Renaming Columns and Transforming Data Values</a></p></li>
<li><p><a class="reference internal" href="#data-aggregation" id="id29">Data Aggregation</a></p></li>
<li><p><a class="reference internal" href="#subqueries" id="id30">Subqueries</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#sql-security" id="id31">SQL Security</a></p></li>
<li><p><a class="reference internal" href="#mongodb-queries" id="id32">MongoDB Queries</a></p>
<ul>
<li><p><a class="reference internal" href="#creating-and-deleting-records" id="id33">Creating and Deleting Records</a></p></li>
<li><p><a class="reference internal" href="#reading-data-and-selecting-records" id="id34">Reading Data and Selecting Records</a></p></li>
<li><p><a class="reference internal" href="#selecting-features" id="id35">Selecting Features</a></p></li>
<li><p><a class="reference internal" href="#updating-records" id="id36">Updating Records</a></p></li>
<li><p><a class="reference internal" href="#performing-text-searches" id="id37">Performing Text Searches</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
<section id="introduction-the-history-of-the-structured-query-language-sql">
<h2><a class="toc-backref" href="#id2" role="doc-backlink"><span class="section-number">7.1. </span>Introduction: The History of the Structured Query Language (SQL)</a><a class="headerlink" href="#introduction-the-history-of-the-structured-query-language-sql" title="Permalink to this heading">#</a></h2>
<div style= "float:right;position: relative; padding: 10px">
<a href="https://xkcd.com/1409/"><img src="https://imgs.xkcd.com/comics/query.png" width="400"></a>
</div>
<p>The structured query language (SQL) was invented by Donald D. Chamberlin and Raymond F. Boyce in 1974. Chamberlain and Boyce were both young computer scientists working at the IBM T.J. Watson Research Center in Yorktown Heights, New York, and they met E. F. Codd at a research symposium that Codd organized there. Codd, four years prior, had published the <a class="reference external" href="https://www.seas.upenn.edu/~zives/03f/cis550/codd.pdf">seminal article that defined the relational model</a> for databases. Codd’s relational model is defined using relational algebra and relational calculus, two notational standards that Codd himself created to elaborate on set theory as applied specifically to data tables. One important property of set theory is that highly abstract mathematical expressions can be expressed in plain language. For example, consider the set <span class="math notranslate nohighlight">\(A\)</span> of holidays in the United States during which banks are closed:</p>
<div class="math notranslate nohighlight">
\[\begin{split} A = \{\text{New Year's Day}, \text{Birthday of Martin Luther King, Jr.}, \\  \text{Washington’s Birthday}, \text{Memorial Day}, \text{Independence Day}, \\  \text{Labor Day}, \text{Columbus Day}, \text{Veterans Day},  \\ \text{Thanksgiving Day}, \text{Christmas}\}\end{split}\]</div>
<p>Also consider the set <span class="math notranslate nohighlight">\(B\)</span> of holidays in the United Kingdom during which banks are closed:</p>
<div class="math notranslate nohighlight">
\[\begin{split} B = \{\text{New Year's Day}, \text{Good Friday}, \text{Easter Monday}, \\ \text{Early May bank holiday}, \text{Spring bank holiday}, \\\text{Summer bank holiday}, \text{Christmas}, \text{Boxing Day}\}\end{split}\]</div>
<p>The intersection between sets <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(B\)</span> is a set that consists of all elements that exist with both set <span class="math notranslate nohighlight">\(A\)</span> and set <span class="math notranslate nohighlight">\(B\)</span>:</p>
<div class="math notranslate nohighlight">
\[ A \cap B = \{\text{New Year's Day}, \text{Christmas}\}\]</div>
<p>The notation <span class="math notranslate nohighlight">\(A\cap B\)</span> is a mathematical abstraction of an idea that can be expressed in plain-spoken language: <span class="math notranslate nohighlight">\(\cap\)</span> means “and”, and <span class="math notranslate nohighlight">\(A\cap B\)</span> means <span class="math notranslate nohighlight">\(A\)</span> <em>and</em> <span class="math notranslate nohighlight">\(B\)</span>, or all elements that are in both <span class="math notranslate nohighlight">\(A\)</span> <em>and</em> <span class="math notranslate nohighlight">\(B\)</span>. Put another way, <span class="math notranslate nohighlight">\(A\cap B\)</span> is the set of all holidays during which banks are closed in both the United States <em>and</em> the United Kingdom. Likewise, every piece of set notation can be expressed semantically.</p>
<p>Although Codd laid out the broad parameters of the relational model in mathematical terms, he did not design software or a physical architecture for a relational database. He explicitly left that work up to future research:</p>
<blockquote>
<div><p>Many questions are raised and left unanswered. For example, only a few of the more important properties of the data sublanguage … are mentioned. Neither the purely linguistic details of such a language nor the implementation problems are discussed. Nevertheless, the material presented should be adequate for experienced systems programmers to visualize several approaches (p. 387).</p>
</div></blockquote>
<p>Chamberlin and Boyce took up the challenge of writing a programming language to implement Codd’s relational model. <a class="reference external" href="https://ieeexplore.ieee.org/document/6359709">As Chamberlin explains</a>, their primary goal was to create a version of Codd’s set-theoretical relational model that could be expressed in plain language:</p>
<blockquote>
<div><p>The more difficult barrier was at the semantic level. The basic concepts of Codd’s languages were adapted from set theory and symbolic logic. This was natural given Codd’s background as a mathematician, but Ray and I hoped to design a relational language based on concepts that would be familiar to a wider population of users (p. 78).</p>
</div></blockquote>
<p>In short, the idea behind SQL is to implement Codd’s abstract system of using logical statements with set theoretical notation to narrow down the specific records and features in a dataset that a user wishes to read or edit, but to phrase these operations in accessable, plain language. One of the best things about SQL is that once you are used to the language, it reads just like English. That said, Chamberlin admits that SQL “has not proved to be as accessible to untrained users as Ray and I originally hoped” (<a class="reference external" href="https://ieeexplore.ieee.org/document/6359709">p. 81</a>).</p>
<p>Another benefit of SQL is that this language is one of the most universal programming languages in existence. It is designed to work with database management systems on any platform, and it works seamlessly within Python, R, C, Java, Javascript, and so on. While the standards for languages and platforms change, SQL has been in continuous use for relational database management since the 1980s and shows no sign of becoming antiquated or being replaced. The SQL syntax exists outside of any individual DBMS, and is maintained by the <a class="reference external" href="https://en.wikipedia.org/wiki/American_National_Standards_Institute">American National Standards Institute (ANSI)</a> and the <a class="reference external" href="https://en.wikipedia.org/wiki/International_Organization_for_Standardization">International Organization for Standardization (ISO)</a>, two non-profit organizations that facilitate the development of <a class="reference external" href="https://en.wikipedia.org/wiki/Standardization">voluntary consensus standards</a> for things like programming languages and hardware. Despite the universality of SQL, however, different DBMSs use slightly different versions of SQL, adding some unique functionality in some cases, and failing to implement the entire SQL standard in others. MySQL for example <a class="reference external" href="https://stackoverflow.com/questions/4796872/how-to-do-a-full-outer-join-in-mysql">lacks the ability to perform a full join</a>. PostgreSQL distinguishes itself from other RDBMSs by striving to implement as much of the global SQL standard as possible. While there some important differences in the version of SQL used by different DBMSs, the differences generally apply to very specific situations and all implementations of SQL use mostly the same syntax and can do mostly the same work.</p>
<section id="declarative-and-procedural-languages">
<h3><a class="toc-backref" href="#id3" role="doc-backlink"><span class="section-number">7.1.1. </span>Declarative and Procedural Languages</a><a class="headerlink" href="#declarative-and-procedural-languages" title="Permalink to this heading">#</a></h3>
<p>SQL is considered to be a <a class="reference external" href="https://en.wikipedia.org/wiki/Declarative_programming">declarative language</a>, which means that it defines the broad task that a particular computer system must carry out, but it does not define the mechanism through which the system completes the task. For example, SQL can tell a system to access two tables and join them together, but that command must tell a DBMS to access additional code that tells the system how exactly to search and operate on the rows and columns of each data table. A language that provides specific instructions to a system on how to carry out a task - by changing the system state in some way, including how the data exist in the system - is a <a class="reference external" href="https://en.wikipedia.org/wiki/Procedural_programming">procedural language</a>. The code that a procedural language uses to make these changes on the system is called <a class="reference external" href="https://en.wikipedia.org/wiki/Imperative_programming">imperative code</a>. A DBMS can be thought of as a function that takes declarative SQL code as an input, finds and runs the imperative code that carries out the declarative task, and returns the output. MySQL, for example, <a class="reference external" href="https://dev.mysql.com/doc/refman/8.0/en/features.html">uses imperative C and C++ code</a> to carry out SQL queries.</p>
</section>
<section id="popularity-of-sql">
<h3><a class="toc-backref" href="#id4" role="doc-backlink"><span class="section-number">7.1.2. </span>Popularity of SQL</a><a class="headerlink" href="#popularity-of-sql" title="Permalink to this heading">#</a></h3>
<p>Common standards and the most popular programming languages and environments change all the time. It’s an eternal struggle for data scientists as well as programmers of all kinds, and a matter of consistent anxiety. Presently, Python is the most widely used tool for data science, but will we all have to drop Python soon and <a class="reference external" href="https://towardsdatascience.com/bye-bye-python-hello-julia-9230bff0df62">teach ourselves Julia</a>?</p>
<p>In this context, it is stunning that SQL has been so widely used since the 1970s. According to a <a class="reference external" href="https://insights.stackoverflow.com/survey/2017">Stack Overflow survey</a>, SQL is the one of most widely used programming languages among the people who filled out the survey, second only to Javascript. Taking into account the high-tech biases in this specific sample, it is probably the case the SQL is more widely used than any other language mentioned in this survey. What accounts for this popularity?</p>
<p>This <a class="reference external" href="https://blog.sqlizer.io/posts/sql-43/">blog post</a> argues that SQL achieved this level of longevity because it came to prominence during a time in which many of the baseline standards for the development of computer systems were being invented. As more and more systems were developed in a way that depends on SQL, it became harder to change this standard. But SQL is also simple and highly functional because it is a semantic language that expresses set-theoetical and logical operations. As long as relational databases are used, there’s not much functionality that can be added to a query language beyond these foundational mathematical operations, and whatever additional functionality is needed can be added to a version of SQL by a particular DBMS. There are also many different open source and proprietary DBMSs that all employ SQL, so different users can have a choice over many different DBMSs and platforms without having to learn a query language other than SQL.</p>
<p>That said, there’s much less of a reason to use SQL when the database is not organized according to the relational model. NoSQL databases have much more flexible schema in general, and can store the data in one big table or in as many tables as there are records, or even datapoints, in the database. In fact, without a relational schema, the notion of a data table makes less sense in general. For example, a document store is a collection of individual records encoded using JSON or XML, and not as tables. These records can be sharded: stored in many corresponding servers in a distributed system to address challenges with the size of the database and the speed with which database transactions are conducted. Without tables, NoSQL DBMSs do not usually use SQL. MongoDB, for example, works with queries that are themselves in JSON format.</p>
</section>
</section>
<section id="create-read-update-and-delete-crud-operations">
<h2><a class="toc-backref" href="#id5" role="doc-backlink"><span class="section-number">7.2. </span>Create, Read, Update, and Delete (CRUD) Operations</a><a class="headerlink" href="#create-read-update-and-delete-crud-operations" title="Permalink to this heading">#</a></h2>
<p><strong>Persistent storage</strong> refers to a system in which <a class="reference external" href="https://en.wikipedia.org/wiki/Persistence_(computer_science)">data outlives the process that created it</a>. When you work with software that allows you to save a file, the file is stored in persistent storage because it still exists even after you close the software application. Hard drives are examples of persistent storage, as are local and remote servers that store databases. Any persistent storage mechanism must have methods for creating, reading (or loading), updating (or editing), and deleting the data in that storage device. Create, Read, Update, and Delete are the CRUD Operations.</p>
<p>We’ve previously employed CRUD operations using the <code class="docutils literal notranslate"><span class="pre">requests</span></code> library to use an API or to do web scraping. Like <code class="docutils literal notranslate"><span class="pre">requests</span></code>, SQL and other query languages have CRUD operations. The following table, adapted from a similar one that appears on the <a class="reference external" href="https://en.wikipedia.org/wiki/Create%2C_read%2C_update_and_delete">Wikipedia page for the CRUD operations</a>, shows these operations in the <code class="docutils literal notranslate"><span class="pre">requests</span></code> package, SQL, and the MongoDB query language:</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head text-left"><p>Operation</p></th>
<th class="head text-left"><p><code class="docutils literal notranslate"><span class="pre">requests</span></code> method</p></th>
<th class="head text-left"><p>SQL</p></th>
<th class="head text-left"><p>MongoDB</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>Create</p></td>
<td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">requests.put()</span></code> or <code class="docutils literal notranslate"><span class="pre">requests.post()</span></code></p></td>
<td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">INSERT</span></code></p></td>
<td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">Insert</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>Read</p></td>
<td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">requests.get()</span></code></p></td>
<td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">SELECT</span></code></p></td>
<td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">Find</span></code></p></td>
</tr>
<tr class="row-even"><td class="text-left"><p>Update</p></td>
<td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">requests.patch()</span></code></p></td>
<td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">UPDATE</span></code></p></td>
<td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">Update</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>Delete</p></td>
<td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">requests.delete()</span></code></p></td>
<td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">DELETE</span></code></p></td>
<td class="text-left"><p><code class="docutils literal notranslate"><span class="pre">Remove</span></code></p></td>
</tr>
</tbody>
</table>
<p>As a data scientist, you will most often use read operations to obtain the data you need for your analysis. However, if you are collecting original data for your project, the create, update, and delete operations become much more important. We will discuss all four operations and their variants in the context of SQL and MongoDB below.</p>
<p>We can work with SQL using <code class="docutils literal notranslate"><span class="pre">pandas</span></code> if we first create an engine that links to a specific DBMS, server, and database with <code class="docutils literal notranslate"><span class="pre">create_engine</span></code> from <code class="docutils literal notranslate"><span class="pre">sqlalchemy</span></code>. Once we do, the <code class="docutils literal notranslate"><span class="pre">pd.read_sql_query()</span></code> function makes read operations straightforward, and the <code class="docutils literal notranslate"><span class="pre">.execute()</span></code> method applied to the engine lets us easily issue create, update, and delete commands.</p>
</section>
<section id="sql-style-capitalization-quotes-new-lines-indentation">
<h2><a class="toc-backref" href="#id6" role="doc-backlink"><span class="section-number">7.3. </span>SQL Style: Capitalization, Quotes, New Lines, Indentation</a><a class="headerlink" href="#sql-style-capitalization-quotes-new-lines-indentation" title="Permalink to this heading">#</a></h2>
<p>There are many ways to write an SQL query, and when you look at someone else’s SQL code you will see a variety of styles. Mostly, with the exception of quotes in some cases, stylistic differences don’t change the behavior of the code, but they can have an impact on how easy the code is for other people to read and understand.</p>
<p>One requirement for SQL code is that the query must end with a semi-colon, and that no semi-colons appear elsewhere in the query. As long as that requirement is met, other stylistic choices are possible.</p>
<p>The least readable way to write an SQL query is to write the entire code on one line, with no capitalization or indentation. The following code is valid SQL code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">select</span> <span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">column1</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">column2</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">column3</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">column4</span> <span class="kn">from</span> <span class="nn">table1</span> <span class="n">t</span> <span class="n">inner</span> <span class="n">join</span> <span class="n">table2</span> <span class="n">r</span> <span class="n">on</span> <span class="n">t</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">id</span> <span class="n">where</span> <span class="n">column1</span><span class="o">&gt;</span><span class="mi">100</span> <span class="n">order</span> <span class="n">by</span> <span class="n">column2</span> <span class="n">desc</span><span class="p">;</span>
</pre></div>
</div>
<p>We will discuss exactly what this query does. But for now, let’s focus on the presentation of code. SQL uses <strong>clauses</strong> to represent particular functions for reading and writing data. In the above query, <code class="docutils literal notranslate"><span class="pre">select</span></code>, <code class="docutils literal notranslate"><span class="pre">from</span></code>, <code class="docutils literal notranslate"><span class="pre">inner</span> <span class="pre">join</span></code>, <code class="docutils literal notranslate"><span class="pre">on</span></code>, <code class="docutils literal notranslate"><span class="pre">where</span></code>, and <code class="docutils literal notranslate"><span class="pre">order</span> <span class="pre">by</span></code> are all clauses, and <code class="docutils literal notranslate"><span class="pre">desc</span></code> is an option applied to the <code class="docutils literal notranslate"><span class="pre">order</span> <span class="pre">by</span></code> clause.</p>
<p>One stylistic choice many people make is to write SQL clauses in capital letters. That helps readers to quickly see the parts of the code that are clauses as opposed to the rest of the code that contains column names, table names, values, and aliases. If we capitalize the clauses and options in the SQL query, it looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">column1</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">column2</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">column3</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">column4</span> <span class="n">FROM</span> <span class="n">table1</span> <span class="n">t</span> <span class="n">INNER</span> <span class="n">JOIN</span> <span class="n">table2</span> <span class="n">r</span> <span class="n">ON</span> <span class="n">t</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">id</span> <span class="n">WHERE</span> <span class="n">column1</span><span class="o">&gt;</span><span class="mi">100</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">column2</span> <span class="n">DESC</span><span class="p">;</span>
</pre></div>
</div>
<p>Another stylistic choice people make to present the code in a more reabable way is to put clauses that are considered distinct enough from other clauses on new lines. The one common exception is <code class="docutils literal notranslate"><span class="pre">FROM</span></code>, which is considered to be closely related to <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> and is often written on the same line as <code class="docutils literal notranslate"><span class="pre">SELECT</span></code>. If we put each clause other than <code class="docutils literal notranslate"><span class="pre">FROM</span></code> on a new line, the query looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">column1</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">column2</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">column3</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">column4</span> <span class="n">FROM</span> <span class="n">table1</span> <span class="n">t</span> 
<span class="n">INNER</span> <span class="n">JOIN</span> <span class="n">table2</span> <span class="n">r</span> 
<span class="n">ON</span> <span class="n">t</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">id</span> 
<span class="n">WHERE</span> <span class="n">column1</span><span class="o">&gt;</span><span class="mi">100</span> 
<span class="n">ORDER</span> <span class="n">BY</span> <span class="n">column2</span> <span class="n">DESC</span><span class="p">;</span>
</pre></div>
</div>
<p>Some clauses are considered to be elaborations upon a previous clause. Column names after <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> are usually written on the same line as <code class="docutils literal notranslate"><span class="pre">SELECT</span></code>, but if these columns themselves require functions that take up more space, it is useful to put them on new lines. Likewise, <code class="docutils literal notranslate"><span class="pre">ON</span></code> is considered an elaboration of <code class="docutils literal notranslate"><span class="pre">INNER</span> <span class="pre">JOIN</span></code>. These lines of code are often indented to express the dependence on the previous line. If we include indentation in the code, the query is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> 
    <span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
    <span class="n">t</span><span class="o">.</span><span class="n">column1</span><span class="p">,</span> 
    <span class="n">t</span><span class="o">.</span><span class="n">column2</span><span class="p">,</span> 
    <span class="n">t</span><span class="o">.</span><span class="n">column3</span><span class="p">,</span> 
    <span class="n">r</span><span class="o">.</span><span class="n">column4</span> 
<span class="n">FROM</span> <span class="n">table1</span> <span class="n">t</span> 
<span class="n">INNER</span> <span class="n">JOIN</span> <span class="n">table2</span> <span class="n">r</span> 
    <span class="n">ON</span> <span class="n">t</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">id</span> 
<span class="n">WHERE</span> <span class="n">column1</span><span class="o">&gt;</span><span class="mi">100</span> 
<span class="n">ORDER</span> <span class="n">BY</span> <span class="n">column2</span> <span class="n">DESC</span><span class="p">;</span>
</pre></div>
</div>
<p>I encourage you to develop good habits with how you write the SQL queries, both for other people to read your code, but more importantly, to make it easier for you yourself to read your code. You will be spending a lot of time developing and debugging SQL queries, and anything you do that cuts down the time to understand your own code will save you a lot of time and frustration in the long-run.</p>
<p>Quotes are only used in SQL code when referring to values of a character feature in one of the data tables. When using quotes while working in Python, it is important to use single quotes, not double quotes, to ensure that the quote that is internal to SQL is not read as a termination of the Python variable that contains the SQL code. That is, it is fine to write a clause that looks like <code class="docutils literal notranslate"><span class="pre">WHERE</span> <span class="pre">column</span> <span class="pre">=</span> <span class="pre">'value'</span></code>, but not <code class="docutils literal notranslate"><span class="pre">WHERE</span> <span class="pre">column</span> <span class="pre">=</span> <span class="pre">&quot;value&quot;</span></code>.</p>
<p>For all of the queries we will write in the following examples, we will store the query as a string variable in Python. We will use the triple-quote syntax, which allows us to write a string that exists on multiple lines. So our SQL query definitions will look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT </span>
<span class="s2">    t.id, </span>
<span class="s2">    t.column1, </span>
<span class="s2">    t.column2, </span>
<span class="s2">    t.column3, </span>
<span class="s2">    r.column4 </span>
<span class="s2">FROM table1 t </span>
<span class="s2">INNER JOIN table2 r </span>
<span class="s2">    ON t.id = r.id </span>
<span class="s2">WHERE column1&gt;100 </span>
<span class="s2">ORDER BY column2 DESC;</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>We will then be able to pass the <code class="docutils literal notranslate"><span class="pre">myquery</span></code> variable to functions like <code class="docutils literal notranslate"><span class="pre">pd.read_sql_query()</span></code> to be evaluated.</p>
</section>
<section id="sql-joins">
<h2><a class="toc-backref" href="#id7" role="doc-backlink"><span class="section-number">7.4. </span>SQL Joins</a><a class="headerlink" href="#sql-joins" title="Permalink to this heading">#</a></h2>
<p>The simplest SQL commands for reading data from a database are <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> and <code class="docutils literal notranslate"><span class="pre">FROM</span></code>. In module 6, we issued the following query to read the entire “reviews” entity from the wine reviews database:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">reviews</span>
</pre></div>
</div>
<p>But this query does not read data from the other entities in the database. It pulls all of the rows and columns from “reviews” and it does not manipulate the data within “reviews” in any way. That might not be the best way to create a dataframe to conduct analyses.</p>
<p>SQL read operations get data, but they can also clean data at the same time. Cleaning data is an important challenge. Even when the data are stored in a well-organized database, that organization might not be the right format for the data given the analyses we intend to do. “<a class="reference external" href="https://www.jstatsoft.org/article/view/v059i10">Tidy Data</a>” by Hadley Wickham lays out a philosophy of what it means to clean a dataset. The goal is to put data into a format in which modeling and visualization is as easy as possible. There are two steps: first we create <strong>tidy data</strong> and then we manipulate the data to fit our specific needs. Tidy data is defined as follows:</p>
<blockquote>
<div><p>A dataset is messy or tidy depending on how rows, columns and tables are matched up with observations, [features] and types. In tidy data:</p>
<ol class="arabic simple">
<li><p>Each [feature] forms a column.</p></li>
<li><p>Each observation forms a row.</p></li>
<li><p>Each type of observational unit forms a table (p. 2).</p></li>
</ol>
</div></blockquote>
<p>In other words, the dataset we will use in an analysis must exist in one table, the rows of the table must represent records (also called observations), the columns of the table must represent features, and the rows must represent comparable units. For example, if the data contain records from the 50 U.S. States, there should be a row for each state, and there should not be a row for regions or for the whole country as these units are not comparable to states. Data from a relational database are not generally in tidy format because the relevant data exists in multiple tables. The first step is to combine these tables into one dataset using <strong>join</strong> functions within SQL read operations. There are many different kinds of joins, and the easiest way to see the difference between these types is to see what they do to real data.</p>
<p>Before we discuss specific examples of how to use SQL, we load the following libraries:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">import</span> <span class="nn">dotenv</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">5</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">import</span> <span class="nn">sys</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="kn">import</span> <span class="nn">os</span>
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="kn">import</span> <span class="nn">dotenv</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;psycopg2&#39;
</pre></div>
</div>
</div>
</div>
<section id="example-database-nfl-and-nba-teams">
<h3><a class="toc-backref" href="#id8" role="doc-backlink"><span class="section-number">7.4.1. </span>Example Database: NFL and NBA Teams</a><a class="headerlink" href="#example-database-nfl-and-nba-teams" title="Permalink to this heading">#</a></h3>
<p>As an example, I create a PostgreSQL database that contains two tables: “nfl” contains the location and team name of all 32 NFL teams:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nfl_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;city&#39;</span><span class="p">:[</span><span class="s1">&#39;Buffalo&#39;</span><span class="p">,</span><span class="s1">&#39;Miami&#39;</span><span class="p">,</span><span class="s1">&#39;Boston&#39;</span><span class="p">,</span><span class="s1">&#39;New York&#39;</span><span class="p">,</span><span class="s1">&#39;Cleveland&#39;</span><span class="p">,</span><span class="s1">&#39;Cincinnati&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;Pittsburgh&#39;</span><span class="p">,</span><span class="s1">&#39;Baltimore&#39;</span><span class="p">,</span><span class="s1">&#39;Kansas City&#39;</span><span class="p">,</span><span class="s1">&#39;Las Vegas&#39;</span><span class="p">,</span><span class="s1">&#39;Los Angeles&#39;</span><span class="p">,</span><span class="s1">&#39;Denver&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;Nashville&#39;</span><span class="p">,</span><span class="s1">&#39;Jacksonville&#39;</span><span class="p">,</span><span class="s1">&#39;Houston&#39;</span><span class="p">,</span><span class="s1">&#39;Indianapolis&#39;</span><span class="p">,</span><span class="s1">&#39;Philadelphia&#39;</span><span class="p">,</span><span class="s1">&#39;Dallas&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;Washington&#39;</span><span class="p">,</span><span class="s1">&#39;Atlanta&#39;</span><span class="p">,</span><span class="s1">&#39;Charlotte&#39;</span><span class="p">,</span><span class="s1">&#39;Tampa Bay&#39;</span><span class="p">,</span><span class="s1">&#39;New Orleans&#39;</span><span class="p">,</span><span class="s1">&#39;San Francisco&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;Phoenix&#39;</span><span class="p">,</span> <span class="s1">&#39;Seattle&#39;</span><span class="p">,</span><span class="s1">&#39;Chicago&#39;</span><span class="p">,</span><span class="s1">&#39;Green Bay&#39;</span><span class="p">,</span><span class="s1">&#39;Minneapolis&#39;</span><span class="p">,</span><span class="s1">&#39;Detroit&#39;</span><span class="p">],</span>
           <span class="s1">&#39;footballteam&#39;</span><span class="p">:[</span><span class="s1">&#39;Buffalo Bills&#39;</span><span class="p">,</span><span class="s1">&#39;Miami Dolphins&#39;</span><span class="p">,</span><span class="s1">&#39;New England Patriots&#39;</span><span class="p">,</span>
                           <span class="p">[</span><span class="s1">&#39;New York Jets&#39;</span><span class="p">,</span> <span class="s1">&#39;New York Giants&#39;</span><span class="p">],</span><span class="s1">&#39;Cleveland Browns&#39;</span><span class="p">,</span><span class="s1">&#39;Cincinnati Bengals&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;Pittsburgh Steelers&#39;</span><span class="p">,</span><span class="s1">&#39;Baltimore Ravens&#39;</span><span class="p">,</span><span class="s1">&#39;Kansas City Chiefs&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;Las Vegas Raiders&#39;</span><span class="p">,[</span><span class="s1">&#39;L.A. Chargers&#39;</span><span class="p">,</span><span class="s1">&#39;L.A. Rams&#39;</span><span class="p">],</span><span class="s1">&#39;Denver Broncos&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;Tennessee Titans&#39;</span><span class="p">,</span><span class="s1">&#39;Jacksonville Jaguars&#39;</span><span class="p">,</span><span class="s1">&#39;Houston Texans&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;Indianapolis Colts&#39;</span><span class="p">,</span><span class="s1">&#39;Philadelphia Eagles&#39;</span><span class="p">,</span><span class="s1">&#39;Dallas Cowboys&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;Washington Skins&#39;</span><span class="p">,</span><span class="s1">&#39;Atlanta Falcons&#39;</span><span class="p">,</span><span class="s1">&#39;Carolina Panthers&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;Tampa Bay Buccaneers&#39;</span><span class="p">,</span><span class="s1">&#39;New Orleans Saints&#39;</span><span class="p">,</span> <span class="s1">&#39;San Francisco 49ers&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;Arizona Cardinals&#39;</span><span class="p">,</span><span class="s1">&#39;Seattle Seahawks&#39;</span><span class="p">,</span><span class="s1">&#39;Chicago Bears&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;Green Bay Packers&#39;</span><span class="p">,</span><span class="s1">&#39;Minnesota Vikings&#39;</span><span class="p">,</span><span class="s1">&#39;Detroit Lions&#39;</span><span class="p">]}</span>
<span class="n">nfl_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">nfl_dict</span><span class="p">)</span>
<span class="n">nfl_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>city</th>
      <th>footballteam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Buffalo</td>
      <td>Buffalo Bills</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Miami</td>
      <td>Miami Dolphins</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Boston</td>
      <td>New England Patriots</td>
    </tr>
    <tr>
      <th>3</th>
      <td>New York</td>
      <td>[New York Jets, New York Giants]</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Cleveland</td>
      <td>Cleveland Browns</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Cincinnati</td>
      <td>Cincinnati Bengals</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Pittsburgh</td>
      <td>Pittsburgh Steelers</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Baltimore</td>
      <td>Baltimore Ravens</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Kansas City</td>
      <td>Kansas City Chiefs</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Las Vegas</td>
      <td>Las Vegas Raiders</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Los Angeles</td>
      <td>[L.A. Chargers, L.A. Rams]</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Denver</td>
      <td>Denver Broncos</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Nashville</td>
      <td>Tennessee Titans</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Jacksonville</td>
      <td>Jacksonville Jaguars</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Houston</td>
      <td>Houston Texans</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Indianapolis</td>
      <td>Indianapolis Colts</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Philadelphia</td>
      <td>Philadelphia Eagles</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Dallas</td>
      <td>Dallas Cowboys</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Washington</td>
      <td>Washington Skins</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Atlanta</td>
      <td>Atlanta Falcons</td>
    </tr>
    <tr>
      <th>20</th>
      <td>Charlotte</td>
      <td>Carolina Panthers</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Tampa Bay</td>
      <td>Tampa Bay Buccaneers</td>
    </tr>
    <tr>
      <th>22</th>
      <td>New Orleans</td>
      <td>New Orleans Saints</td>
    </tr>
    <tr>
      <th>23</th>
      <td>San Francisco</td>
      <td>San Francisco 49ers</td>
    </tr>
    <tr>
      <th>24</th>
      <td>Phoenix</td>
      <td>Arizona Cardinals</td>
    </tr>
    <tr>
      <th>25</th>
      <td>Seattle</td>
      <td>Seattle Seahawks</td>
    </tr>
    <tr>
      <th>26</th>
      <td>Chicago</td>
      <td>Chicago Bears</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Green Bay</td>
      <td>Green Bay Packers</td>
    </tr>
    <tr>
      <th>28</th>
      <td>Minneapolis</td>
      <td>Minnesota Vikings</td>
    </tr>
    <tr>
      <th>29</th>
      <td>Detroit</td>
      <td>Detroit Lions</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>This table is not in first normal form because the data are non-atomic (two teams from New York and two in Los Angeles), but this form is useful for illustrating what different SQL joins do. The second table contains the same information about NBA teams:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nba_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;city&#39;</span><span class="p">:[</span><span class="s1">&#39;Boston&#39;</span><span class="p">,</span><span class="s1">&#39;New York&#39;</span><span class="p">,</span><span class="s1">&#39;Philadelphia&#39;</span><span class="p">,</span><span class="s1">&#39;Brooklyn&#39;</span><span class="p">,</span><span class="s1">&#39;Toronto&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;Cleveland&#39;</span><span class="p">,</span><span class="s1">&#39;Chicago&#39;</span><span class="p">,</span><span class="s1">&#39;Detroit&#39;</span><span class="p">,</span><span class="s1">&#39;Milwaukee&#39;</span><span class="p">,</span><span class="s1">&#39;Indianapolis&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;Atlanta&#39;</span><span class="p">,</span> <span class="s1">&#39;Washington&#39;</span><span class="p">,</span><span class="s1">&#39;Orlando&#39;</span><span class="p">,</span><span class="s1">&#39;Miami&#39;</span><span class="p">,</span><span class="s1">&#39;Charlotte&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;Los Angeles&#39;</span><span class="p">,</span><span class="s1">&#39;San Francisco&#39;</span><span class="p">,</span><span class="s1">&#39;Portland&#39;</span><span class="p">,</span><span class="s1">&#39;Sacramento&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;Phoenix&#39;</span><span class="p">,</span><span class="s1">&#39;San Antonio&#39;</span><span class="p">,</span><span class="s1">&#39;Dallas&#39;</span><span class="p">,</span><span class="s1">&#39;Houston&#39;</span><span class="p">,</span><span class="s1">&#39;Oklahoma City&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;Minneapolis&#39;</span><span class="p">,</span><span class="s1">&#39;Denver&#39;</span><span class="p">,</span><span class="s1">&#39;Salt Lake City&#39;</span><span class="p">,</span><span class="s1">&#39;Memphis&#39;</span><span class="p">,</span><span class="s1">&#39;New Orleans&#39;</span><span class="p">],</span>
           <span class="s1">&#39;basketballteam&#39;</span><span class="p">:[</span><span class="s1">&#39;Boston Celtics&#39;</span><span class="p">,</span><span class="s1">&#39;New York Knicks&#39;</span><span class="p">,</span><span class="s1">&#39;Philadelphia 76ers&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Brooklyn Nets&#39;</span><span class="p">,</span><span class="s1">&#39;Toronto Raptors&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Cleveland Cavaliers&#39;</span><span class="p">,</span><span class="s1">&#39;Chicago Bulls&#39;</span><span class="p">,</span><span class="s1">&#39;Detroit Pistons&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Milwaukee Bucks&#39;</span><span class="p">,</span><span class="s1">&#39;Indiana Pacers&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Atlanta Hawks&#39;</span><span class="p">,</span><span class="s1">&#39;Washington Wizards&#39;</span><span class="p">,</span><span class="s1">&#39;Orlando Magic&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Miami Heat&#39;</span><span class="p">,</span><span class="s1">&#39;Charlotte Hornets&#39;</span><span class="p">,</span>
                            <span class="p">[</span><span class="s1">&#39;L.A. Lakers&#39;</span><span class="p">,</span><span class="s1">&#39;L.A. Clippers&#39;</span><span class="p">],</span><span class="s1">&#39;Golden State Warriors&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Portland Trailblazers&#39;</span><span class="p">,</span><span class="s1">&#39;Sacramento Kings&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Phoenix Suns&#39;</span><span class="p">,</span><span class="s1">&#39;San Antonio Spurs&#39;</span><span class="p">,</span><span class="s1">&#39;Dallas Mavericks&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Houston Rockets&#39;</span><span class="p">,</span><span class="s1">&#39;Oklahoma City Thunder&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Minnesota Timberwolves&#39;</span><span class="p">,</span><span class="s1">&#39;Denver Nuggets&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Utah Jazz&#39;</span><span class="p">,</span><span class="s1">&#39;Memphis Grizzlies&#39;</span><span class="p">,</span><span class="s1">&#39;New Orleans Pelicans&#39;</span><span class="p">]}</span>
<span class="n">nba_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">nba_dict</span><span class="p">)</span>
<span class="n">nba_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>city</th>
      <th>basketballteam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Boston</td>
      <td>Boston Celtics</td>
    </tr>
    <tr>
      <th>1</th>
      <td>New York</td>
      <td>New York Knicks</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Philadelphia</td>
      <td>Philadelphia 76ers</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Brooklyn</td>
      <td>Brooklyn Nets</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Toronto</td>
      <td>Toronto Raptors</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Cleveland</td>
      <td>Cleveland Cavaliers</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Chicago</td>
      <td>Chicago Bulls</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Detroit</td>
      <td>Detroit Pistons</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Milwaukee</td>
      <td>Milwaukee Bucks</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Indianapolis</td>
      <td>Indiana Pacers</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Atlanta</td>
      <td>Atlanta Hawks</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Washington</td>
      <td>Washington Wizards</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Orlando</td>
      <td>Orlando Magic</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Miami</td>
      <td>Miami Heat</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Charlotte</td>
      <td>Charlotte Hornets</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Los Angeles</td>
      <td>[L.A. Lakers, L.A. Clippers]</td>
    </tr>
    <tr>
      <th>16</th>
      <td>San Francisco</td>
      <td>Golden State Warriors</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Portland</td>
      <td>Portland Trailblazers</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Sacramento</td>
      <td>Sacramento Kings</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Phoenix</td>
      <td>Phoenix Suns</td>
    </tr>
    <tr>
      <th>20</th>
      <td>San Antonio</td>
      <td>San Antonio Spurs</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Dallas</td>
      <td>Dallas Mavericks</td>
    </tr>
    <tr>
      <th>22</th>
      <td>Houston</td>
      <td>Houston Rockets</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Oklahoma City</td>
      <td>Oklahoma City Thunder</td>
    </tr>
    <tr>
      <th>24</th>
      <td>Minneapolis</td>
      <td>Minnesota Timberwolves</td>
    </tr>
    <tr>
      <th>25</th>
      <td>Denver</td>
      <td>Denver Nuggets</td>
    </tr>
    <tr>
      <th>26</th>
      <td>Salt Lake City</td>
      <td>Utah Jazz</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Memphis</td>
      <td>Memphis Grizzlies</td>
    </tr>
    <tr>
      <th>28</th>
      <td>New Orleans</td>
      <td>New Orleans Pelicans</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>To create a PostgreSQL database with entities for the NFL and NBA teams, I first connect to the PostgreSQL server running on my local computer (see module 6 for a more detailed discussion of how this works). First I bring my PostgreSQL password into the local environment:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dotenv</span><span class="o">.</span><span class="n">load_dotenv</span><span class="p">()</span>
<span class="n">pgpassword</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;pgpassword&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then I access the server and establish a cursor for the server:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dbserver</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
    <span class="n">user</span><span class="o">=</span><span class="s1">&#39;jk8sd&#39;</span><span class="p">,</span> 
    <span class="n">password</span><span class="o">=</span><span class="n">pgpassword</span><span class="p">,</span> 
    <span class="n">host</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span>
<span class="p">)</span>
<span class="n">dbserver</span><span class="o">.</span><span class="n">autocommit</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">dbserver</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>I create an empty “teams” database:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE DATABASE teams&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP DATABASE teams&quot;</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE DATABASE teams&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And I use the <code class="docutils literal notranslate"><span class="pre">create_engine()</span></code> function from <code class="docutils literal notranslate"><span class="pre">sqalchemy</span></code> to allow queries to the “teams” database:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql+psycopg2://</span><span class="si">{user}</span><span class="s2">:</span><span class="si">{pw}</span><span class="s2">@localhost/</span><span class="si">{db}</span><span class="s2">&quot;</span>
                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s2">&quot;jk8sd&quot;</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="n">pgpassword</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s2">&quot;teams&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>I add the <code class="docutils literal notranslate"><span class="pre">nfl_df</span></code> and <code class="docutils literal notranslate"><span class="pre">nba_df</span></code> dataframes to the “teams” database:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nfl_df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;nfl&#39;</span><span class="p">,</span> <span class="n">con</span> <span class="o">=</span> <span class="n">engine</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">if_exists</span> <span class="o">=</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span>
<span class="n">nba_df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;nba&#39;</span><span class="p">,</span> <span class="n">con</span> <span class="o">=</span> <span class="n">engine</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">if_exists</span> <span class="o">=</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>I can now issue queries to the database. To read all of the data in the NFL table, for example, I type:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM nfl&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>city</th>
      <th>footballteam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Buffalo</td>
      <td>Buffalo Bills</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Miami</td>
      <td>Miami Dolphins</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Boston</td>
      <td>New England Patriots</td>
    </tr>
    <tr>
      <th>3</th>
      <td>New York</td>
      <td>{"New York Jets","New York Giants"}</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Cleveland</td>
      <td>Cleveland Browns</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Cincinnati</td>
      <td>Cincinnati Bengals</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Pittsburgh</td>
      <td>Pittsburgh Steelers</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Baltimore</td>
      <td>Baltimore Ravens</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Kansas City</td>
      <td>Kansas City Chiefs</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Las Vegas</td>
      <td>Las Vegas Raiders</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Los Angeles</td>
      <td>{"L.A. Chargers","L.A. Rams"}</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Denver</td>
      <td>Denver Broncos</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Nashville</td>
      <td>Tennessee Titans</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Jacksonville</td>
      <td>Jacksonville Jaguars</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Houston</td>
      <td>Houston Texans</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Indianapolis</td>
      <td>Indianapolis Colts</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Philadelphia</td>
      <td>Philadelphia Eagles</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Dallas</td>
      <td>Dallas Cowboys</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Washington</td>
      <td>Washington Skins</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Atlanta</td>
      <td>Atlanta Falcons</td>
    </tr>
    <tr>
      <th>20</th>
      <td>Charlotte</td>
      <td>Carolina Panthers</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Tampa Bay</td>
      <td>Tampa Bay Buccaneers</td>
    </tr>
    <tr>
      <th>22</th>
      <td>New Orleans</td>
      <td>New Orleans Saints</td>
    </tr>
    <tr>
      <th>23</th>
      <td>San Francisco</td>
      <td>San Francisco 49ers</td>
    </tr>
    <tr>
      <th>24</th>
      <td>Phoenix</td>
      <td>Arizona Cardinals</td>
    </tr>
    <tr>
      <th>25</th>
      <td>Seattle</td>
      <td>Seattle Seahawks</td>
    </tr>
    <tr>
      <th>26</th>
      <td>Chicago</td>
      <td>Chicago Bears</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Green Bay</td>
      <td>Green Bay Packers</td>
    </tr>
    <tr>
      <th>28</th>
      <td>Minneapolis</td>
      <td>Minnesota Vikings</td>
    </tr>
    <tr>
      <th>29</th>
      <td>Detroit</td>
      <td>Detroit Lions</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="types-of-joins">
<h3><a class="toc-backref" href="#id9" role="doc-backlink"><span class="section-number">7.4.2. </span>Types of Joins</a><a class="headerlink" href="#types-of-joins" title="Permalink to this heading">#</a></h3>
<p>Joining data tables is the act of <em>adding columns</em> to an existing data table - that is, adding more features to existing records - by matching the rows in one table to the corresponding rows in another table. In a relational database, data tables can include a foreign key which serves as the primary key for another data table. Joins require matching a foreign key in one table to the corresponding primary key in another table. During the join, this foreign key and this primary key are both called <strong>indices</strong>. To perform a join with an SQL query, we specify the two tables in the database we want to join and the index in each table we will match on.</p>
<p>In the teams database, <code class="docutils literal notranslate"><span class="pre">city</span></code> is a primary key in both the “nfl” and “nba” tables, which also makes it a foreign key in both tables. Joining the “nfl” and “nba” tables by matching on <code class="docutils literal notranslate"><span class="pre">city</span></code> creates one data table in which the rows still represent cities and the columns list both the NBA and NFL teams in each city.</p>
<p>Not every city has both an NFL and an NBA team. Green Bay, for example, has a football team but no basketball team, and Sacramento has a basketball team but no football team. In a join, every row in a table either <strong>matches</strong> with one or more rows in the other table, or is <strong>unmatched</strong>. In this case, Cleveland in the NFL table is matched to a row in the NBA table because Cleveland has both a football and basketball team, but Oklahoma City in the NBA table is unmatched because there is no row for Oklahoma City in the NFL table.</p>
<p>The main difference between types of joins in SQL is their treatment of unmatched records. The following table summarizes the types of joins:</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Type of join</p></th>
<th class="head"><p>Definition</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Inner join</p></td>
<td><p>Only keep the records that exist in both tables</p></td>
</tr>
<tr class="row-odd"><td><p>Left join</p></td>
<td><p>Keep all the records in the first table listed, and keep only the records in the second table listed that have matches in the first table</p></td>
</tr>
<tr class="row-even"><td><p>Right join</p></td>
<td><p>Keep all the records in the second table listed, and keep only the  records in the first table listed that have matches in the second table</p></td>
</tr>
<tr class="row-odd"><td><p>Full join</p></td>
<td><p>Keep all of the records in both tables whether they are matched or not</p></td>
</tr>
<tr class="row-even"><td><p>Anti join</p></td>
<td><p>Keep only the records in the first table that are not matched in the second table</p></td>
</tr>
<tr class="row-odd"><td><p>Natural join</p></td>
<td><p>The same as any of the joins listed above, but no need to specify the indices as these are determined automatically by finding columns with the same name. If no columns share the same name, a natural join performs a cross join. If more than one pair of columns share names across the two data tables, natural joins assume that both are part of the index to match on. Use caution.</p></td>
</tr>
<tr class="row-even"><td><p>Cross join</p></td>
<td><p>Also called a <strong>Cartesian product</strong>. If the first dataframe has <span class="math notranslate nohighlight">\(M\)</span> rows and the second dataframe has <span class="math notranslate nohighlight">\(N\)</span> rows, the result has <span class="math notranslate nohighlight">\(M\times N\)</span> rows. Every row is a pairwise combination of values of each index.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="inner-joins">
<h3><a class="toc-backref" href="#id10" role="doc-backlink"><span class="section-number">7.4.3. </span>Inner Joins</a><a class="headerlink" href="#inner-joins" title="Permalink to this heading">#</a></h3>
<p>The syntax for an inner join is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">table1</span>
<span class="n">INNER</span> <span class="n">JOIN</span> <span class="n">table2</span>
    <span class="n">ON</span> <span class="n">table1</span><span class="o">.</span><span class="n">index_name</span> <span class="o">=</span> <span class="n">table2</span><span class="o">.</span><span class="n">index_name</span><span class="p">;</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">table1</span></code> and <code class="docutils literal notranslate"><span class="pre">table2</span></code> are the data tables we are joining, and <code class="docutils literal notranslate"><span class="pre">table1.index_name</span></code> and <code class="docutils literal notranslate"><span class="pre">table2.index_name</span></code> are the columns that contain the indices for tables 1 and 2. Alternatively, inner join is the default type of join, so that this syntax</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">table1</span>
<span class="n">JOIN</span> <span class="n">table2</span>
    <span class="n">ON</span> <span class="n">table1</span><span class="o">.</span><span class="n">index_name</span> <span class="o">=</span> <span class="n">table2</span><span class="o">.</span><span class="n">index_name</span><span class="p">;</span>
</pre></div>
</div>
<p>also produces an inner join. I recommend typing <code class="docutils literal notranslate"><span class="pre">INNER</span> <span class="pre">JOIN</span></code>, however, to avoid confusing this type of join with other types.</p>
<p>In the case of the teams database, an inner join of the NFL and NBA tables yields a dataframe with one row for every city that has both a basketball and a football team. The SQL query that generates this data frame is:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT * FROM nfl</span>
<span class="s2">INNER JOIN nba</span>
<span class="s2">    ON nfl.city = nba.city;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>city</th>
      <th>footballteam</th>
      <th>city</th>
      <th>basketballteam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Miami</td>
      <td>Miami Dolphins</td>
      <td>Miami</td>
      <td>Miami Heat</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Boston</td>
      <td>New England Patriots</td>
      <td>Boston</td>
      <td>Boston Celtics</td>
    </tr>
    <tr>
      <th>2</th>
      <td>New York</td>
      <td>{"New York Jets","New York Giants"}</td>
      <td>New York</td>
      <td>New York Knicks</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Cleveland</td>
      <td>Cleveland Browns</td>
      <td>Cleveland</td>
      <td>Cleveland Cavaliers</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Los Angeles</td>
      <td>{"L.A. Chargers","L.A. Rams"}</td>
      <td>Los Angeles</td>
      <td>{"L.A. Lakers","L.A. Clippers"}</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Denver</td>
      <td>Denver Broncos</td>
      <td>Denver</td>
      <td>Denver Nuggets</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Houston</td>
      <td>Houston Texans</td>
      <td>Houston</td>
      <td>Houston Rockets</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Indianapolis</td>
      <td>Indianapolis Colts</td>
      <td>Indianapolis</td>
      <td>Indiana Pacers</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Philadelphia</td>
      <td>Philadelphia Eagles</td>
      <td>Philadelphia</td>
      <td>Philadelphia 76ers</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Dallas</td>
      <td>Dallas Cowboys</td>
      <td>Dallas</td>
      <td>Dallas Mavericks</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Washington</td>
      <td>Washington Skins</td>
      <td>Washington</td>
      <td>Washington Wizards</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Atlanta</td>
      <td>Atlanta Falcons</td>
      <td>Atlanta</td>
      <td>Atlanta Hawks</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Charlotte</td>
      <td>Carolina Panthers</td>
      <td>Charlotte</td>
      <td>Charlotte Hornets</td>
    </tr>
    <tr>
      <th>13</th>
      <td>New Orleans</td>
      <td>New Orleans Saints</td>
      <td>New Orleans</td>
      <td>New Orleans Pelicans</td>
    </tr>
    <tr>
      <th>14</th>
      <td>San Francisco</td>
      <td>San Francisco 49ers</td>
      <td>San Francisco</td>
      <td>Golden State Warriors</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Phoenix</td>
      <td>Arizona Cardinals</td>
      <td>Phoenix</td>
      <td>Phoenix Suns</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Chicago</td>
      <td>Chicago Bears</td>
      <td>Chicago</td>
      <td>Chicago Bulls</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Minneapolis</td>
      <td>Minnesota Vikings</td>
      <td>Minneapolis</td>
      <td>Minnesota Timberwolves</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Detroit</td>
      <td>Detroit Lions</td>
      <td>Detroit</td>
      <td>Detroit Pistons</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The three quotations that come before and after the SQL code is Python syntax that allow for a string to be entered on multiple lines. With just one quote, Python would assume that the next line should be read as Python code, and will produce an error. Three quotes allows us to space out the components of the SQL query on separate lines to make the SQL code easier to read and understand.</p>
<p>SQL queries can be written on multiple lines, but the last line (and only the last line) must conclude with a semicolon.</p>
<p>Another way to write the inner join query is to use <strong>aliasing</strong>: specifying a smaller name or a single letter next to each data table in the query to simplify the syntax for <code class="docutils literal notranslate"><span class="pre">ON</span></code>. For example, I can alias the NFL data with <code class="docutils literal notranslate"><span class="pre">f</span></code> and the NBA data with <code class="docutils literal notranslate"><span class="pre">b</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT * FROM nfl f</span>
<span class="s2">INNER JOIN nba b</span>
<span class="s2">    ON f.city = b.city;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>city</th>
      <th>footballteam</th>
      <th>city</th>
      <th>basketballteam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Miami</td>
      <td>Miami Dolphins</td>
      <td>Miami</td>
      <td>Miami Heat</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Boston</td>
      <td>New England Patriots</td>
      <td>Boston</td>
      <td>Boston Celtics</td>
    </tr>
    <tr>
      <th>2</th>
      <td>New York</td>
      <td>{"New York Jets","New York Giants"}</td>
      <td>New York</td>
      <td>New York Knicks</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Cleveland</td>
      <td>Cleveland Browns</td>
      <td>Cleveland</td>
      <td>Cleveland Cavaliers</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Los Angeles</td>
      <td>{"L.A. Chargers","L.A. Rams"}</td>
      <td>Los Angeles</td>
      <td>{"L.A. Lakers","L.A. Clippers"}</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Denver</td>
      <td>Denver Broncos</td>
      <td>Denver</td>
      <td>Denver Nuggets</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Houston</td>
      <td>Houston Texans</td>
      <td>Houston</td>
      <td>Houston Rockets</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Indianapolis</td>
      <td>Indianapolis Colts</td>
      <td>Indianapolis</td>
      <td>Indiana Pacers</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Philadelphia</td>
      <td>Philadelphia Eagles</td>
      <td>Philadelphia</td>
      <td>Philadelphia 76ers</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Dallas</td>
      <td>Dallas Cowboys</td>
      <td>Dallas</td>
      <td>Dallas Mavericks</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Washington</td>
      <td>Washington Skins</td>
      <td>Washington</td>
      <td>Washington Wizards</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Atlanta</td>
      <td>Atlanta Falcons</td>
      <td>Atlanta</td>
      <td>Atlanta Hawks</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Charlotte</td>
      <td>Carolina Panthers</td>
      <td>Charlotte</td>
      <td>Charlotte Hornets</td>
    </tr>
    <tr>
      <th>13</th>
      <td>New Orleans</td>
      <td>New Orleans Saints</td>
      <td>New Orleans</td>
      <td>New Orleans Pelicans</td>
    </tr>
    <tr>
      <th>14</th>
      <td>San Francisco</td>
      <td>San Francisco 49ers</td>
      <td>San Francisco</td>
      <td>Golden State Warriors</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Phoenix</td>
      <td>Arizona Cardinals</td>
      <td>Phoenix</td>
      <td>Phoenix Suns</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Chicago</td>
      <td>Chicago Bears</td>
      <td>Chicago</td>
      <td>Chicago Bulls</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Minneapolis</td>
      <td>Minnesota Vikings</td>
      <td>Minneapolis</td>
      <td>Minnesota Timberwolves</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Detroit</td>
      <td>Detroit Lions</td>
      <td>Detroit</td>
      <td>Detroit Pistons</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The two indices we match on do not necessarily have to have the same name. Supposing that the “city” column in each data table was named “location” in the NFL table and “town” in the NBA table, the syntax for the inner join would have been:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">nfl</span> <span class="n">f</span>
<span class="n">INNER</span> <span class="n">JOIN</span> <span class="n">nba</span> <span class="n">b</span>
    <span class="n">ON</span> <span class="n">f</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">town</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="left-and-right-joins">
<h3><a class="toc-backref" href="#id11" role="doc-backlink"><span class="section-number">7.4.4. </span>Left and Right Joins</a><a class="headerlink" href="#left-and-right-joins" title="Permalink to this heading">#</a></h3>
<p>The syntax for a left join is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">table1</span>
<span class="n">LEFT</span> <span class="n">JOIN</span> <span class="n">table2</span>
    <span class="n">ON</span> <span class="n">table1</span><span class="o">.</span><span class="n">index_name</span> <span class="o">=</span> <span class="n">table2</span><span class="o">.</span><span class="n">index_name</span><span class="p">;</span>
</pre></div>
</div>
<p>and the syntax for a right join is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">table1</span>
<span class="n">RIGHT</span> <span class="n">JOIN</span> <span class="n">table2</span>
    <span class="n">ON</span> <span class="n">table1</span><span class="o">.</span><span class="n">index_name</span> <span class="o">=</span> <span class="n">table2</span><span class="o">.</span><span class="n">index_name</span><span class="p">;</span>
</pre></div>
</div>
<p>In the case of the teams database, if we list the NFL table next to <code class="docutils literal notranslate"><span class="pre">FROM</span></code> and the NBA data with the <code class="docutils literal notranslate"><span class="pre">JOIN</span></code> statement, then left join lists all of the cities with an NFL team, and also displays the NBA team in that city if one exists. Otherwise, the syntax places <code class="docutils literal notranslate"><span class="pre">None</span></code> in the cell where the NBA team would be. For the teams database, the syntax for a left join is:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT * FROM nfl f</span>
<span class="s2">LEFT JOIN nba b</span>
<span class="s2">    ON f.city = b.city;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>city</th>
      <th>footballteam</th>
      <th>city</th>
      <th>basketballteam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Buffalo</td>
      <td>Buffalo Bills</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Miami</td>
      <td>Miami Dolphins</td>
      <td>Miami</td>
      <td>Miami Heat</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Boston</td>
      <td>New England Patriots</td>
      <td>Boston</td>
      <td>Boston Celtics</td>
    </tr>
    <tr>
      <th>3</th>
      <td>New York</td>
      <td>{"New York Jets","New York Giants"}</td>
      <td>New York</td>
      <td>New York Knicks</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Cleveland</td>
      <td>Cleveland Browns</td>
      <td>Cleveland</td>
      <td>Cleveland Cavaliers</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Cincinnati</td>
      <td>Cincinnati Bengals</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Pittsburgh</td>
      <td>Pittsburgh Steelers</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Baltimore</td>
      <td>Baltimore Ravens</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Kansas City</td>
      <td>Kansas City Chiefs</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Las Vegas</td>
      <td>Las Vegas Raiders</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Los Angeles</td>
      <td>{"L.A. Chargers","L.A. Rams"}</td>
      <td>Los Angeles</td>
      <td>{"L.A. Lakers","L.A. Clippers"}</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Denver</td>
      <td>Denver Broncos</td>
      <td>Denver</td>
      <td>Denver Nuggets</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Nashville</td>
      <td>Tennessee Titans</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Jacksonville</td>
      <td>Jacksonville Jaguars</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Houston</td>
      <td>Houston Texans</td>
      <td>Houston</td>
      <td>Houston Rockets</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Indianapolis</td>
      <td>Indianapolis Colts</td>
      <td>Indianapolis</td>
      <td>Indiana Pacers</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Philadelphia</td>
      <td>Philadelphia Eagles</td>
      <td>Philadelphia</td>
      <td>Philadelphia 76ers</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Dallas</td>
      <td>Dallas Cowboys</td>
      <td>Dallas</td>
      <td>Dallas Mavericks</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Washington</td>
      <td>Washington Skins</td>
      <td>Washington</td>
      <td>Washington Wizards</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Atlanta</td>
      <td>Atlanta Falcons</td>
      <td>Atlanta</td>
      <td>Atlanta Hawks</td>
    </tr>
    <tr>
      <th>20</th>
      <td>Charlotte</td>
      <td>Carolina Panthers</td>
      <td>Charlotte</td>
      <td>Charlotte Hornets</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Tampa Bay</td>
      <td>Tampa Bay Buccaneers</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>22</th>
      <td>New Orleans</td>
      <td>New Orleans Saints</td>
      <td>New Orleans</td>
      <td>New Orleans Pelicans</td>
    </tr>
    <tr>
      <th>23</th>
      <td>San Francisco</td>
      <td>San Francisco 49ers</td>
      <td>San Francisco</td>
      <td>Golden State Warriors</td>
    </tr>
    <tr>
      <th>24</th>
      <td>Phoenix</td>
      <td>Arizona Cardinals</td>
      <td>Phoenix</td>
      <td>Phoenix Suns</td>
    </tr>
    <tr>
      <th>25</th>
      <td>Seattle</td>
      <td>Seattle Seahawks</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>26</th>
      <td>Chicago</td>
      <td>Chicago Bears</td>
      <td>Chicago</td>
      <td>Chicago Bulls</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Green Bay</td>
      <td>Green Bay Packers</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>28</th>
      <td>Minneapolis</td>
      <td>Minnesota Vikings</td>
      <td>Minneapolis</td>
      <td>Minnesota Timberwolves</td>
    </tr>
    <tr>
      <th>29</th>
      <td>Detroit</td>
      <td>Detroit Lions</td>
      <td>Detroit</td>
      <td>Detroit Pistons</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Likewise, the right join displays all the cities with an NBA team, along with the NFL team in that city, if one exists:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT * FROM nfl f</span>
<span class="s2">RIGHT JOIN nba b</span>
<span class="s2">    ON f.city = b.city;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>city</th>
      <th>footballteam</th>
      <th>city</th>
      <th>basketballteam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Boston</td>
      <td>New England Patriots</td>
      <td>Boston</td>
      <td>Boston Celtics</td>
    </tr>
    <tr>
      <th>1</th>
      <td>New York</td>
      <td>{"New York Jets","New York Giants"}</td>
      <td>New York</td>
      <td>New York Knicks</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Philadelphia</td>
      <td>Philadelphia Eagles</td>
      <td>Philadelphia</td>
      <td>Philadelphia 76ers</td>
    </tr>
    <tr>
      <th>3</th>
      <td>None</td>
      <td>None</td>
      <td>Brooklyn</td>
      <td>Brooklyn Nets</td>
    </tr>
    <tr>
      <th>4</th>
      <td>None</td>
      <td>None</td>
      <td>Toronto</td>
      <td>Toronto Raptors</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Cleveland</td>
      <td>Cleveland Browns</td>
      <td>Cleveland</td>
      <td>Cleveland Cavaliers</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Chicago</td>
      <td>Chicago Bears</td>
      <td>Chicago</td>
      <td>Chicago Bulls</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Detroit</td>
      <td>Detroit Lions</td>
      <td>Detroit</td>
      <td>Detroit Pistons</td>
    </tr>
    <tr>
      <th>8</th>
      <td>None</td>
      <td>None</td>
      <td>Milwaukee</td>
      <td>Milwaukee Bucks</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Indianapolis</td>
      <td>Indianapolis Colts</td>
      <td>Indianapolis</td>
      <td>Indiana Pacers</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Atlanta</td>
      <td>Atlanta Falcons</td>
      <td>Atlanta</td>
      <td>Atlanta Hawks</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Washington</td>
      <td>Washington Skins</td>
      <td>Washington</td>
      <td>Washington Wizards</td>
    </tr>
    <tr>
      <th>12</th>
      <td>None</td>
      <td>None</td>
      <td>Orlando</td>
      <td>Orlando Magic</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Miami</td>
      <td>Miami Dolphins</td>
      <td>Miami</td>
      <td>Miami Heat</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Charlotte</td>
      <td>Carolina Panthers</td>
      <td>Charlotte</td>
      <td>Charlotte Hornets</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Los Angeles</td>
      <td>{"L.A. Chargers","L.A. Rams"}</td>
      <td>Los Angeles</td>
      <td>{"L.A. Lakers","L.A. Clippers"}</td>
    </tr>
    <tr>
      <th>16</th>
      <td>San Francisco</td>
      <td>San Francisco 49ers</td>
      <td>San Francisco</td>
      <td>Golden State Warriors</td>
    </tr>
    <tr>
      <th>17</th>
      <td>None</td>
      <td>None</td>
      <td>Portland</td>
      <td>Portland Trailblazers</td>
    </tr>
    <tr>
      <th>18</th>
      <td>None</td>
      <td>None</td>
      <td>Sacramento</td>
      <td>Sacramento Kings</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Phoenix</td>
      <td>Arizona Cardinals</td>
      <td>Phoenix</td>
      <td>Phoenix Suns</td>
    </tr>
    <tr>
      <th>20</th>
      <td>None</td>
      <td>None</td>
      <td>San Antonio</td>
      <td>San Antonio Spurs</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Dallas</td>
      <td>Dallas Cowboys</td>
      <td>Dallas</td>
      <td>Dallas Mavericks</td>
    </tr>
    <tr>
      <th>22</th>
      <td>Houston</td>
      <td>Houston Texans</td>
      <td>Houston</td>
      <td>Houston Rockets</td>
    </tr>
    <tr>
      <th>23</th>
      <td>None</td>
      <td>None</td>
      <td>Oklahoma City</td>
      <td>Oklahoma City Thunder</td>
    </tr>
    <tr>
      <th>24</th>
      <td>Minneapolis</td>
      <td>Minnesota Vikings</td>
      <td>Minneapolis</td>
      <td>Minnesota Timberwolves</td>
    </tr>
    <tr>
      <th>25</th>
      <td>Denver</td>
      <td>Denver Broncos</td>
      <td>Denver</td>
      <td>Denver Nuggets</td>
    </tr>
    <tr>
      <th>26</th>
      <td>None</td>
      <td>None</td>
      <td>Salt Lake City</td>
      <td>Utah Jazz</td>
    </tr>
    <tr>
      <th>27</th>
      <td>None</td>
      <td>None</td>
      <td>Memphis</td>
      <td>Memphis Grizzlies</td>
    </tr>
    <tr>
      <th>28</th>
      <td>New Orleans</td>
      <td>New Orleans Saints</td>
      <td>New Orleans</td>
      <td>New Orleans Pelicans</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>For the left and right joins, changing which data table appears along with <code class="docutils literal notranslate"><span class="pre">FROM</span></code> and which data table appears along with <code class="docutils literal notranslate"><span class="pre">JOIN</span></code> accomplishes the same thing as changing a left join to a right join.</p>
</section>
<section id="full-outer-join">
<h3><a class="toc-backref" href="#id12" role="doc-backlink"><span class="section-number">7.4.5. </span>Full (Outer) Join</a><a class="headerlink" href="#full-outer-join" title="Permalink to this heading">#</a></h3>
<p>A full join, also called an outer join, keeps all of the records that exist in both tables, whether or not they are matched. Full joins will return a data frame with at least as many rows as the larger of the two data tables in the join because it contains all records that appear in either data frame. Most tutorials on SQL offer a warning about full joins that these queries can result in massive amounts of data being returned, and full joins are not implemented for MySQL databases. For systems like PostgreSQL in which full joins are allowed, the syntax for a full join is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">table1</span>
<span class="n">FULL</span> <span class="n">JOIN</span> <span class="n">table2</span>
    <span class="n">ON</span> <span class="n">table1</span><span class="o">.</span><span class="n">index_name</span> <span class="o">=</span> <span class="n">table2</span><span class="o">.</span><span class="n">index_name</span><span class="p">;</span>
</pre></div>
</div>
<p>For the teams database, a full join produces a data frame with one row for every city with an NFL team or an NBA team or both:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT * FROM nfl f</span>
<span class="s2">FULL JOIN nba b</span>
<span class="s2">    ON f.city = b.city;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>city</th>
      <th>footballteam</th>
      <th>city</th>
      <th>basketballteam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Buffalo</td>
      <td>Buffalo Bills</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Miami</td>
      <td>Miami Dolphins</td>
      <td>Miami</td>
      <td>Miami Heat</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Boston</td>
      <td>New England Patriots</td>
      <td>Boston</td>
      <td>Boston Celtics</td>
    </tr>
    <tr>
      <th>3</th>
      <td>New York</td>
      <td>{"New York Jets","New York Giants"}</td>
      <td>New York</td>
      <td>New York Knicks</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Cleveland</td>
      <td>Cleveland Browns</td>
      <td>Cleveland</td>
      <td>Cleveland Cavaliers</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Cincinnati</td>
      <td>Cincinnati Bengals</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Pittsburgh</td>
      <td>Pittsburgh Steelers</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Baltimore</td>
      <td>Baltimore Ravens</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Kansas City</td>
      <td>Kansas City Chiefs</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Las Vegas</td>
      <td>Las Vegas Raiders</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Los Angeles</td>
      <td>{"L.A. Chargers","L.A. Rams"}</td>
      <td>Los Angeles</td>
      <td>{"L.A. Lakers","L.A. Clippers"}</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Denver</td>
      <td>Denver Broncos</td>
      <td>Denver</td>
      <td>Denver Nuggets</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Nashville</td>
      <td>Tennessee Titans</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Jacksonville</td>
      <td>Jacksonville Jaguars</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Houston</td>
      <td>Houston Texans</td>
      <td>Houston</td>
      <td>Houston Rockets</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Indianapolis</td>
      <td>Indianapolis Colts</td>
      <td>Indianapolis</td>
      <td>Indiana Pacers</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Philadelphia</td>
      <td>Philadelphia Eagles</td>
      <td>Philadelphia</td>
      <td>Philadelphia 76ers</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Dallas</td>
      <td>Dallas Cowboys</td>
      <td>Dallas</td>
      <td>Dallas Mavericks</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Washington</td>
      <td>Washington Skins</td>
      <td>Washington</td>
      <td>Washington Wizards</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Atlanta</td>
      <td>Atlanta Falcons</td>
      <td>Atlanta</td>
      <td>Atlanta Hawks</td>
    </tr>
    <tr>
      <th>20</th>
      <td>Charlotte</td>
      <td>Carolina Panthers</td>
      <td>Charlotte</td>
      <td>Charlotte Hornets</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Tampa Bay</td>
      <td>Tampa Bay Buccaneers</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>22</th>
      <td>New Orleans</td>
      <td>New Orleans Saints</td>
      <td>New Orleans</td>
      <td>New Orleans Pelicans</td>
    </tr>
    <tr>
      <th>23</th>
      <td>San Francisco</td>
      <td>San Francisco 49ers</td>
      <td>San Francisco</td>
      <td>Golden State Warriors</td>
    </tr>
    <tr>
      <th>24</th>
      <td>Phoenix</td>
      <td>Arizona Cardinals</td>
      <td>Phoenix</td>
      <td>Phoenix Suns</td>
    </tr>
    <tr>
      <th>25</th>
      <td>Seattle</td>
      <td>Seattle Seahawks</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>26</th>
      <td>Chicago</td>
      <td>Chicago Bears</td>
      <td>Chicago</td>
      <td>Chicago Bulls</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Green Bay</td>
      <td>Green Bay Packers</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>28</th>
      <td>Minneapolis</td>
      <td>Minnesota Vikings</td>
      <td>Minneapolis</td>
      <td>Minnesota Timberwolves</td>
    </tr>
    <tr>
      <th>29</th>
      <td>Detroit</td>
      <td>Detroit Lions</td>
      <td>Detroit</td>
      <td>Detroit Pistons</td>
    </tr>
    <tr>
      <th>30</th>
      <td>None</td>
      <td>None</td>
      <td>Milwaukee</td>
      <td>Milwaukee Bucks</td>
    </tr>
    <tr>
      <th>31</th>
      <td>None</td>
      <td>None</td>
      <td>Oklahoma City</td>
      <td>Oklahoma City Thunder</td>
    </tr>
    <tr>
      <th>32</th>
      <td>None</td>
      <td>None</td>
      <td>Portland</td>
      <td>Portland Trailblazers</td>
    </tr>
    <tr>
      <th>33</th>
      <td>None</td>
      <td>None</td>
      <td>Brooklyn</td>
      <td>Brooklyn Nets</td>
    </tr>
    <tr>
      <th>34</th>
      <td>None</td>
      <td>None</td>
      <td>Sacramento</td>
      <td>Sacramento Kings</td>
    </tr>
    <tr>
      <th>35</th>
      <td>None</td>
      <td>None</td>
      <td>Memphis</td>
      <td>Memphis Grizzlies</td>
    </tr>
    <tr>
      <th>36</th>
      <td>None</td>
      <td>None</td>
      <td>San Antonio</td>
      <td>San Antonio Spurs</td>
    </tr>
    <tr>
      <th>37</th>
      <td>None</td>
      <td>None</td>
      <td>Salt Lake City</td>
      <td>Utah Jazz</td>
    </tr>
    <tr>
      <th>38</th>
      <td>None</td>
      <td>None</td>
      <td>Orlando</td>
      <td>Orlando Magic</td>
    </tr>
    <tr>
      <th>39</th>
      <td>None</td>
      <td>None</td>
      <td>Toronto</td>
      <td>Toronto Raptors</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Although there are 30 cities with at least one NFL team and 29 cities with at least one NBA team, there are 41 cities with at least one team from one of these two leagues.</p>
</section>
<section id="anti-joins">
<h3><a class="toc-backref" href="#id13" role="doc-backlink"><span class="section-number">7.4.6. </span>Anti-Joins</a><a class="headerlink" href="#anti-joins" title="Permalink to this heading">#</a></h3>
<p>An anti-join leaves us with all of the records in the first data table that do not appear in the second table. There is no “ANTI JOIN” syntax in SQL, but the behavior of an anti-join can be generated by including the <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause along with <code class="docutils literal notranslate"><span class="pre">LEFT</span> <span class="pre">JOIN</span></code>. The syntax for an anti-join is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">table1</span>
<span class="n">LEFT</span> <span class="n">JOIN</span> <span class="n">table2</span>
    <span class="n">ON</span> <span class="n">table1</span><span class="o">.</span><span class="n">index_name</span> <span class="o">=</span> <span class="n">table2</span><span class="o">.</span><span class="n">index_name</span>
<span class="n">WHERE</span> <span class="n">table2</span><span class="o">.</span><span class="n">index_name</span> <span class="ow">is</span> <span class="n">NULL</span><span class="p">;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> statement is used to draw a selection of rows from a data table that make a specified logical condition true. After performing a left join we have a data table with all of the rows in the first table along with the data for those rows in the second table if the row had a match in the second table. Typing <code class="docutils literal notranslate"><span class="pre">WHERE</span> <span class="pre">table2.index_name</span> <span class="pre">is</span> <span class="pre">NULL</span></code> restricts this data table to only the rows that do not have a value of the index in the second table, meaning there was no match. For the teams database, the anti-join of the NFL and NBA tables yields a dataframe of all the cities with an NFL team but no NBA team:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT * FROM nfl f</span>
<span class="s2">LEFT JOIN nba b</span>
<span class="s2">    ON f.city = b.city</span>
<span class="s2">WHERE b.city is NULL;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>city</th>
      <th>footballteam</th>
      <th>city</th>
      <th>basketballteam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Buffalo</td>
      <td>Buffalo Bills</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Cincinnati</td>
      <td>Cincinnati Bengals</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Pittsburgh</td>
      <td>Pittsburgh Steelers</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Baltimore</td>
      <td>Baltimore Ravens</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Kansas City</td>
      <td>Kansas City Chiefs</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Las Vegas</td>
      <td>Las Vegas Raiders</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Nashville</td>
      <td>Tennessee Titans</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Jacksonville</td>
      <td>Jacksonville Jaguars</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Tampa Bay</td>
      <td>Tampa Bay Buccaneers</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Seattle</td>
      <td>Seattle Seahawks</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Green Bay</td>
      <td>Green Bay Packers</td>
      <td>None</td>
      <td>None</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="natural-joins">
<h3><a class="toc-backref" href="#id14" role="doc-backlink"><span class="section-number">7.4.7. </span>Natural Joins</a><a class="headerlink" href="#natural-joins" title="Permalink to this heading">#</a></h3>
<p>One annoying thing about all of the joins shown above is that we end up with two columns that contain the same information. In the case of the team database, we have two <code class="docutils literal notranslate"><span class="pre">city</span></code> columns that are always either equal, or else one is missing. But when one of the <code class="docutils literal notranslate"><span class="pre">city</span></code> columns says “None”, the team from that table also says “None”, so the missingness in the <code class="docutils literal notranslate"><span class="pre">city</span></code> column does not provide additional information.</p>
<p>It might make sense to use a different kind of join that understands that the two <code class="docutils literal notranslate"><span class="pre">city</span></code> columns contain the same information and includes only one of these columns. A natural join does two things differently from the other joins described here:</p>
<ol class="arabic simple">
<li><p>A natural join removes duplicated columns from the output data.</p></li>
<li><p>A natural join detects the indices automatically by assuming columns that share the same name are part indices.</p></li>
</ol>
<p>If done correctly, a natural join saves some work constructing the query as the indices are detected automatically, and provides cleaner output. Any of the joins described above can be done as a natural join by adding <code class="docutils literal notranslate"><span class="pre">NATURAL</span></code> in front of <code class="docutils literal notranslate"><span class="pre">INNER</span></code>, <code class="docutils literal notranslate"><span class="pre">LEFT</span></code>, <code class="docutils literal notranslate"><span class="pre">RIGHT</span></code>, or <code class="docutils literal notranslate"><span class="pre">FULL</span></code>. If there are no columns that share the same name, a natural join instead performs a cross join (described below).</p>
<p>The following query performs a natural inner join:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT * from nfl</span>
<span class="s2">NATURAL INNER JOIN nba</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>city</th>
      <th>footballteam</th>
      <th>basketballteam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Miami</td>
      <td>Miami Dolphins</td>
      <td>Miami Heat</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Boston</td>
      <td>New England Patriots</td>
      <td>Boston Celtics</td>
    </tr>
    <tr>
      <th>2</th>
      <td>New York</td>
      <td>{"New York Jets","New York Giants"}</td>
      <td>New York Knicks</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Cleveland</td>
      <td>Cleveland Browns</td>
      <td>Cleveland Cavaliers</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Los Angeles</td>
      <td>{"L.A. Chargers","L.A. Rams"}</td>
      <td>{"L.A. Lakers","L.A. Clippers"}</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Denver</td>
      <td>Denver Broncos</td>
      <td>Denver Nuggets</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Houston</td>
      <td>Houston Texans</td>
      <td>Houston Rockets</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Indianapolis</td>
      <td>Indianapolis Colts</td>
      <td>Indiana Pacers</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Philadelphia</td>
      <td>Philadelphia Eagles</td>
      <td>Philadelphia 76ers</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Dallas</td>
      <td>Dallas Cowboys</td>
      <td>Dallas Mavericks</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Washington</td>
      <td>Washington Skins</td>
      <td>Washington Wizards</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Atlanta</td>
      <td>Atlanta Falcons</td>
      <td>Atlanta Hawks</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Charlotte</td>
      <td>Carolina Panthers</td>
      <td>Charlotte Hornets</td>
    </tr>
    <tr>
      <th>13</th>
      <td>New Orleans</td>
      <td>New Orleans Saints</td>
      <td>New Orleans Pelicans</td>
    </tr>
    <tr>
      <th>14</th>
      <td>San Francisco</td>
      <td>San Francisco 49ers</td>
      <td>Golden State Warriors</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Phoenix</td>
      <td>Arizona Cardinals</td>
      <td>Phoenix Suns</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Chicago</td>
      <td>Chicago Bears</td>
      <td>Chicago Bulls</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Minneapolis</td>
      <td>Minnesota Vikings</td>
      <td>Minnesota Timberwolves</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Detroit</td>
      <td>Detroit Lions</td>
      <td>Detroit Pistons</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Natural joins are controversial, however, and many data scientists choose not to use them at all. The danger is that if two columns unexpectedly have the same name (it can be hard to keep track of all of the features’ names in big databases) then a natural join will match on the wrong indices. This <a class="reference external" href="https://stackoverflow.com/questions/8696383/difference-between-natural-join-and-inner-join#8696402">Stack Overflow post</a> gets into this debate, and one response made a forceful argument against natural joins:</p>
<blockquote>
<div><p>Collapsing columns in the output is the least-important aspect of a natural join. The things you need to know are (A) it automatically joins on fields of the same name and (B) it will f— up your s— when you least expect it. In my world, using a natural join is grounds for dismissal… . Say you have a natural join between <code class="docutils literal notranslate"><span class="pre">Customers</span></code> and <code class="docutils literal notranslate"><span class="pre">Employees</span></code>, joining on <code class="docutils literal notranslate"><span class="pre">EmployeeID</span></code>. Employees also has a <code class="docutils literal notranslate"><span class="pre">ManagerID</span></code> field. Everything’s fine. Then, some day, someone adds a <code class="docutils literal notranslate"><span class="pre">ManagerID</span></code> field to the <code class="docutils literal notranslate"><span class="pre">Customers</span></code> table. Your join will not break (that would be a mercy), instead it will now include a second field, and work incorrectly. Thus, a seemingly harmless change can break something only distantly related. VERY BAD. The only upside of a natural join is saving a little typing, and the downside is substantial.</p>
</div></blockquote>
<p>Personally, I disagree with this statement as I think natural joins can be elegant and convenient, especially when I want to match on multiple indices. But I agree that natural joins do make it easier to mess up a join, and more caution is needed. To demonstrate how a natural join can go wrong, suppose that in both the NFL and NBA tables the columns were named <code class="docutils literal notranslate"><span class="pre">city</span></code> and <code class="docutils literal notranslate"><span class="pre">team</span></code>. The following code creates versions of these tables with <code class="docutils literal notranslate"><span class="pre">footballteam</span></code> and <code class="docutils literal notranslate"><span class="pre">basketballteam</span></code> each renamed to <code class="docutils literal notranslate"><span class="pre">team</span></code> and stores these tables in the database as “nfl2” and “nba2”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nfl2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="s2">&quot;SELECT city, footballteam as team FROM nfl;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<span class="n">nba2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="s2">&quot;SELECT city, basketballteam as team FROM nba;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<span class="n">nfl2</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;nfl2&#39;</span><span class="p">,</span> <span class="n">con</span> <span class="o">=</span> <span class="n">engine</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">if_exists</span> <span class="o">=</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span>
<span class="n">nba2</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;nba2&#39;</span><span class="p">,</span> <span class="n">con</span> <span class="o">=</span> <span class="n">engine</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">if_exists</span> <span class="o">=</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now a natural inner join between “nfl2” and “nba2” yields a dataframe with no records:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT * FROM nfl2 </span>
<span class="s2">NATURAL INNER JOIN nba2;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>city</th>
      <th>team</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div></div></div>
</div>
<p>The reason why there are no records is that the natural join automatically chooses both <code class="docutils literal notranslate"><span class="pre">city</span></code> and <code class="docutils literal notranslate"><span class="pre">team</span></code> to be part of the index, and records are only kept in the inner join if they match on both city and team. There are many matches for city, but no matches for both city and team.</p>
<p>In contrast, a regular inner join still works fine:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT * FROM nfl2 f</span>
<span class="s2">INNER JOIN nba2 b</span>
<span class="s2">    ON f.city = b.city;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>city</th>
      <th>team</th>
      <th>city</th>
      <th>team</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Miami</td>
      <td>Miami Dolphins</td>
      <td>Miami</td>
      <td>Miami Heat</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Boston</td>
      <td>New England Patriots</td>
      <td>Boston</td>
      <td>Boston Celtics</td>
    </tr>
    <tr>
      <th>2</th>
      <td>New York</td>
      <td>{"New York Jets","New York Giants"}</td>
      <td>New York</td>
      <td>New York Knicks</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Cleveland</td>
      <td>Cleveland Browns</td>
      <td>Cleveland</td>
      <td>Cleveland Cavaliers</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Los Angeles</td>
      <td>{"L.A. Chargers","L.A. Rams"}</td>
      <td>Los Angeles</td>
      <td>{"L.A. Lakers","L.A. Clippers"}</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Denver</td>
      <td>Denver Broncos</td>
      <td>Denver</td>
      <td>Denver Nuggets</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Houston</td>
      <td>Houston Texans</td>
      <td>Houston</td>
      <td>Houston Rockets</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Indianapolis</td>
      <td>Indianapolis Colts</td>
      <td>Indianapolis</td>
      <td>Indiana Pacers</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Philadelphia</td>
      <td>Philadelphia Eagles</td>
      <td>Philadelphia</td>
      <td>Philadelphia 76ers</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Dallas</td>
      <td>Dallas Cowboys</td>
      <td>Dallas</td>
      <td>Dallas Mavericks</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Washington</td>
      <td>Washington Skins</td>
      <td>Washington</td>
      <td>Washington Wizards</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Atlanta</td>
      <td>Atlanta Falcons</td>
      <td>Atlanta</td>
      <td>Atlanta Hawks</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Charlotte</td>
      <td>Carolina Panthers</td>
      <td>Charlotte</td>
      <td>Charlotte Hornets</td>
    </tr>
    <tr>
      <th>13</th>
      <td>New Orleans</td>
      <td>New Orleans Saints</td>
      <td>New Orleans</td>
      <td>New Orleans Pelicans</td>
    </tr>
    <tr>
      <th>14</th>
      <td>San Francisco</td>
      <td>San Francisco 49ers</td>
      <td>San Francisco</td>
      <td>Golden State Warriors</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Phoenix</td>
      <td>Arizona Cardinals</td>
      <td>Phoenix</td>
      <td>Phoenix Suns</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Chicago</td>
      <td>Chicago Bears</td>
      <td>Chicago</td>
      <td>Chicago Bulls</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Minneapolis</td>
      <td>Minnesota Vikings</td>
      <td>Minneapolis</td>
      <td>Minnesota Timberwolves</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Detroit</td>
      <td>Detroit Lions</td>
      <td>Detroit</td>
      <td>Detroit Pistons</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>To safely use natural joins, first make certain that the indices you intend to match on have the same name, and then make sure that no other columns in the two data tables share a name.</p>
</section>
<section id="cross-joins">
<h3><a class="toc-backref" href="#id15" role="doc-backlink"><span class="section-number">7.4.8. </span>Cross Joins</a><a class="headerlink" href="#cross-joins" title="Permalink to this heading">#</a></h3>
<p>A <strong>round robin</strong> is a method of organizing a competitive tournament. In a round robin, every team or participant plays every other team or participant once. A cross join, also called a Cartesian product, is a round robin for matching values of the index in one data table to values of the index in the other data table. Every value of the index in the first data table is matched once to every distinct value of the index in the second data table. Cross joins are memory-intensive: if the first data table has <span class="math notranslate nohighlight">\(M\)</span> rows and the second data table has <span class="math notranslate nohighlight">\(N\)</span> rows, the cross join output is a data table with <span class="math notranslate nohighlight">\(M\times N\)</span> rows. In general cross joins are not good ways to combine data entities, and they fail to match strictly like units. But cross joins are useful for constructing data that contain all possible pairings, if that’s what a situation calls for.</p>
<p>The syntax for generating a cross join is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">table1</span>
<span class="n">CROSS</span> <span class="n">JOIN</span> <span class="n">table2</span><span class="p">;</span>
</pre></div>
</div>
<p>There is no <code class="docutils literal notranslate"><span class="pre">ON</span></code> statement in this query because it is not needed to match each row in <code class="docutils literal notranslate"><span class="pre">table1</span></code> to every row in <code class="docutils literal notranslate"><span class="pre">table2</span></code>. For the teams database, the cross join generates the following output:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT * FROM nfl</span>
<span class="s2">CROSS JOIN nba;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>city</th>
      <th>footballteam</th>
      <th>city</th>
      <th>basketballteam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Buffalo</td>
      <td>Buffalo Bills</td>
      <td>Boston</td>
      <td>Boston Celtics</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Buffalo</td>
      <td>Buffalo Bills</td>
      <td>New York</td>
      <td>New York Knicks</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Buffalo</td>
      <td>Buffalo Bills</td>
      <td>Philadelphia</td>
      <td>Philadelphia 76ers</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Buffalo</td>
      <td>Buffalo Bills</td>
      <td>Brooklyn</td>
      <td>Brooklyn Nets</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Buffalo</td>
      <td>Buffalo Bills</td>
      <td>Toronto</td>
      <td>Toronto Raptors</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>865</th>
      <td>Detroit</td>
      <td>Detroit Lions</td>
      <td>Minneapolis</td>
      <td>Minnesota Timberwolves</td>
    </tr>
    <tr>
      <th>866</th>
      <td>Detroit</td>
      <td>Detroit Lions</td>
      <td>Denver</td>
      <td>Denver Nuggets</td>
    </tr>
    <tr>
      <th>867</th>
      <td>Detroit</td>
      <td>Detroit Lions</td>
      <td>Salt Lake City</td>
      <td>Utah Jazz</td>
    </tr>
    <tr>
      <th>868</th>
      <td>Detroit</td>
      <td>Detroit Lions</td>
      <td>Memphis</td>
      <td>Memphis Grizzlies</td>
    </tr>
    <tr>
      <th>869</th>
      <td>Detroit</td>
      <td>Detroit Lions</td>
      <td>New Orleans</td>
      <td>New Orleans Pelicans</td>
    </tr>
  </tbody>
</table>
<p>870 rows × 4 columns</p>
</div></div></div>
</div>
</section>
<section id="multiple-joins-in-one-query">
<h3><a class="toc-backref" href="#id16" role="doc-backlink"><span class="section-number">7.4.9. </span>Multiple Joins in One Query</a><a class="headerlink" href="#multiple-joins-in-one-query" title="Permalink to this heading">#</a></h3>
<p>All of the examples above show a single join between two data tables, but many situations will require you to join multiple tables. it is possible to join many tables in one SQL query. The syntax to perform an inner join between two tables, then an inner join between the result and a third table is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">table1</span>
<span class="n">INNER</span> <span class="n">JOIN</span> <span class="n">table2</span>
    <span class="n">ON</span> <span class="n">table1</span><span class="o">.</span><span class="n">index_name</span> <span class="o">=</span> <span class="n">table2</span><span class="o">.</span><span class="n">index_name</span>
<span class="n">INNER</span> <span class="n">JOIN</span> <span class="n">table</span> <span class="mi">3</span>
    <span class="n">ON</span> <span class="n">table1</span><span class="o">.</span><span class="n">index_name</span> <span class="o">=</span> <span class="n">table3</span><span class="o">.</span><span class="n">index_name</span><span class="p">;</span>
</pre></div>
</div>
<p>To demonstrate how multiple joins can work, I add a third table to the teams database that contains all of the Major League Baseball teams:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mlb_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;city&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;New York&#39;</span><span class="p">,</span> <span class="s1">&#39;Boston&#39;</span><span class="p">,</span> <span class="s1">&#39;Toronto&#39;</span><span class="p">,</span> <span class="s1">&#39;Baltimore&#39;</span><span class="p">,</span> <span class="s1">&#39;Tampa Bay&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Cleveland&#39;</span><span class="p">,</span> <span class="s1">&#39;Chicago&#39;</span><span class="p">,</span> <span class="s1">&#39;Kansas City&#39;</span><span class="p">,</span> <span class="s1">&#39;Minneapolis&#39;</span><span class="p">,</span> <span class="s1">&#39;Detroit&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Houston&#39;</span><span class="p">,</span> <span class="s1">&#39;Anaheim&#39;</span><span class="p">,</span> <span class="s1">&#39;Dallas&#39;</span><span class="p">,</span> <span class="s1">&#39;Seattle&#39;</span><span class="p">,</span> <span class="s1">&#39;Oakland&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Philadelphia&#39;</span><span class="p">,</span> <span class="s1">&#39;Miami&#39;</span><span class="p">,</span> <span class="s1">&#39;Washington&#39;</span><span class="p">,</span> <span class="s1">&#39;Atlanta&#39;</span><span class="p">,</span> <span class="s1">&#39;Cincinnati&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Milwaukee&#39;</span><span class="p">,</span> <span class="s1">&#39;St. Louis&#39;</span><span class="p">,</span> <span class="s1">&#39;Pittsburgh&#39;</span><span class="p">,</span> <span class="s1">&#39;Los Angeles&#39;</span><span class="p">,</span> <span class="s1">&#39;San Francisco&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;San Diego&#39;</span><span class="p">,</span> <span class="s1">&#39;Denver&#39;</span><span class="p">,</span> <span class="s1">&#39;Phoenix&#39;</span><span class="p">],</span>
           <span class="s1">&#39;baseballteam&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;New York Mets&#39;</span><span class="p">,</span> <span class="s1">&#39;New York Yankees&#39;</span><span class="p">],</span> <span class="s1">&#39;Boston Red Sox&#39;</span><span class="p">,</span> <span class="s1">&#39;Toronto Blue Jays&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Baltimore Orioles&#39;</span><span class="p">,</span> <span class="s1">&#39;Tampa Bay Rays&#39;</span><span class="p">,</span> <span class="s1">&#39;Cleveland Indians&#39;</span><span class="p">,</span> 
                             <span class="p">[</span><span class="s1">&#39;Chicago White Sox&#39;</span><span class="p">,</span> <span class="s1">&#39;Chicago Cubs&#39;</span><span class="p">],</span> <span class="s1">&#39;Kansas City Royals&#39;</span><span class="p">,</span> <span class="s1">&#39;Minnesota Twins&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Detriot Tigers&#39;</span><span class="p">,</span> <span class="s1">&#39;Houston Astros&#39;</span><span class="p">,</span> <span class="s1">&#39;Anaheim Angels&#39;</span><span class="p">,</span> <span class="s1">&#39;Texas Rangers&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;Seattle Mariners&#39;</span><span class="p">,</span> <span class="s1">&#39;Oakland Athletics&#39;</span><span class="p">,</span> <span class="s1">&#39;Philadelphia Phillies&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Miami Marlins&#39;</span><span class="p">,</span> <span class="s1">&#39;Washington Nationals&#39;</span><span class="p">,</span> <span class="s1">&#39;Atlanta Braves&#39;</span><span class="p">,</span> <span class="s1">&#39;Cincinnati Reds&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Milwaukee Brewers&#39;</span><span class="p">,</span> <span class="s1">&#39;St. Louis Cardinals&#39;</span><span class="p">,</span> <span class="s1">&#39;Pittsburgh Pirates&#39;</span><span class="p">,</span> <span class="s1">&#39;Los Angeles Dodgers&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;San Francisco Giants&#39;</span><span class="p">,</span> <span class="s1">&#39;San Diego Padres&#39;</span><span class="p">,</span> <span class="s1">&#39;Colorado Rockies&#39;</span><span class="p">,</span> <span class="s1">&#39;Arizona Diamondbacks&#39;</span><span class="p">]}</span>
<span class="n">mlb_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mlb_dict</span><span class="p">)</span>
<span class="n">mlb_df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;mlb&#39;</span><span class="p">,</span> <span class="n">con</span> <span class="o">=</span> <span class="n">engine</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">if_exists</span> <span class="o">=</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can first inner join the NFL and NBA data tables to keep only the cities with both an NFL and an NBA team, then we can inner join the result with the MLB data to keep only the cities with teams in all three sports:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT * FROM nfl f</span>
<span class="s2">INNER JOIN nba b</span>
<span class="s2">    ON f.city = b.city</span>
<span class="s2">INNER JOIN mlb m</span>
<span class="s2">    ON f.city = m.city;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>city</th>
      <th>footballteam</th>
      <th>city</th>
      <th>basketballteam</th>
      <th>city</th>
      <th>baseballteam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Atlanta</td>
      <td>Atlanta Falcons</td>
      <td>Atlanta</td>
      <td>Atlanta Hawks</td>
      <td>Atlanta</td>
      <td>Atlanta Braves</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Boston</td>
      <td>New England Patriots</td>
      <td>Boston</td>
      <td>Boston Celtics</td>
      <td>Boston</td>
      <td>Boston Red Sox</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Chicago</td>
      <td>Chicago Bears</td>
      <td>Chicago</td>
      <td>Chicago Bulls</td>
      <td>Chicago</td>
      <td>{"Chicago White Sox","Chicago Cubs"}</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Cleveland</td>
      <td>Cleveland Browns</td>
      <td>Cleveland</td>
      <td>Cleveland Cavaliers</td>
      <td>Cleveland</td>
      <td>Cleveland Indians</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Dallas</td>
      <td>Dallas Cowboys</td>
      <td>Dallas</td>
      <td>Dallas Mavericks</td>
      <td>Dallas</td>
      <td>Texas Rangers</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Denver</td>
      <td>Denver Broncos</td>
      <td>Denver</td>
      <td>Denver Nuggets</td>
      <td>Denver</td>
      <td>Colorado Rockies</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Detroit</td>
      <td>Detroit Lions</td>
      <td>Detroit</td>
      <td>Detroit Pistons</td>
      <td>Detroit</td>
      <td>Detriot Tigers</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Houston</td>
      <td>Houston Texans</td>
      <td>Houston</td>
      <td>Houston Rockets</td>
      <td>Houston</td>
      <td>Houston Astros</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Los Angeles</td>
      <td>{"L.A. Chargers","L.A. Rams"}</td>
      <td>Los Angeles</td>
      <td>{"L.A. Lakers","L.A. Clippers"}</td>
      <td>Los Angeles</td>
      <td>Los Angeles Dodgers</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Miami</td>
      <td>Miami Dolphins</td>
      <td>Miami</td>
      <td>Miami Heat</td>
      <td>Miami</td>
      <td>Miami Marlins</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Minneapolis</td>
      <td>Minnesota Vikings</td>
      <td>Minneapolis</td>
      <td>Minnesota Timberwolves</td>
      <td>Minneapolis</td>
      <td>Minnesota Twins</td>
    </tr>
    <tr>
      <th>11</th>
      <td>New York</td>
      <td>{"New York Jets","New York Giants"}</td>
      <td>New York</td>
      <td>New York Knicks</td>
      <td>New York</td>
      <td>{"New York Mets","New York Yankees"}</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Philadelphia</td>
      <td>Philadelphia Eagles</td>
      <td>Philadelphia</td>
      <td>Philadelphia 76ers</td>
      <td>Philadelphia</td>
      <td>Philadelphia Phillies</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Phoenix</td>
      <td>Arizona Cardinals</td>
      <td>Phoenix</td>
      <td>Phoenix Suns</td>
      <td>Phoenix</td>
      <td>Arizona Diamondbacks</td>
    </tr>
    <tr>
      <th>14</th>
      <td>San Francisco</td>
      <td>San Francisco 49ers</td>
      <td>San Francisco</td>
      <td>Golden State Warriors</td>
      <td>San Francisco</td>
      <td>San Francisco Giants</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Washington</td>
      <td>Washington Skins</td>
      <td>Washington</td>
      <td>Washington Wizards</td>
      <td>Washington</td>
      <td>Washington Nationals</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Things get more complicated when we consider left, right, and full joins in a multiple table context. The trick is to think about the set of records that is required, to express that set in set theoretical notation, and to find the right combination of joins that matches that set theoretical statement.</p>
<p>For example, to obtain all cities with both an NFL and NBA team, also listing the MLB team if one exists in that city, we first inner join the NFL table to the NBA table, then we left join either the NFL’s or NBA’s city index to the MLB’s city column:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT * FROM nfl f</span>
<span class="s2">INNER JOIN nba b</span>
<span class="s2">    ON f.city = b.city</span>
<span class="s2">LEFT JOIN mlb m</span>
<span class="s2">    ON f.city = m.city;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>city</th>
      <th>footballteam</th>
      <th>city</th>
      <th>basketballteam</th>
      <th>city</th>
      <th>baseballteam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Atlanta</td>
      <td>Atlanta Falcons</td>
      <td>Atlanta</td>
      <td>Atlanta Hawks</td>
      <td>Atlanta</td>
      <td>Atlanta Braves</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Boston</td>
      <td>New England Patriots</td>
      <td>Boston</td>
      <td>Boston Celtics</td>
      <td>Boston</td>
      <td>Boston Red Sox</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Charlotte</td>
      <td>Carolina Panthers</td>
      <td>Charlotte</td>
      <td>Charlotte Hornets</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Chicago</td>
      <td>Chicago Bears</td>
      <td>Chicago</td>
      <td>Chicago Bulls</td>
      <td>Chicago</td>
      <td>{"Chicago White Sox","Chicago Cubs"}</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Cleveland</td>
      <td>Cleveland Browns</td>
      <td>Cleveland</td>
      <td>Cleveland Cavaliers</td>
      <td>Cleveland</td>
      <td>Cleveland Indians</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Dallas</td>
      <td>Dallas Cowboys</td>
      <td>Dallas</td>
      <td>Dallas Mavericks</td>
      <td>Dallas</td>
      <td>Texas Rangers</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Denver</td>
      <td>Denver Broncos</td>
      <td>Denver</td>
      <td>Denver Nuggets</td>
      <td>Denver</td>
      <td>Colorado Rockies</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Detroit</td>
      <td>Detroit Lions</td>
      <td>Detroit</td>
      <td>Detroit Pistons</td>
      <td>Detroit</td>
      <td>Detriot Tigers</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Houston</td>
      <td>Houston Texans</td>
      <td>Houston</td>
      <td>Houston Rockets</td>
      <td>Houston</td>
      <td>Houston Astros</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Indianapolis</td>
      <td>Indianapolis Colts</td>
      <td>Indianapolis</td>
      <td>Indiana Pacers</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Los Angeles</td>
      <td>{"L.A. Chargers","L.A. Rams"}</td>
      <td>Los Angeles</td>
      <td>{"L.A. Lakers","L.A. Clippers"}</td>
      <td>Los Angeles</td>
      <td>Los Angeles Dodgers</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Miami</td>
      <td>Miami Dolphins</td>
      <td>Miami</td>
      <td>Miami Heat</td>
      <td>Miami</td>
      <td>Miami Marlins</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Minneapolis</td>
      <td>Minnesota Vikings</td>
      <td>Minneapolis</td>
      <td>Minnesota Timberwolves</td>
      <td>Minneapolis</td>
      <td>Minnesota Twins</td>
    </tr>
    <tr>
      <th>13</th>
      <td>New Orleans</td>
      <td>New Orleans Saints</td>
      <td>New Orleans</td>
      <td>New Orleans Pelicans</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>14</th>
      <td>New York</td>
      <td>{"New York Jets","New York Giants"}</td>
      <td>New York</td>
      <td>New York Knicks</td>
      <td>New York</td>
      <td>{"New York Mets","New York Yankees"}</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Philadelphia</td>
      <td>Philadelphia Eagles</td>
      <td>Philadelphia</td>
      <td>Philadelphia 76ers</td>
      <td>Philadelphia</td>
      <td>Philadelphia Phillies</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Phoenix</td>
      <td>Arizona Cardinals</td>
      <td>Phoenix</td>
      <td>Phoenix Suns</td>
      <td>Phoenix</td>
      <td>Arizona Diamondbacks</td>
    </tr>
    <tr>
      <th>17</th>
      <td>San Francisco</td>
      <td>San Francisco 49ers</td>
      <td>San Francisco</td>
      <td>Golden State Warriors</td>
      <td>San Francisco</td>
      <td>San Francisco Giants</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Washington</td>
      <td>Washington Skins</td>
      <td>Washington</td>
      <td>Washington Wizards</td>
      <td>Washington</td>
      <td>Washington Nationals</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>To narrow the records to teams with a baseball team and a basketball team, but no football team, first we inner join the MLB and NBA data tables, then perform an anti-join with the NFL data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT * FROM mlb m</span>
<span class="s2">INNER JOIN nba b</span>
<span class="s2">    ON m.city=b.city</span>
<span class="s2">LEFT JOIN nfl f</span>
<span class="s2">    ON m.city = f.city</span>
<span class="s2">WHERE f.city is NULL;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>city</th>
      <th>baseballteam</th>
      <th>city</th>
      <th>basketballteam</th>
      <th>city</th>
      <th>footballteam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Toronto</td>
      <td>Toronto Blue Jays</td>
      <td>Toronto</td>
      <td>Toronto Raptors</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Milwaukee</td>
      <td>Milwaukee Brewers</td>
      <td>Milwaukee</td>
      <td>Milwaukee Bucks</td>
      <td>None</td>
      <td>None</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="joins-on-more-than-one-index">
<h3><a class="toc-backref" href="#id17" role="doc-backlink"><span class="section-number">7.4.10. </span>Joins on More Than One Index</a><a class="headerlink" href="#joins-on-more-than-one-index" title="Permalink to this heading">#</a></h3>
<p>Sometimes more than one column comprises the primary key for a table. The general syntax for joining two tables on more than one index adds the <code class="docutils literal notranslate"><span class="pre">AND</span></code> clause to the standard SQL join syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">table1</span>
<span class="n">INNER</span> <span class="n">JOIN</span> <span class="n">table2</span>
    <span class="n">ON</span> <span class="n">table1</span><span class="o">.</span><span class="n">index1</span> <span class="o">=</span> <span class="n">table2</span><span class="o">.</span><span class="n">index2</span>
        <span class="n">AND</span> <span class="n">table1</span><span class="o">.</span><span class="n">anotherindex1</span> <span class="o">=</span> <span class="n">table2</span><span class="o">.</span><span class="n">anotherindex2</span><span class="p">;</span>
</pre></div>
</div>
<p>Suppose for example that the NBA table and MLB table also contained records for minor league teams in the NBA G-League or the MLB AAA system. Some cities have both major and minor league teams in the same sport. Washington, for example, has a major league NBA team, the Wizards, and a minor league basketball team, the Capital City Go-Gos. Suppose that both the NBA and MLB tables have a column <code class="docutils literal notranslate"><span class="pre">leaguetype</span></code> that marks each team as “major” or “minor”, and that we want to match on both city and league type. The syntax to do so is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">nba</span> <span class="n">b</span>
<span class="n">INNER</span> <span class="n">JOIN</span> <span class="n">mlb</span> <span class="n">m</span>
    <span class="n">ON</span> <span class="n">b</span><span class="o">.</span><span class="n">city</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">city</span>
        <span class="n">AND</span> <span class="n">b</span><span class="o">.</span><span class="n">leaguetype</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">leaguetype</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>
<section id="sql-create-update-and-delete-operations">
<h2><a class="toc-backref" href="#id18" role="doc-backlink"><span class="section-number">7.5. </span>SQL Create, Update, and Delete Operations</a><a class="headerlink" href="#sql-create-update-and-delete-operations" title="Permalink to this heading">#</a></h2>
<p>Once a database exists and is populated with data, most changes to the data will be small and incremental. We might add a few records, edit a couple, or delete one or two. There are straightforward SQL commands for creating, updating, and deleting records. To issue these queries, however, we cannot use the <code class="docutils literal notranslate"><span class="pre">pd.read_sql_query()</span></code> function as this function is only for read operations. Instead, we can use the <code class="docutils literal notranslate"><span class="pre">.execute()</span></code> method as applied to either the cursor for the database we are working with, or the <code class="docutils literal notranslate"><span class="pre">sqlalchemy</span></code> engine. Specific examples are shown below.</p>
<section id="creating-new-records">
<h3><a class="toc-backref" href="#id19" role="doc-backlink"><span class="section-number">7.5.1. </span>Creating New Records</a><a class="headerlink" href="#creating-new-records" title="Permalink to this heading">#</a></h3>
<p>An existing database has a schema, an overarching organizational blueprint for the database, that describes the different tables in the database, and within each table what the columns are and what kinds of data can be input into the columns. Creating new data generally works within an established schema. That means we enter new datapoints into existing columns, matching the data type that must exist in those columns.</p>
<p>The SQL syntax to create new data is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">table</span> <span class="p">(</span><span class="n">column1</span><span class="p">,</span> <span class="n">column2</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="n">VALUES</span> <span class="p">(</span><span class="n">value1</span><span class="p">,</span> <span class="n">value2</span><span class="p">,</span> <span class="o">...</span><span class="p">);</span>
</pre></div>
</div>
<p>This syntax requires us to specify the key elements of the schema that identify a location in the database: the table and the columns. The values need to be listed in the same order as the columns, and character values need to be enclosed in single quotes.</p>
<p>To add a new observation to the NBA table (bring back the Sonics!) we can type:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">INSERT INTO nba (city, basketballteam)</span>
<span class="s2">    VALUES (&#39;Seattle&#39;, &#39;Seattle Supersonics&#39;);</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">myquery</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;sqlalchemy.engine.result.ResultProxy at 0x1153b5390&gt;
</pre></div>
</div>
</div>
</div>
<p>Here the <code class="docutils literal notranslate"><span class="pre">engine</span></code> variable is the <code class="docutils literal notranslate"><span class="pre">sqlaclchemy</span></code> connection we previously established for the teams database. We can use the <code class="docutils literal notranslate"><span class="pre">execute()</span></code> method to pass SQL queries to the database, just as we can with a cursor. Now, when we look at the data, we see the Seattle Supersonics included along with all the other NBA teams:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM nba&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>city</th>
      <th>basketballteam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Boston</td>
      <td>Boston Celtics</td>
    </tr>
    <tr>
      <th>1</th>
      <td>New York</td>
      <td>New York Knicks</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Philadelphia</td>
      <td>Philadelphia 76ers</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Brooklyn</td>
      <td>Brooklyn Nets</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Toronto</td>
      <td>Toronto Raptors</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Cleveland</td>
      <td>Cleveland Cavaliers</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Chicago</td>
      <td>Chicago Bulls</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Detroit</td>
      <td>Detroit Pistons</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Milwaukee</td>
      <td>Milwaukee Bucks</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Indianapolis</td>
      <td>Indiana Pacers</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Atlanta</td>
      <td>Atlanta Hawks</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Washington</td>
      <td>Washington Wizards</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Orlando</td>
      <td>Orlando Magic</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Miami</td>
      <td>Miami Heat</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Charlotte</td>
      <td>Charlotte Hornets</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Los Angeles</td>
      <td>{"L.A. Lakers","L.A. Clippers"}</td>
    </tr>
    <tr>
      <th>16</th>
      <td>San Francisco</td>
      <td>Golden State Warriors</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Portland</td>
      <td>Portland Trailblazers</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Sacramento</td>
      <td>Sacramento Kings</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Phoenix</td>
      <td>Phoenix Suns</td>
    </tr>
    <tr>
      <th>20</th>
      <td>San Antonio</td>
      <td>San Antonio Spurs</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Dallas</td>
      <td>Dallas Mavericks</td>
    </tr>
    <tr>
      <th>22</th>
      <td>Houston</td>
      <td>Houston Rockets</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Oklahoma City</td>
      <td>Oklahoma City Thunder</td>
    </tr>
    <tr>
      <th>24</th>
      <td>Minneapolis</td>
      <td>Minnesota Timberwolves</td>
    </tr>
    <tr>
      <th>25</th>
      <td>Denver</td>
      <td>Denver Nuggets</td>
    </tr>
    <tr>
      <th>26</th>
      <td>Salt Lake City</td>
      <td>Utah Jazz</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Memphis</td>
      <td>Memphis Grizzlies</td>
    </tr>
    <tr>
      <th>28</th>
      <td>New Orleans</td>
      <td>New Orleans Pelicans</td>
    </tr>
    <tr>
      <th>29</th>
      <td>Seattle</td>
      <td>Seattle Supersonics</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="editing-existing-records">
<h3><a class="toc-backref" href="#id20" role="doc-backlink"><span class="section-number">7.5.2. </span>Editing Existing Records</a><a class="headerlink" href="#editing-existing-records" title="Permalink to this heading">#</a></h3>
<p>Instead of creating a new record, there are situations in which we want to edit an existing record. To revise a record, we use the following SQL syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UPDATE</span> <span class="n">table</span>
    <span class="n">SET</span> <span class="n">column2</span> <span class="o">=</span> <span class="n">newvalue</span>
    <span class="n">WHERE</span> <span class="n">logicalcondition</span><span class="p">;</span>
</pre></div>
</div>
<p>In this case, <code class="docutils literal notranslate"><span class="pre">SET</span></code> specifies the change we want to make to a particular column. But we don’t want to change <em>all</em> of the values of the column, so we use <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> to specify a logical condition to identify the rows we want to change. A logical condition is a statement that is true on some rows and false on others, and the data update happens only on the rows for which the condition is true.</p>
<p>Suppose we want to change the name of the Charlotte Hornets back to the Charlotte Bobcats (sorry, Charlotte). We can use the following code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">UPDATE nba</span>
<span class="s2">    SET basketballteam = &#39;Charlotte Bobcats&#39;</span>
<span class="s2">    WHERE city = &#39;Charlotte&#39;;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">myquery</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;sqlalchemy.engine.result.ResultProxy at 0x115432c88&gt;
</pre></div>
</div>
</div>
</div>
<p>Here the query says to update values in the NBA table by changing <code class="docutils literal notranslate"><span class="pre">basketballteam</span></code> to Charlotte Bobcats, but only when <code class="docutils literal notranslate"><span class="pre">city</span></code> is Charlotte. This update now appears in the NBA data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM nba&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>city</th>
      <th>basketballteam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Boston</td>
      <td>Boston Celtics</td>
    </tr>
    <tr>
      <th>1</th>
      <td>New York</td>
      <td>New York Knicks</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Philadelphia</td>
      <td>Philadelphia 76ers</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Brooklyn</td>
      <td>Brooklyn Nets</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Toronto</td>
      <td>Toronto Raptors</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Cleveland</td>
      <td>Cleveland Cavaliers</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Chicago</td>
      <td>Chicago Bulls</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Detroit</td>
      <td>Detroit Pistons</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Milwaukee</td>
      <td>Milwaukee Bucks</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Indianapolis</td>
      <td>Indiana Pacers</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Atlanta</td>
      <td>Atlanta Hawks</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Washington</td>
      <td>Washington Wizards</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Orlando</td>
      <td>Orlando Magic</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Miami</td>
      <td>Miami Heat</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Los Angeles</td>
      <td>{"L.A. Lakers","L.A. Clippers"}</td>
    </tr>
    <tr>
      <th>15</th>
      <td>San Francisco</td>
      <td>Golden State Warriors</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Portland</td>
      <td>Portland Trailblazers</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Sacramento</td>
      <td>Sacramento Kings</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Phoenix</td>
      <td>Phoenix Suns</td>
    </tr>
    <tr>
      <th>19</th>
      <td>San Antonio</td>
      <td>San Antonio Spurs</td>
    </tr>
    <tr>
      <th>20</th>
      <td>Dallas</td>
      <td>Dallas Mavericks</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Houston</td>
      <td>Houston Rockets</td>
    </tr>
    <tr>
      <th>22</th>
      <td>Oklahoma City</td>
      <td>Oklahoma City Thunder</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Minneapolis</td>
      <td>Minnesota Timberwolves</td>
    </tr>
    <tr>
      <th>24</th>
      <td>Denver</td>
      <td>Denver Nuggets</td>
    </tr>
    <tr>
      <th>25</th>
      <td>Salt Lake City</td>
      <td>Utah Jazz</td>
    </tr>
    <tr>
      <th>26</th>
      <td>Memphis</td>
      <td>Memphis Grizzlies</td>
    </tr>
    <tr>
      <th>27</th>
      <td>New Orleans</td>
      <td>New Orleans Pelicans</td>
    </tr>
    <tr>
      <th>28</th>
      <td>Seattle</td>
      <td>Seattle Supersonics</td>
    </tr>
    <tr>
      <th>29</th>
      <td>Charlotte</td>
      <td>Charlotte Bobcats</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="deleting-records">
<h3><a class="toc-backref" href="#id21" role="doc-backlink"><span class="section-number">7.5.3. </span>Deleting Records</a><a class="headerlink" href="#deleting-records" title="Permalink to this heading">#</a></h3>
<p>Sometimes you might need to delete records from a database. These situations should be rare. If a record is no longer relevant for a particular use, it is always better to leave the record in the database and use another column to denote new information that can be used to filter records later. If there are mistakes in data entry, it’s better to edit existing records than to delete those records outright. If you must delete a record, the syntax to do so is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DELETE</span> <span class="n">FROM</span> <span class="n">table</span> <span class="n">WHERE</span> <span class="n">logicalcondition</span><span class="p">;</span>
</pre></div>
</div>
<p>First specify the table, then the logical condition that identifies the rows you intend to delete.</p>
<p>In the teams database, suppose we want to delete the Baltimore Ravens (go Browns!) from the NFL table. The code to do that is:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">DELETE FROM nfl WHERE city = &#39;Baltimore&#39;; </span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">myquery</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;sqlalchemy.engine.result.ResultProxy at 0x115445a58&gt;
</pre></div>
</div>
</div>
</div>
<p>In this case, <code class="docutils literal notranslate"><span class="pre">city</span> <span class="pre">=</span> <span class="pre">'Baltimore'</span></code> identifies the rows we want to delete in the NFL table. The NFL data now no longer contains a row for the Ravens:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM nfl&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>city</th>
      <th>footballteam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Buffalo</td>
      <td>Buffalo Bills</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Miami</td>
      <td>Miami Dolphins</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Boston</td>
      <td>New England Patriots</td>
    </tr>
    <tr>
      <th>3</th>
      <td>New York</td>
      <td>{"New York Jets","New York Giants"}</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Cleveland</td>
      <td>Cleveland Browns</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Cincinnati</td>
      <td>Cincinnati Bengals</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Pittsburgh</td>
      <td>Pittsburgh Steelers</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Kansas City</td>
      <td>Kansas City Chiefs</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Las Vegas</td>
      <td>Las Vegas Raiders</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Los Angeles</td>
      <td>{"L.A. Chargers","L.A. Rams"}</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Denver</td>
      <td>Denver Broncos</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Nashville</td>
      <td>Tennessee Titans</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Jacksonville</td>
      <td>Jacksonville Jaguars</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Houston</td>
      <td>Houston Texans</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Indianapolis</td>
      <td>Indianapolis Colts</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Philadelphia</td>
      <td>Philadelphia Eagles</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Dallas</td>
      <td>Dallas Cowboys</td>
    </tr>
    <tr>
      <th>17</th>
      <td>Washington</td>
      <td>Washington Skins</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Atlanta</td>
      <td>Atlanta Falcons</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Charlotte</td>
      <td>Carolina Panthers</td>
    </tr>
    <tr>
      <th>20</th>
      <td>Tampa Bay</td>
      <td>Tampa Bay Buccaneers</td>
    </tr>
    <tr>
      <th>21</th>
      <td>New Orleans</td>
      <td>New Orleans Saints</td>
    </tr>
    <tr>
      <th>22</th>
      <td>San Francisco</td>
      <td>San Francisco 49ers</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Phoenix</td>
      <td>Arizona Cardinals</td>
    </tr>
    <tr>
      <th>24</th>
      <td>Seattle</td>
      <td>Seattle Seahawks</td>
    </tr>
    <tr>
      <th>25</th>
      <td>Chicago</td>
      <td>Chicago Bears</td>
    </tr>
    <tr>
      <th>26</th>
      <td>Green Bay</td>
      <td>Green Bay Packers</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Minneapolis</td>
      <td>Minnesota Vikings</td>
    </tr>
    <tr>
      <th>28</th>
      <td>Detroit</td>
      <td>Detroit Lions</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="cleaning-and-manipulating-data-with-sql-read-operations">
<h2><a class="toc-backref" href="#id22" role="doc-backlink"><span class="section-number">7.6. </span>Cleaning and Manipulating Data with SQL Read Operations</a><a class="headerlink" href="#cleaning-and-manipulating-data-with-sql-read-operations" title="Permalink to this heading">#</a></h2>
<p>After using joins to combine data tables in the database, the data needs to be manipulated to make the data more convenient to use. That might involve narrowing down the data to a specific subset of interest, performing calculations on the data to generate new features, and changing the appearance of the data. In “<a class="reference external" href="https://www.jstatsoft.org/article/view/v059i10">Tidy Data</a>”, Hadley Wickham defines four essential “verbs” of data manipulation:</p>
<blockquote>
<div><ul class="simple">
<li><p>Filter: subsetting or removing observations based on some condition.</p></li>
<li><p>Transform: adding or modifying variables. These modifications can involve either a single variable (e.g., log-transformation), or multiple variables (e.g., computing density from weight and volume).</p></li>
<li><p>Aggregate: collapsing multiple values into a single value (e.g., by summing or taking means).</p></li>
<li><p>Sort: changing the order of observations (p. 13).</p></li>
</ul>
</div></blockquote>
<p>In addition it may be necessary to pull only a selection of the columns into the output, or to change the names of the columns to more readable and useful ones. These operations can be performed within SQL read commands by using the <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause for filtering, mathematical operators to transform columns, the <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> syntax for aggregation, the <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span></code>, <code class="docutils literal notranslate"><span class="pre">ASC</span></code>, or <code class="docutils literal notranslate"><span class="pre">DESC</span></code> clauses for sorting, and the <code class="docutils literal notranslate"><span class="pre">AS</span></code> keyword for renaming columns.</p>
<section id="example-wine-reviews">
<h3><a class="toc-backref" href="#id23" role="doc-backlink"><span class="section-number">7.6.1. </span>Example: Wine Reviews</a><a class="headerlink" href="#example-wine-reviews" title="Permalink to this heading">#</a></h3>
<p>To illustrate how to issue queries to read data while manipulating and cleaning the data, we will use the PostgreSQL version of the wine review database that we created in module 6. If you want to follow along with these example, follow the instructions in the “Using PostgreSQL” subsection of module 6 to get a local wine database running on your system.</p>
<p>For read operations, we can use the <code class="docutils literal notranslate"><span class="pre">pd.read_sql_query()</span></code> function. For that, we first have to use <code class="docutils literal notranslate"><span class="pre">sqlalchemy</span></code> to set up an engine that connects <code class="docutils literal notranslate"><span class="pre">pandas</span></code> to the database:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql+psycopg2://</span><span class="si">{user}</span><span class="s2">:</span><span class="si">{pw}</span><span class="s2">@localhost/</span><span class="si">{db}</span><span class="s2">&quot;</span>
                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s2">&quot;jk8sd&quot;</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="n">pgpassword</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s2">&quot;winedb&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>The logical ER diagram for the wine reviews database is</p>
<img src="https://github.com/jkropko/DS-6001/raw/master/localimages/wine_er4.png" width="400"></section>
<section id="selecting-columns">
<h3><a class="toc-backref" href="#id24" role="doc-backlink"><span class="section-number">7.6.2. </span>Selecting Columns</a><a class="headerlink" href="#selecting-columns" title="Permalink to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">SELECT</span></code> and <code class="docutils literal notranslate"><span class="pre">FROM</span></code> are the primary SQL verbs for reading data. In many of the examples up to this points, we’ve issued queries like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">table</span><span class="p">;</span>
</pre></div>
</div>
<p>that pull all of the rows and all of the columns from a single data table. The <code class="docutils literal notranslate"><span class="pre">*</span></code> character is called a <a class="reference external" href="https://en.wikipedia.org/wiki/Wildcard_character">wildcard character</a>. When typed by itself, the wildcard captures all of the columns in a table. But sometimes we are interested in only a selection of the columns. In that case, we replace the wildcard with the columns we want to include in the output. The following syntax includes three columns from a specified data table:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">,</span> <span class="n">col3</span> <span class="n">FROM</span> <span class="n">table</span><span class="p">;</span>
</pre></div>
</div>
<p>Suppose that I want to know the title, variety, price, points, country, and reviewer for all of the wines in the data. Title, variety, price, and points are all in the reviews table, country is in the locations table, and the reviewer (<code class="docutils literal notranslate"><span class="pre">taster_name</span></code>) is in the tasters table. To produce the data I need to join these three tables while also using <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> to identify only the rows I am interested in. Inner joins are appropriate because every wine in the data has both a location and a reviewer.</p>
<p>The best way to select columns across multiple tables is to use aliasing, the same way we did for joins. In this case, if we alias the reviews table as <code class="docutils literal notranslate"><span class="pre">r</span></code>, locations as <code class="docutils literal notranslate"><span class="pre">l</span></code>, and tasters as <code class="docutils literal notranslate"><span class="pre">t</span></code>, we can use these same aliases to inform SQL where to find each column in the <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> syntax.</p>
<p>The code to return this dataframe is:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT r.title, r.variety, r.price, r.points, l.country, t.taster_name FROM reviews r</span>
<span class="s2">INNER JOIN locations l</span>
<span class="s2">    ON r.location_id = l.location_id</span>
<span class="s2">INNER JOIN tasters t</span>
<span class="s2">    ON r.taster_id = t.taster_id;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>variety</th>
      <th>price</th>
      <th>points</th>
      <th>country</th>
      <th>taster_name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Olivier Leflaive 2006 Les Pucelles Premier Cru...</td>
      <td>Chardonnay</td>
      <td>NaN</td>
      <td>93</td>
      <td>France</td>
      <td>Roger Voss</td>
    </tr>
    <tr>
      <th>1</th>
      <td>The Foundry 2004 Syrah (Coastal Region)</td>
      <td>Syrah</td>
      <td>35.0</td>
      <td>87</td>
      <td>South Africa</td>
      <td>Susan Kostrzewa</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Guilbaud Frères 2007 Le Soleil Nantais  (Musca...</td>
      <td>Melon</td>
      <td>11.0</td>
      <td>87</td>
      <td>France</td>
      <td>Roger Voss</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Domaine du Clos du Fief 2007 Cuvée Tradition  ...</td>
      <td>Gamay</td>
      <td>NaN</td>
      <td>86</td>
      <td>France</td>
      <td>Roger Voss</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Domaine Philippe Delesvaux 2005 La Montée de l...</td>
      <td>Cabernet Sauvignon</td>
      <td>NaN</td>
      <td>86</td>
      <td>France</td>
      <td>Roger Voss</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>103722</th>
      <td>Sheridan Vineyard 2005 Reserve Cabernet Sauvig...</td>
      <td>Cabernet Sauvignon</td>
      <td>75.0</td>
      <td>94</td>
      <td>US</td>
      <td>Paul Gregutt</td>
    </tr>
    <tr>
      <th>103723</th>
      <td>Woodward Canyon 2006 Old Vines Dedication Seri...</td>
      <td>Cabernet Sauvignon</td>
      <td>84.0</td>
      <td>94</td>
      <td>US</td>
      <td>Paul Gregutt</td>
    </tr>
    <tr>
      <th>103724</th>
      <td>Chanson Père et Fils 2005 Champs Gains Premier...</td>
      <td>Chardonnay</td>
      <td>115.0</td>
      <td>93</td>
      <td>France</td>
      <td>Roger Voss</td>
    </tr>
    <tr>
      <th>103725</th>
      <td>Mark Ryan 2006 Chardonnay (Columbia Valley (WA))</td>
      <td>Chardonnay</td>
      <td>NaN</td>
      <td>93</td>
      <td>US</td>
      <td>Paul Gregutt</td>
    </tr>
    <tr>
      <th>103726</th>
      <td>Joseph Drouhin 2007  Grands-Echezeaux</td>
      <td>Pinot Noir</td>
      <td>285.0</td>
      <td>94</td>
      <td>France</td>
      <td>Roger Voss</td>
    </tr>
  </tbody>
</table>
<p>103727 rows × 6 columns</p>
</div></div></div>
</div>
</section>
<section id="logical-statements">
<h3><a class="toc-backref" href="#id25" role="doc-backlink"><span class="section-number">7.6.3. </span>Logical Statements</a><a class="headerlink" href="#logical-statements" title="Permalink to this heading">#</a></h3>
<p>Most programming languages have the capacity to evaluate a statement as being either true or false, or true for some values and false for others. A logical statement uses <strong>logical operators</strong> that define how values should be compared. In SQL, logical statements are used in conjunction with the <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> statement to select the rows to include in the output.</p>
<p>For SQL, logical statements either compare a column to another column, or compare a column to one or more reference values. The following logical operators are available:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">=</span></code> - is equal to?</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;</span></code> - is less than?</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&gt;</span></code> - is greater than?</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;=</span></code> - is less than or equal to?</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&gt;=</span></code> - is greater than or equal to?</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;&gt;</span></code> - is not equal to?</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BETWEEN</span> <span class="pre">a</span> <span class="pre">AND</span> <span class="pre">b</span></code> - true if a value exists within the range from a to b, including a and b</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IN</span> <span class="pre">('element1','element2','element3')</span></code> - true if a value is one of the elements in the given set</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NOT</span></code> - true if the rest of the logical statement is false, false if the rest of the logical statement is true</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AND</span></code> - links separate logical statements together such that the overall statement is true only when all of the linked statements are true</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OR</span></code> - links separate logical statements together such that the overall statement is true when any of the linked statements are true</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LIKE</span> <span class="pre">pattern</span></code> - true if the string value matches the given pattern:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">LIKE</span> <span class="pre">'%%text'</span></code> captures all rows in which a given column ends with ‘text’</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LIKE</span> <span class="pre">'text%%'</span></code> captures all rows in which a given column begins with ‘text’</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LIKE</span> <span class="pre">'%%text%%'</span></code> captures all rows in which a given column contains ‘text’ somewhere in its string value</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">()</span></code> - parts of the logical statement that are contained within parentheses are evaluated first</p></li>
</ul>
<p>I will show examples of how to use these logical statements for filtering rows, in the next section.</p>
</section>
<section id="filtering-rows">
<h3><a class="toc-backref" href="#id26" role="doc-backlink"><span class="section-number">7.6.4. </span>Filtering Rows</a><a class="headerlink" href="#filtering-rows" title="Permalink to this heading">#</a></h3>
<p>Suppose we wanted to know the title, the variety, and the price of the French wines that Roger Voss scored as 100. It’s a simple semantic sentence, but it connects to a more complicated set of SQL functions. First consider all of the columns we need to use to process the sentence:</p>
<ul class="simple">
<li><p>title, from the reviews table</p></li>
<li><p>variety, from the reviews table</p></li>
<li><p>price, from the reviews table</p></li>
<li><p>French, a value of country, from the locations table</p></li>
<li><p>Roger Voss, a value of taster name, from the tasters table,</p></li>
<li><p>and 100, a value of points, from the reviews table.</p></li>
</ul>
<p>Because we need to use data from the reviews, locations, and tasters tables, we need to inner join reviews, locations, and tasters.</p>
<p>But then on top of this join, we need to restrict both the columns and rows. We only want title, variety, and price in the final data, so we use <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> to keep only these columns.</p>
<p>To restrict the rows, we use <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> along with a logical condition. This logical condition has a few parts: we want wines in which <code class="docutils literal notranslate"><span class="pre">country='France'</span></code>, <code class="docutils literal notranslate"><span class="pre">taster_name='Roger</span> <span class="pre">Voss'</span></code>, and <code class="docutils literal notranslate"><span class="pre">points=100</span></code>. All three conditions need to be true for us to want to keep the row, so we connect the three statements with <code class="docutils literal notranslate"><span class="pre">AND</span></code>.</p>
<p>The SQL query that returns the title, the variety, and the price of the French wines that Roger Voss scored as 100 is:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT r.title, r.variety, r.price FROM reviews r</span>
<span class="s2">INNER JOIN locations l</span>
<span class="s2">    ON r.location_id = l.location_id</span>
<span class="s2">INNER JOIN tasters t</span>
<span class="s2">    ON r.taster_id = t.taster_id</span>
<span class="s2">WHERE l.country=&#39;France&#39; AND t.taster_name=&#39;Roger Voss&#39; AND r.points=100;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>variety</th>
      <th>price</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Krug 2002 Brut  (Champagne)</td>
      <td>Champagne Blend</td>
      <td>259.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Château Léoville Barton 2010  Saint-Julien</td>
      <td>Bordeaux-style Red Blend</td>
      <td>150.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Louis Roederer 2008 Cristal Vintage Brut  (Cha...</td>
      <td>Champagne Blend</td>
      <td>250.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Salon 2006 Le Mesnil Blanc de Blancs Brut Char...</td>
      <td>Chardonnay</td>
      <td>617.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Château Lafite Rothschild 2010  Pauillac</td>
      <td>Bordeaux-style Red Blend</td>
      <td>1500.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Château Cheval Blanc 2010  Saint-Émilion</td>
      <td>Bordeaux-style Red Blend</td>
      <td>1500.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Château Léoville Las Cases 2010  Saint-Julien</td>
      <td>Bordeaux-style Red Blend</td>
      <td>359.0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Château Haut-Brion 2014  Pessac-Léognan</td>
      <td>Bordeaux-style White Blend</td>
      <td>848.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>I like my wine local or low-cost. So as another example, suppose we want the title, variety, price, points, country, and providence for all of the wines with scores of 90 or more that either cost between 5 and 10 dollars or are from Virginia. In this case, we need to join the reviews and locations data together, and write a logical statement that matches these specific conditions. The logical condition is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">points</span> <span class="o">&gt;=</span> <span class="mi">90</span> <span class="n">AND</span> <span class="p">(</span><span class="n">price</span> <span class="n">BETWEEN</span> <span class="mi">5</span> <span class="n">AND</span> <span class="mi">10</span> <span class="n">OR</span> <span class="n">province</span> <span class="o">=</span> <span class="s1">&#39;Virginia&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The entire SQL query is</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT r.title, r.variety, r.price, r.points, l.country, l.province FROM reviews r</span>
<span class="s2">INNER JOIN locations l</span>
<span class="s2">    ON r.location_id = l.location_id</span>
<span class="s2">WHERE r.points &gt;= 90 AND (r.price BETWEEN 5 AND 10 OR l.province = &#39;Virginia&#39;);</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>variety</th>
      <th>price</th>
      <th>points</th>
      <th>country</th>
      <th>province</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Château Vircoulon 2016  Bordeaux Blanc</td>
      <td>Bordeaux-style White Blend</td>
      <td>10.0</td>
      <td>90</td>
      <td>France</td>
      <td>Bordeaux</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Mano A Mano 2011 Tempranillo (Vino de la Tierr...</td>
      <td>Tempranillo</td>
      <td>9.0</td>
      <td>90</td>
      <td>Spain</td>
      <td>Central Spain</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Aveleda 2014 Quinta da Aveleda Estate Bottled ...</td>
      <td>Portuguese White</td>
      <td>9.0</td>
      <td>90</td>
      <td>Portugal</td>
      <td>Vinho Verde</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Chateau Ste. Michelle 2011 Riesling (Columbia ...</td>
      <td>Riesling</td>
      <td>9.0</td>
      <td>91</td>
      <td>US</td>
      <td>Washington</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Quinta do Portal 2007 Mural Reserva Red (Douro)</td>
      <td>Portuguese Red</td>
      <td>10.0</td>
      <td>91</td>
      <td>Portugal</td>
      <td>Douro</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>76</th>
      <td>Casaleiro 2012 Reserva Touriga Nacional-Castel...</td>
      <td>Portuguese Red</td>
      <td>9.0</td>
      <td>90</td>
      <td>Portugal</td>
      <td>Tejo</td>
    </tr>
    <tr>
      <th>77</th>
      <td>Aveleda 2015 Quinta da Aveleda White (Vinho Ve...</td>
      <td>Portuguese White</td>
      <td>9.0</td>
      <td>90</td>
      <td>Portugal</td>
      <td>Vinho Verde</td>
    </tr>
    <tr>
      <th>78</th>
      <td>Cookies &amp; Cream 2010 Merlot (California)</td>
      <td>Merlot</td>
      <td>10.0</td>
      <td>90</td>
      <td>US</td>
      <td>California</td>
    </tr>
    <tr>
      <th>79</th>
      <td>Lovingston 2012 Josie's Knoll Merlot (Monticello)</td>
      <td>Merlot</td>
      <td>20.0</td>
      <td>91</td>
      <td>US</td>
      <td>Virginia</td>
    </tr>
    <tr>
      <th>80</th>
      <td>Aveleda 2016 Quinta da Aveleda White (Vinho Ve...</td>
      <td>Portuguese White</td>
      <td>10.0</td>
      <td>90</td>
      <td>Portugal</td>
      <td>Vinho Verde</td>
    </tr>
  </tbody>
</table>
<p>81 rows × 6 columns</p>
</div></div></div>
</div>
<p>The parentheses in this last query are needed to ensure that the DBMS evaluates the <code class="docutils literal notranslate"><span class="pre">OR</span></code> statement first. Without the parentheses,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">points</span> <span class="o">&gt;=</span> <span class="mi">90</span> <span class="n">AND</span> <span class="n">price</span> <span class="n">BETWEEN</span> <span class="mi">5</span> <span class="n">AND</span> <span class="mi">10</span> <span class="n">OR</span> <span class="n">province</span> <span class="o">=</span> <span class="s1">&#39;Virginia&#39;</span>
</pre></div>
</div>
<p>the DBMS evaluates the first two conditions first, then considers the third, so the statement is equivalent to</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">points</span> <span class="o">&gt;=</span> <span class="mi">90</span> <span class="n">AND</span> <span class="n">price</span> <span class="n">BETWEEN</span> <span class="mi">5</span> <span class="n">AND</span> <span class="mi">10</span><span class="p">)</span> <span class="n">OR</span> <span class="n">province</span> <span class="o">=</span> <span class="s1">&#39;Virginia&#39;</span>
</pre></div>
</div>
<p>and it returns data with all wines that have scores of at least 90 and prices between 5 and 10 dollars, along with all wines from Virginia whether or not those wines have scores of at least 90:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT r.title, r.variety, r.price, r.points, l.country, l.province FROM reviews r</span>
<span class="s2">INNER JOIN locations l</span>
<span class="s2">    ON r.location_id = l.location_id</span>
<span class="s2">WHERE r.points &gt;= 90 AND r.price BETWEEN 5 AND 10 OR l.province = &#39;Virginia&#39;;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>variety</th>
      <th>price</th>
      <th>points</th>
      <th>country</th>
      <th>province</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Veramar 2016 JB Winemaker Series Cabernet Fran...</td>
      <td>Cabernet Franc</td>
      <td>34.0</td>
      <td>86</td>
      <td>US</td>
      <td>Virginia</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Château Vircoulon 2016  Bordeaux Blanc</td>
      <td>Bordeaux-style White Blend</td>
      <td>10.0</td>
      <td>90</td>
      <td>France</td>
      <td>Bordeaux</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Mano A Mano 2011 Tempranillo (Vino de la Tierr...</td>
      <td>Tempranillo</td>
      <td>9.0</td>
      <td>90</td>
      <td>Spain</td>
      <td>Central Spain</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Trump 2014 Rosé (Monticello)</td>
      <td>Rosé</td>
      <td>14.0</td>
      <td>86</td>
      <td>US</td>
      <td>Virginia</td>
    </tr>
    <tr>
      <th>4</th>
      <td>The Boneyard 2014 Chardonnay (Virginia)</td>
      <td>Chardonnay</td>
      <td>15.0</td>
      <td>86</td>
      <td>US</td>
      <td>Virginia</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>444</th>
      <td>Annefield Vineyards 2009 Cabernet Franc (Virgi...</td>
      <td>Cabernet Franc</td>
      <td>29.0</td>
      <td>88</td>
      <td>US</td>
      <td>Virginia</td>
    </tr>
    <tr>
      <th>445</th>
      <td>Lovingston 2012 Josie's Knoll Merlot (Monticello)</td>
      <td>Merlot</td>
      <td>20.0</td>
      <td>91</td>
      <td>US</td>
      <td>Virginia</td>
    </tr>
    <tr>
      <th>446</th>
      <td>Aveleda 2016 Quinta da Aveleda White (Vinho Ve...</td>
      <td>Portuguese White</td>
      <td>10.0</td>
      <td>90</td>
      <td>Portugal</td>
      <td>Vinho Verde</td>
    </tr>
    <tr>
      <th>447</th>
      <td>Tarara 2013 Cabernet Franc (Virginia)</td>
      <td>Cabernet Franc</td>
      <td>25.0</td>
      <td>85</td>
      <td>US</td>
      <td>Virginia</td>
    </tr>
    <tr>
      <th>448</th>
      <td>Paradise Springs 2014 Nana's Rosé (Virginia)</td>
      <td>Rosé</td>
      <td>22.0</td>
      <td>86</td>
      <td>US</td>
      <td>Virginia</td>
    </tr>
  </tbody>
</table>
<p>449 rows × 6 columns</p>
</div></div></div>
</div>
<p>Suppose I’m open to many wines, but I have a thing against wines from the U.S., and I don’t like Pinot Noir, Pinot Gris, or Chardonnay. I want to query the wines database to return data on the title, variety, country, and price of all of these wines except for the American ones and the ones I dislike. The SQL query requires joining the reviews and locations tables, and using negation in the logical statement with the <code class="docutils literal notranslate"><span class="pre">&lt;&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">NOT</span></code> operators, like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT r.title, r.variety, r.price, l.country FROM reviews r</span>
<span class="s2">INNER JOIN locations l</span>
<span class="s2">    ON r.location_id = l.location_id</span>
<span class="s2">WHERE country &lt;&gt; &#39;US&#39; AND variety NOT IN (&#39;Pinot Noir&#39;, &#39;Pinot Gris&#39;, &#39;Chardonnay&#39;);</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>variety</th>
      <th>price</th>
      <th>country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>The Foundry 2004 Syrah (Coastal Region)</td>
      <td>Syrah</td>
      <td>35.0</td>
      <td>South Africa</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Guilbaud Frères 2007 Le Soleil Nantais  (Musca...</td>
      <td>Melon</td>
      <td>11.0</td>
      <td>France</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Domaine du Clos du Fief 2007 Cuvée Tradition  ...</td>
      <td>Gamay</td>
      <td>NaN</td>
      <td>France</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Domaine Philippe Delesvaux 2005 La Montée de l...</td>
      <td>Cabernet Sauvignon</td>
      <td>NaN</td>
      <td>France</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Georges Duboeuf 2007  Beaujolais-Villages</td>
      <td>Gamay</td>
      <td>NaN</td>
      <td>France</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>57429</th>
      <td>Indomita NV Rosé Sparkling (Casablanca Valley)</td>
      <td>Sparkling Blend</td>
      <td>18.0</td>
      <td>Chile</td>
    </tr>
    <tr>
      <th>57430</th>
      <td>Intipalka 2013 Valle del Sol Tannat (Ica)</td>
      <td>Tannat</td>
      <td>14.0</td>
      <td>Peru</td>
    </tr>
    <tr>
      <th>57431</th>
      <td>Lobster Reef 2014 Sauvignon Blanc (Marlborough)</td>
      <td>Sauvignon Blanc</td>
      <td>12.0</td>
      <td>New Zealand</td>
    </tr>
    <tr>
      <th>57432</th>
      <td>Millaman 2014 Estate Reserve Sauvignon Blanc (...</td>
      <td>Sauvignon Blanc</td>
      <td>10.0</td>
      <td>Chile</td>
    </tr>
    <tr>
      <th>57433</th>
      <td>Royal Tokaji 1999 Mézes Mály Aszú 6 Puttonyos ...</td>
      <td>Tokaji</td>
      <td>175.0</td>
      <td>Hungary</td>
    </tr>
  </tbody>
</table>
<p>57434 rows × 4 columns</p>
</div></div></div>
</div>
<p>If we want all of the columns from the reviews table for wines whose descriptions contain the words “smoke” and “chocolate” - taking case sensitivity into account by converting the descriptions to all lower case in the <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause so that “chocolate” and “Chocolate” are both matched - the following query returns those wines:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT * FROM reviews </span>
<span class="s2">WHERE LOWER(description) LIKE &#39;</span><span class="si">%%</span><span class="s2">smoke</span><span class="si">%%</span><span class="s2">&#39; AND LOWER(description) LIKE &#39;</span><span class="si">%%</span><span class="s2">chocolate</span><span class="si">%%</span><span class="s2">&#39;;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>wine_id</th>
      <th>title</th>
      <th>variety</th>
      <th>description</th>
      <th>points</th>
      <th>price</th>
      <th>taster_id</th>
      <th>winery_id</th>
      <th>location_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6792</td>
      <td>Guardian Peak 2006 Shiraz (Western Cape)</td>
      <td>Shiraz</td>
      <td>A gorgeous nose of plums, chocolate and red fr...</td>
      <td>89</td>
      <td>15.0</td>
      <td>16</td>
      <td>7363</td>
      <td>1141</td>
    </tr>
    <tr>
      <th>1</th>
      <td>7812</td>
      <td>Hightower 2006 Cabernet Sauvignon (Columbia Va...</td>
      <td>Cabernet Sauvignon</td>
      <td>Sourced largely from Red Mountain fruit, this ...</td>
      <td>87</td>
      <td>35.0</td>
      <td>3</td>
      <td>7629</td>
      <td>1474</td>
    </tr>
    <tr>
      <th>2</th>
      <td>7866</td>
      <td>Viña Cobos 2012 Bramare Marchiori Vineyard Mal...</td>
      <td>Malbec</td>
      <td>Toasty woodsmoke aromas are matched by wild be...</td>
      <td>94</td>
      <td>90.0</td>
      <td>5</td>
      <td>13962</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>8110</td>
      <td>Mendel 2013 Unus Red (Mendoza)</td>
      <td>Bordeaux-style Red Blend</td>
      <td>Rich aromas of raisin, cassis and blackberry a...</td>
      <td>93</td>
      <td>50.0</td>
      <td>5</td>
      <td>9746</td>
      <td>7</td>
    </tr>
    <tr>
      <th>4</th>
      <td>9262</td>
      <td>Freakshow 2014 Cabernet Sauvignon (Lodi)</td>
      <td>Cabernet Sauvignon</td>
      <td>Rich, ripe and oaky, this full-bodied wine has...</td>
      <td>91</td>
      <td>20.0</td>
      <td>10</td>
      <td>6893</td>
      <td>1304</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>260</th>
      <td>4862</td>
      <td>Hearst Ranch 2013 Lone Tree Cabernet Franc (Pa...</td>
      <td>Cabernet Franc</td>
      <td>Made in a thick, oaky style, this shows burned...</td>
      <td>87</td>
      <td>35.0</td>
      <td>8</td>
      <td>7498</td>
      <td>1337</td>
    </tr>
    <tr>
      <th>261</th>
      <td>4690</td>
      <td>Pear Valley 2013 Distraction Red (Paso Robles)</td>
      <td>Bordeaux-style Red Blend</td>
      <td>The signature bottling from this winery, this ...</td>
      <td>91</td>
      <td>35.0</td>
      <td>8</td>
      <td>10762</td>
      <td>1337</td>
    </tr>
    <tr>
      <th>262</th>
      <td>4794</td>
      <td>Estate Constantin Gofas 2008 Agiorgitiko (Nemea)</td>
      <td>Agiorgitiko</td>
      <td>This wine has the plucky character typical of ...</td>
      <td>85</td>
      <td>18.0</td>
      <td>16</td>
      <td>6366</td>
      <td>668</td>
    </tr>
    <tr>
      <th>263</th>
      <td>6574</td>
      <td>Fielding Hills 2006 RiverBend Vineyard Syrah (...</td>
      <td>Syrah</td>
      <td>Bold and forward, this estate-grown Syrah fair...</td>
      <td>94</td>
      <td>40.0</td>
      <td>3</td>
      <td>6619</td>
      <td>1483</td>
    </tr>
    <tr>
      <th>264</th>
      <td>5020</td>
      <td>Corliss Estates 2007 Cabernet Sauvignon (Colum...</td>
      <td>Cabernet Sauvignon</td>
      <td>Concentrated and wonderfully aromatic, this ag...</td>
      <td>94</td>
      <td>75.0</td>
      <td>3</td>
      <td>4677</td>
      <td>1474</td>
    </tr>
  </tbody>
</table>
<p>265 rows × 9 columns</p>
</div></div></div>
</div>
<p>There are situations in which we want to display only some of the records that match a particular query. For that, we can use the <code class="docutils literal notranslate"><span class="pre">LIMIT</span></code> and <code class="docutils literal notranslate"><span class="pre">OFFSET</span></code> clauses. <code class="docutils literal notranslate"><span class="pre">LIMIT</span></code> sets the number of records to extract, and <code class="docutils literal notranslate"><span class="pre">OFFSET</span></code> set the starting row. For example, adding</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
<p>to a query instructs the DBMS to extract only the first 10 rows of the output data. Adding</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LIMIT</span> <span class="mi">10</span> <span class="n">OFFSET</span> <span class="mi">5</span>
</pre></div>
</div>
<p>tells the DBMS to extract 10 rows, after first skipping the first 5 rows: so these clauses together return rows 6 through 15. To see the 4th through 7th rows from the previous query to the wine reviews database, we can type:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT * FROM reviews </span>
<span class="s2">WHERE LOWER(description) LIKE &#39;</span><span class="si">%%</span><span class="s2">smoke</span><span class="si">%%</span><span class="s2">&#39; AND LOWER(description) LIKE &#39;</span><span class="si">%%</span><span class="s2">chocolate</span><span class="si">%%</span><span class="s2">&#39;</span>
<span class="s2">LIMIT 4 OFFSET 3;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>wine_id</th>
      <th>title</th>
      <th>variety</th>
      <th>description</th>
      <th>points</th>
      <th>price</th>
      <th>taster_id</th>
      <th>winery_id</th>
      <th>location_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>8110</td>
      <td>Mendel 2013 Unus Red (Mendoza)</td>
      <td>Bordeaux-style Red Blend</td>
      <td>Rich aromas of raisin, cassis and blackberry a...</td>
      <td>93</td>
      <td>50.0</td>
      <td>5</td>
      <td>9746</td>
      <td>7</td>
    </tr>
    <tr>
      <th>1</th>
      <td>9262</td>
      <td>Freakshow 2014 Cabernet Sauvignon (Lodi)</td>
      <td>Cabernet Sauvignon</td>
      <td>Rich, ripe and oaky, this full-bodied wine has...</td>
      <td>91</td>
      <td>20.0</td>
      <td>10</td>
      <td>6893</td>
      <td>1304</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9746</td>
      <td>Carmel 2013 Admon Vineyard Cabernet Sauvignon ...</td>
      <td>Cabernet Sauvignon</td>
      <td>This wine has offers aromas of dark plum and c...</td>
      <td>89</td>
      <td>35.0</td>
      <td>14</td>
      <td>1925</td>
      <td>694</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10326</td>
      <td>De Martino 2009 Alto de Piedras Single Vineyar...</td>
      <td>Carmenère</td>
      <td>A big, earthy type of wine with a ton of ripen...</td>
      <td>90</td>
      <td>45.0</td>
      <td>5</td>
      <td>4973</td>
      <td>182</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="sorting-data">
<h3><a class="toc-backref" href="#id27" role="doc-backlink"><span class="section-number">7.6.5. </span>Sorting Data</a><a class="headerlink" href="#sorting-data" title="Permalink to this heading">#</a></h3>
<p>Sorting data refers to rearranging the rows of a dataframe. Sorting is a cosmetic thing to do to data because the order of the rows should not change the meaning of the data both in terms of storage (rearranging the rows should NOT change the meaning of each row), or for most analytical models (rearranging rows won’t change the parameter estimates from a linear regression, for example). But sorting is a way to visualize important characteristics about the data and to quickly see important records with maximum and minimum values of key features.</p>
<p>To sort the output data, use the <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span></code> syntax within an SQL query. The general syntax for <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span></code> is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ORDER</span> <span class="n">BY</span> <span class="n">column1</span><span class="p">,</span> <span class="n">column2</span><span class="p">,</span> <span class="n">column3</span>
</pre></div>
</div>
<p>Writing more than one column is optional. If more than one column is entered, then the second column is used to <em>break ties</em> between rows that have the same value of the first column. If a third column is entered, it’s used to break ties between rows that have the same value for both the first and second columns. In addition, each column can be sorted in ascending or descending order by typing either <code class="docutils literal notranslate"><span class="pre">ASC</span></code> (this is the default, so typing <code class="docutils literal notranslate"><span class="pre">ASC</span></code> is optional, but useful for making the SQL code more readable) or <code class="docutils literal notranslate"><span class="pre">DESC</span></code> immediately after the column name.</p>
<p>For example, what are the top rated wines from Virginia? And of these top rated wines, which ones are cheapest? To find out, we issue a query that joins the reviews and locations tables, filters the data to just wines from Virginia, narrows down the columns to just title, points, and price, and sorts first by points, then by price. We sort by points in descending order so the best wines appear first, and we sort by price in ascending order so that the cheapest wines appear first. The syntax for this query is:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT r.title, r.points, r.price FROM reviews r</span>
<span class="s2">INNER JOIN locations l</span>
<span class="s2">    ON r.location_id = l.location_id</span>
<span class="s2">WHERE province = &#39;Virginia&#39;</span>
<span class="s2">ORDER BY points DESC, price ASC;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>points</th>
      <th>price</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>King Family 2015 Orange Viognier (Monticello)</td>
      <td>92</td>
      <td>35.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Lovingston 2012 Josie's Knoll Merlot (Monticello)</td>
      <td>91</td>
      <td>20.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Lovingston 2015 Josie's Knoll Rotunda Red (Mon...</td>
      <td>90</td>
      <td>20.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Barboursville Vineyards 2015 Reserve Cabernet ...</td>
      <td>90</td>
      <td>25.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>King Family 2012 Meritage (Monticello)</td>
      <td>90</td>
      <td>31.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>374</th>
      <td>Narmada 2013 Reserve Cabernet Franc (Virginia)</td>
      <td>82</td>
      <td>34.0</td>
    </tr>
    <tr>
      <th>375</th>
      <td>Veramar 2009 Chardonnay (Virginia)</td>
      <td>81</td>
      <td>18.0</td>
    </tr>
    <tr>
      <th>376</th>
      <td>Bogati 2013 Black Label Club Fumé Blanc Sauvig...</td>
      <td>81</td>
      <td>26.0</td>
    </tr>
    <tr>
      <th>377</th>
      <td>Three Fox 2014 Calabrese Pinot Grigio (Middleb...</td>
      <td>81</td>
      <td>28.0</td>
    </tr>
    <tr>
      <th>378</th>
      <td>Winery at La Grange 2012 Cabernet Sauvignon (V...</td>
      <td>81</td>
      <td>43.0</td>
    </tr>
  </tbody>
</table>
<p>379 rows × 3 columns</p>
</div></div></div>
</div>
</section>
<section id="renaming-columns-and-transforming-data-values">
<h3><a class="toc-backref" href="#id28" role="doc-backlink"><span class="section-number">7.6.6. </span>Renaming Columns and Transforming Data Values</a><a class="headerlink" href="#renaming-columns-and-transforming-data-values" title="Permalink to this heading">#</a></h3>
<p>Sometimes it is useful to rename the columns in the output data within a query. To rename a column, use the <code class="docutils literal notranslate"><span class="pre">AS</span></code> syntax while referencing the columns in <code class="docutils literal notranslate"><span class="pre">SELECT</span></code>. For example, we can load the title, variety, and points columns from the reviews table, but we can rename these columns name, type, and score respectively:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT title AS name, variety AS type, points AS score FROM reviews;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>type</th>
      <th>score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Casas del Bosque 2011 Reserva Sauvignon Blanc ...</td>
      <td>Sauvignon Blanc</td>
      <td>86</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Marqués de Terán 2009 Selección Especial  (Rioja)</td>
      <td>Tempranillo</td>
      <td>86</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Maurice Ecard 2009  Bourgogne</td>
      <td>Chardonnay</td>
      <td>86</td>
    </tr>
    <tr>
      <th>3</th>
      <td>McGregor 2010 Semi-Dry Riesling (Finger Lakes)</td>
      <td>Riesling</td>
      <td>86</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Jules Taylor 2009 Ballochdale Estate Pinot Noi...</td>
      <td>Pinot Noir</td>
      <td>86</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>103722</th>
      <td>Glenora 2010 Gewürztraminer (Finger Lakes)</td>
      <td>Gewürztraminer</td>
      <td>86</td>
    </tr>
    <tr>
      <th>103723</th>
      <td>Hard Row To Hoe 2010 Marsanne (Yakima Valley)</td>
      <td>Marsanne</td>
      <td>86</td>
    </tr>
    <tr>
      <th>103724</th>
      <td>Animale 2009 Dolcetto (Columbia Valley (WA))</td>
      <td>Dolcetto</td>
      <td>86</td>
    </tr>
    <tr>
      <th>103725</th>
      <td>Beresan 2008 The Buzz Yellow Jacket Vineyard R...</td>
      <td>Red Blend</td>
      <td>86</td>
    </tr>
    <tr>
      <th>103726</th>
      <td>Cabot Vineyards 2007 Syrah (Humboldt County)</td>
      <td>Syrah</td>
      <td>86</td>
    </tr>
  </tbody>
</table>
<p>103727 rows × 3 columns</p>
</div></div></div>
</div>
<p>In other situations, we might want to transform a column arithmetically or in another way. SQL supports the standard arithmetic operators: <code class="docutils literal notranslate"><span class="pre">+</span></code> for addition, <code class="docutils literal notranslate"><span class="pre">-</span></code> for subtraction, <code class="docutils literal notranslate"><span class="pre">*</span></code> for multiplication, and <code class="docutils literal notranslate"><span class="pre">/</span></code> for division. SQL also supports the modulo operator <code class="docutils literal notranslate"><span class="pre">%</span></code> to return the remainder after division (<code class="docutils literal notranslate"><span class="pre">16</span> <span class="pre">%</span> <span class="pre">5</span></code> equals 1, for example, because 16 divided by 5 yields a remainder of 1). SQL also allows the following <a class="reference external" href="https://www.w3schools.com/sql/func_sqlserver_pi.asp">arithmetic functions</a>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">EXP(a)</span></code> - raises <code class="docutils literal notranslate"><span class="pre">a</span></code> the argument to the power of <span class="math notranslate nohighlight">\(e = 2.718...\)</span></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">POWER(a,b)</span></code> - raises <code class="docutils literal notranslate"><span class="pre">a</span></code> to the power of <code class="docutils literal notranslate"><span class="pre">b</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LOG(a)</span></code> - takes the natural (base <span class="math notranslate nohighlight">\(e\)</span>) logarithm of <code class="docutils literal notranslate"><span class="pre">a</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LOG10(a)</span></code> - takes the common (base 10) logarithm of <code class="docutils literal notranslate"><span class="pre">a</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SQRT(a)</span></code> - takes the square root of <code class="docutils literal notranslate"><span class="pre">a</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ABS(a)</span></code> - takes the absolute value of <code class="docutils literal notranslate"><span class="pre">a</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CEILING(a)</span></code> - rounds values of <code class="docutils literal notranslate"><span class="pre">a</span></code> up to the next whole number</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FLOOR(a)</span></code> - rounds values of <code class="docutils literal notranslate"><span class="pre">a</span></code> down to a whole number</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ROUND(a,</span> <span class="pre">k)</span></code> - rounds values of <code class="docutils literal notranslate"><span class="pre">a</span></code> up or down to the nearest number with <code class="docutils literal notranslate"><span class="pre">k</span></code> decimals</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SIGN(a)</span></code> - returns 1 if <code class="docutils literal notranslate"><span class="pre">a</span></code> is positive, -1 if <code class="docutils literal notranslate"><span class="pre">a</span></code> is negative, and 0 if <code class="docutils literal notranslate"><span class="pre">a</span></code> is 0</p></li>
</ul>
<p>In addition, if you need them, there are many trigonometric functions built into standard SQL.</p>
<p>When using a function that operates on a column, it is important to use <code class="docutils literal notranslate"><span class="pre">AS</span></code> to name the new column, as SQL has no way to choose a logical name automatically for constructed columns and uses <code class="docutils literal notranslate"><span class="pre">?column?</span></code> be default.</p>
<p>For example, we can convert the price of each wine from dollars to Euros by multiplying the price by the .91 USD to Euro exchange rate. We keep the original price in the query but rename it <code class="docutils literal notranslate"><span class="pre">price_dollars</span></code>, and we name the converted price <code class="docutils literal notranslate"><span class="pre">price_euros</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT title, variety, price AS price_dollars, .91*price AS price_euros FROM reviews;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>variety</th>
      <th>price_dollars</th>
      <th>price_euros</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Casas del Bosque 2011 Reserva Sauvignon Blanc ...</td>
      <td>Sauvignon Blanc</td>
      <td>12.0</td>
      <td>10.92</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Marqués de Terán 2009 Selección Especial  (Rioja)</td>
      <td>Tempranillo</td>
      <td>24.0</td>
      <td>21.84</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Maurice Ecard 2009  Bourgogne</td>
      <td>Chardonnay</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>McGregor 2010 Semi-Dry Riesling (Finger Lakes)</td>
      <td>Riesling</td>
      <td>18.0</td>
      <td>16.38</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Jules Taylor 2009 Ballochdale Estate Pinot Noi...</td>
      <td>Pinot Noir</td>
      <td>22.0</td>
      <td>20.02</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>103722</th>
      <td>Glenora 2010 Gewürztraminer (Finger Lakes)</td>
      <td>Gewürztraminer</td>
      <td>15.0</td>
      <td>13.65</td>
    </tr>
    <tr>
      <th>103723</th>
      <td>Hard Row To Hoe 2010 Marsanne (Yakima Valley)</td>
      <td>Marsanne</td>
      <td>18.0</td>
      <td>16.38</td>
    </tr>
    <tr>
      <th>103724</th>
      <td>Animale 2009 Dolcetto (Columbia Valley (WA))</td>
      <td>Dolcetto</td>
      <td>24.0</td>
      <td>21.84</td>
    </tr>
    <tr>
      <th>103725</th>
      <td>Beresan 2008 The Buzz Yellow Jacket Vineyard R...</td>
      <td>Red Blend</td>
      <td>19.0</td>
      <td>17.29</td>
    </tr>
    <tr>
      <th>103726</th>
      <td>Cabot Vineyards 2007 Syrah (Humboldt County)</td>
      <td>Syrah</td>
      <td>24.0</td>
      <td>21.84</td>
    </tr>
  </tbody>
</table>
<p>103727 rows × 4 columns</p>
</div></div></div>
</div>
<p>For no reason other than to demonstrate the use of the various mathematical functions, we can put many transformations of price in one dataframe:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT price,</span>
<span class="s2">    EXP(price/1000) as price_exp,</span>
<span class="s2">    LOG(price) as price_natlog,</span>
<span class="s2">    LOG10(price) as price_commonlog,</span>
<span class="s2">    ROUND(LOG(price)) as price_loground,</span>
<span class="s2">    SQRT(price) as price_sqrt,</span>
<span class="s2">    POWER(price, 2) as price_squared,</span>
<span class="s2">    POWER(price, 3) as price_cubed,</span>
<span class="s2">    SIGN(price - 50) as price_morethan50</span>
<span class="s2">FROM reviews;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>price</th>
      <th>price_exp</th>
      <th>price_natlog</th>
      <th>price_commonlog</th>
      <th>price_loground</th>
      <th>price_sqrt</th>
      <th>price_squared</th>
      <th>price_cubed</th>
      <th>price_morethan50</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12.0</td>
      <td>1.012072</td>
      <td>1.079181</td>
      <td>1.079181</td>
      <td>1.0</td>
      <td>3.464102</td>
      <td>144.0</td>
      <td>1728.0</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>24.0</td>
      <td>1.024290</td>
      <td>1.380211</td>
      <td>1.380211</td>
      <td>1.0</td>
      <td>4.898979</td>
      <td>576.0</td>
      <td>13824.0</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>18.0</td>
      <td>1.018163</td>
      <td>1.255273</td>
      <td>1.255273</td>
      <td>1.0</td>
      <td>4.242641</td>
      <td>324.0</td>
      <td>5832.0</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>22.0</td>
      <td>1.022244</td>
      <td>1.342423</td>
      <td>1.342423</td>
      <td>1.0</td>
      <td>4.690416</td>
      <td>484.0</td>
      <td>10648.0</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>103722</th>
      <td>15.0</td>
      <td>1.015113</td>
      <td>1.176091</td>
      <td>1.176091</td>
      <td>1.0</td>
      <td>3.872983</td>
      <td>225.0</td>
      <td>3375.0</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>103723</th>
      <td>18.0</td>
      <td>1.018163</td>
      <td>1.255273</td>
      <td>1.255273</td>
      <td>1.0</td>
      <td>4.242641</td>
      <td>324.0</td>
      <td>5832.0</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>103724</th>
      <td>24.0</td>
      <td>1.024290</td>
      <td>1.380211</td>
      <td>1.380211</td>
      <td>1.0</td>
      <td>4.898979</td>
      <td>576.0</td>
      <td>13824.0</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>103725</th>
      <td>19.0</td>
      <td>1.019182</td>
      <td>1.278754</td>
      <td>1.278754</td>
      <td>1.0</td>
      <td>4.358899</td>
      <td>361.0</td>
      <td>6859.0</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>103726</th>
      <td>24.0</td>
      <td>1.024290</td>
      <td>1.380211</td>
      <td>1.380211</td>
      <td>1.0</td>
      <td>4.898979</td>
      <td>576.0</td>
      <td>13824.0</td>
      <td>-1.0</td>
    </tr>
  </tbody>
</table>
<p>103727 rows × 9 columns</p>
</div></div></div>
</div>
<p>Another useful operation for transforming columns in a read query is <code class="docutils literal notranslate"><span class="pre">CASE</span></code>, which maps numeric values to categories. The syntax that uses <code class="docutils literal notranslate"><span class="pre">CASE</span></code> within <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">CASE</span>
    <span class="n">WHEN</span> <span class="n">logicalstatement1</span> <span class="n">THEN</span> <span class="n">value1</span>
    <span class="n">WHEN</span> <span class="n">logicalstatement2</span> <span class="n">THEN</span> <span class="n">value2</span>
    <span class="n">WHEN</span> <span class="n">logicalstatement3</span> <span class="n">THEN</span> <span class="n">value3</span>
    <span class="n">ELSE</span> <span class="n">value4</span>
    <span class="n">END</span> <span class="n">AS</span> <span class="n">name</span>
</pre></div>
</div>
<p>This code evaluates each logical statement, and fills in the datapoint with the specified value if the logical statement is true. If more than one of the logical statements is true, then the first statement/value pair entered in takes precedence. If none of the logical statements are true, then the datapoint is filled in with the value listed with <code class="docutils literal notranslate"><span class="pre">ELSE</span></code>. As before, it is important to name the new column with <code class="docutils literal notranslate"><span class="pre">AS</span></code>.</p>
<p>For example, if we want to categorize wines as cheap when the price is under 20 dollars, moderately priced if the price is between 20 and 50 dollars, and expensive if the price is more than 50 dollars, we can type:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT title, variety, price, CASE</span>
<span class="s2">    WHEN price &lt; 20 THEN &#39;cheap&#39;</span>
<span class="s2">    WHEN price BETWEEN 20 AND 50 THEN &#39;moderately priced&#39;</span>
<span class="s2">    WHEN price &gt; 50 THEN &#39;expensive&#39;</span>
<span class="s2">    ELSE NULL</span>
<span class="s2">    END AS price_level</span>
<span class="s2">FROM reviews;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>variety</th>
      <th>price</th>
      <th>price_level</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Casas del Bosque 2011 Reserva Sauvignon Blanc ...</td>
      <td>Sauvignon Blanc</td>
      <td>12.0</td>
      <td>cheap</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Marqués de Terán 2009 Selección Especial  (Rioja)</td>
      <td>Tempranillo</td>
      <td>24.0</td>
      <td>moderately priced</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Maurice Ecard 2009  Bourgogne</td>
      <td>Chardonnay</td>
      <td>NaN</td>
      <td>None</td>
    </tr>
    <tr>
      <th>3</th>
      <td>McGregor 2010 Semi-Dry Riesling (Finger Lakes)</td>
      <td>Riesling</td>
      <td>18.0</td>
      <td>cheap</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Jules Taylor 2009 Ballochdale Estate Pinot Noi...</td>
      <td>Pinot Noir</td>
      <td>22.0</td>
      <td>moderately priced</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>103722</th>
      <td>Glenora 2010 Gewürztraminer (Finger Lakes)</td>
      <td>Gewürztraminer</td>
      <td>15.0</td>
      <td>cheap</td>
    </tr>
    <tr>
      <th>103723</th>
      <td>Hard Row To Hoe 2010 Marsanne (Yakima Valley)</td>
      <td>Marsanne</td>
      <td>18.0</td>
      <td>cheap</td>
    </tr>
    <tr>
      <th>103724</th>
      <td>Animale 2009 Dolcetto (Columbia Valley (WA))</td>
      <td>Dolcetto</td>
      <td>24.0</td>
      <td>moderately priced</td>
    </tr>
    <tr>
      <th>103725</th>
      <td>Beresan 2008 The Buzz Yellow Jacket Vineyard R...</td>
      <td>Red Blend</td>
      <td>19.0</td>
      <td>cheap</td>
    </tr>
    <tr>
      <th>103726</th>
      <td>Cabot Vineyards 2007 Syrah (Humboldt County)</td>
      <td>Syrah</td>
      <td>24.0</td>
      <td>moderately priced</td>
    </tr>
  </tbody>
</table>
<p>103727 rows × 4 columns</p>
</div></div></div>
</div>
<p>There’s an important <strong>point of caution</strong> when using <code class="docutils literal notranslate"><span class="pre">CASE</span></code>. Unless you account for missing values explicity in your query, the missing values will be matched to the entered last in <code class="docutils literal notranslate"><span class="pre">CASE</span></code>. That will corrupt the data. It is best practice to write conditions for the full set of observed values of a column, and to end the call to <code class="docutils literal notranslate"><span class="pre">CASE</span></code> with <code class="docutils literal notranslate"><span class="pre">ELSE</span> <span class="pre">NULL</span></code>, so that when none of the conditions apply, the new column is also missing.</p>
<p>There are also functions that apply to columns with <a class="reference external" href="https://www.geeksforgeeks.org/sql-character-functions-examples/">character</a> values:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">LOWER(a)</span></code> - converts all characters in <code class="docutils literal notranslate"><span class="pre">a</span></code> to lowercase</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">UPPER(a)</span></code> - converts all characters in <code class="docutils literal notranslate"><span class="pre">a</span></code> to uppercase</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">INITCAP(a)</span></code> - converts the first letter of every word in <code class="docutils literal notranslate"><span class="pre">a</span></code> to uppercase</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CONCAT(a,b,c)</span></code> - appends the string <code class="docutils literal notranslate"><span class="pre">b</span></code> to the end of <code class="docutils literal notranslate"><span class="pre">a</span></code>, and <code class="docutils literal notranslate"><span class="pre">c</span></code> (if included) to the end of <code class="docutils literal notranslate"><span class="pre">b</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LENGTH(a)</span></code> - reports the number of characters in the string <code class="docutils literal notranslate"><span class="pre">a</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SUBSTR(a,</span> <span class="pre">start,</span> <span class="pre">length)</span></code> - restricts the string <code class="docutils literal notranslate"><span class="pre">a</span></code> to a substring, beginning at the position denoted by <code class="docutils literal notranslate"><span class="pre">start</span></code>, and including the next <code class="docutils literal notranslate"><span class="pre">length</span></code> characters</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TRIM(a)</span></code> - removes spaces at the beginning and end of string <code class="docutils literal notranslate"><span class="pre">a</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">REPLACE(a,</span> <span class="pre">oldtext,</span> <span class="pre">newtext)</span></code> - searches values of <code class="docutils literal notranslate"><span class="pre">a</span></code> for occurrences of <code class="docutils literal notranslate"><span class="pre">oldtext</span></code> and replaces them with <code class="docutils literal notranslate"><span class="pre">newtext</span></code></p></li>
</ul>
<p>For example, we can replace the descriptions in the reviews table with all capitals, all lower-case letters, or capitals for the first letter of each word:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT title, variety, price, </span>
<span class="s2">    UPPER(description) as description_upper, </span>
<span class="s2">    LOWER(description) as description_lower, </span>
<span class="s2">    INITCAP(description) as description_initcap </span>
<span class="s2">FROM reviews;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>variety</th>
      <th>price</th>
      <th>description_upper</th>
      <th>description_lower</th>
      <th>description_initcap</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Casas del Bosque 2011 Reserva Sauvignon Blanc ...</td>
      <td>Sauvignon Blanc</td>
      <td>12.0</td>
      <td>IT'S PRETTY EASY PEGGING THIS FOR CHILEAN SB; ...</td>
      <td>it's pretty easy pegging this for chilean sb; ...</td>
      <td>It'S Pretty Easy Pegging This For Chilean Sb; ...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Marqués de Terán 2009 Selección Especial  (Rioja)</td>
      <td>Tempranillo</td>
      <td>24.0</td>
      <td>OPAQUE IN COLOR, WITH BLACKBERRY AND LICORICE ...</td>
      <td>opaque in color, with blackberry and licorice ...</td>
      <td>Opaque In Color, With Blackberry And Licorice ...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Maurice Ecard 2009  Bourgogne</td>
      <td>Chardonnay</td>
      <td>NaN</td>
      <td>ATTRACTIVE RIPE FRUITS GO WITH LIME AND TOAST ...</td>
      <td>attractive ripe fruits go with lime and toast ...</td>
      <td>Attractive Ripe Fruits Go With Lime And Toast ...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>McGregor 2010 Semi-Dry Riesling (Finger Lakes)</td>
      <td>Riesling</td>
      <td>18.0</td>
      <td>SMOKY AND A BIT STARK WITH WHIFFS OF STRUCK FL...</td>
      <td>smoky and a bit stark with whiffs of struck fl...</td>
      <td>Smoky And A Bit Stark With Whiffs Of Struck Fl...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Jules Taylor 2009 Ballochdale Estate Pinot Noi...</td>
      <td>Pinot Noir</td>
      <td>22.0</td>
      <td>SOURCED FROM A HIGH-ALTITUDE VINEYARD NEAR THE...</td>
      <td>sourced from a high-altitude vineyard near the...</td>
      <td>Sourced From A High-Altitude Vineyard Near The...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>103722</th>
      <td>Glenora 2010 Gewürztraminer (Finger Lakes)</td>
      <td>Gewürztraminer</td>
      <td>15.0</td>
      <td>SWEET ON THE NOSE, WITH SCENTS OF PINK GRAPEFR...</td>
      <td>sweet on the nose, with scents of pink grapefr...</td>
      <td>Sweet On The Nose, With Scents Of Pink Grapefr...</td>
    </tr>
    <tr>
      <th>103723</th>
      <td>Hard Row To Hoe 2010 Marsanne (Yakima Valley)</td>
      <td>Marsanne</td>
      <td>18.0</td>
      <td>WAXY FRUIT FLAVORS OF PEACH, MELON AND BANANA,...</td>
      <td>waxy fruit flavors of peach, melon and banana,...</td>
      <td>Waxy Fruit Flavors Of Peach, Melon And Banana,...</td>
    </tr>
    <tr>
      <th>103724</th>
      <td>Animale 2009 Dolcetto (Columbia Valley (WA))</td>
      <td>Dolcetto</td>
      <td>24.0</td>
      <td>THIS ALCOHOLIC WINE (15.9%, AND YOU CAN TASTE ...</td>
      <td>this alcoholic wine (15.9%, and you can taste ...</td>
      <td>This Alcoholic Wine (15.9%, And You Can Taste ...</td>
    </tr>
    <tr>
      <th>103725</th>
      <td>Beresan 2008 The Buzz Yellow Jacket Vineyard R...</td>
      <td>Red Blend</td>
      <td>19.0</td>
      <td>LIGHT FRUIT FLAVORS RUN FROM MELON INTO PALE S...</td>
      <td>light fruit flavors run from melon into pale s...</td>
      <td>Light Fruit Flavors Run From Melon Into Pale S...</td>
    </tr>
    <tr>
      <th>103726</th>
      <td>Cabot Vineyards 2007 Syrah (Humboldt County)</td>
      <td>Syrah</td>
      <td>24.0</td>
      <td>FROM HUSBAND-AND-WIFE TEAM IN CALIFORNIA REDWO...</td>
      <td>from husband-and-wife team in california redwo...</td>
      <td>From Husband-And-Wife Team In California Redwo...</td>
    </tr>
  </tbody>
</table>
<p>103727 rows × 6 columns</p>
</div></div></div>
</div>
<p>We can use <code class="docutils literal notranslate"><span class="pre">REPLACE()</span></code> to make the writing less artful, for example, by replacing the word “aroma” with “good smell” everywhere it appears in the wine descriptions. Note that <code class="docutils literal notranslate"><span class="pre">REPLACE()</span></code> is case-sensitive, so it is a good idea to convert the values to a consistent case like lowercase first:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT title, variety, price, description,</span>
<span class="s2">    REPLACE(LOWER(description), &#39;aroma&#39;, &#39;good smell&#39;) as description_replace </span>
<span class="s2">FROM reviews</span>
<span class="s2">WHERE description LIKE &#39;</span><span class="si">%%</span><span class="s2">aroma</span><span class="si">%%</span><span class="s2">&#39;;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span><span class="o">.</span><span class="n">description</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Opaque in color, with blackberry and licorice aromas but also a distinct streak of brambly herbs and green. Later on, pine needle and tartness enter the fray. This is a commendable modern Rioja but it does have a few issues, namely a green herbal component.&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span><span class="o">.</span><span class="n">description_replace</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;opaque in color, with blackberry and licorice good smells but also a distinct streak of brambly herbs and green. later on, pine needle and tartness enter the fray. this is a commendable modern rioja but it does have a few issues, namely a green herbal component.&#39;
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">SUBSTR()</span></code> function can be used to extract parts of a string. The following code reduces the <code class="docutils literal notranslate"><span class="pre">description</span></code> column to substrings beginning at the 5th character and proceeding 10 characters in length:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT title, variety, price, description,</span>
<span class="s2">    SUBSTR(description, 5, 10) as description_substr </span>
<span class="s2">FROM reviews;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>variety</th>
      <th>price</th>
      <th>description</th>
      <th>description_substr</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Casas del Bosque 2011 Reserva Sauvignon Blanc ...</td>
      <td>Sauvignon Blanc</td>
      <td>12.0</td>
      <td>It's pretty easy pegging this for Chilean SB; ...</td>
      <td>pretty ea</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Marqués de Terán 2009 Selección Especial  (Rioja)</td>
      <td>Tempranillo</td>
      <td>24.0</td>
      <td>Opaque in color, with blackberry and licorice ...</td>
      <td>ue in colo</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Maurice Ecard 2009  Bourgogne</td>
      <td>Chardonnay</td>
      <td>NaN</td>
      <td>Attractive ripe fruits go with lime and toast ...</td>
      <td>active rip</td>
    </tr>
    <tr>
      <th>3</th>
      <td>McGregor 2010 Semi-Dry Riesling (Finger Lakes)</td>
      <td>Riesling</td>
      <td>18.0</td>
      <td>Smoky and a bit stark with whiffs of struck fl...</td>
      <td>y and a bi</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Jules Taylor 2009 Ballochdale Estate Pinot Noi...</td>
      <td>Pinot Noir</td>
      <td>22.0</td>
      <td>Sourced from a high-altitude vineyard near the...</td>
      <td>ced from a</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>103722</th>
      <td>Glenora 2010 Gewürztraminer (Finger Lakes)</td>
      <td>Gewürztraminer</td>
      <td>15.0</td>
      <td>Sweet on the nose, with scents of pink grapefr...</td>
      <td>t on the n</td>
    </tr>
    <tr>
      <th>103723</th>
      <td>Hard Row To Hoe 2010 Marsanne (Yakima Valley)</td>
      <td>Marsanne</td>
      <td>18.0</td>
      <td>Waxy fruit flavors of peach, melon and banana,...</td>
      <td>fruit fla</td>
    </tr>
    <tr>
      <th>103724</th>
      <td>Animale 2009 Dolcetto (Columbia Valley (WA))</td>
      <td>Dolcetto</td>
      <td>24.0</td>
      <td>This alcoholic wine (15.9%, and you can taste ...</td>
      <td>alcoholic</td>
    </tr>
    <tr>
      <th>103725</th>
      <td>Beresan 2008 The Buzz Yellow Jacket Vineyard R...</td>
      <td>Red Blend</td>
      <td>19.0</td>
      <td>Light fruit flavors run from melon into pale s...</td>
      <td>t fruit fl</td>
    </tr>
    <tr>
      <th>103726</th>
      <td>Cabot Vineyards 2007 Syrah (Humboldt County)</td>
      <td>Syrah</td>
      <td>24.0</td>
      <td>From husband-and-wife team in California redwo...</td>
      <td>husband-a</td>
    </tr>
  </tbody>
</table>
<p>103727 rows × 5 columns</p>
</div></div></div>
</div>
<p>In the wine database, province and country are stored in separate columns in the locations table. If we wanted to put these two pieces of information together in one readable column, we can use <code class="docutils literal notranslate"><span class="pre">CONCAT()</span></code>. In this example, I type <code class="docutils literal notranslate"><span class="pre">CONCAT(l.province,</span> <span class="pre">',</span> <span class="pre">',</span> <span class="pre">l.country)</span></code> which appends three strings - the province from the locations table, a comma and a space, and the country from the locations table - and names the new column <code class="docutils literal notranslate"><span class="pre">place</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT r.title, r.variety, r.price, </span>
<span class="s2">    CONCAT(l.province, &#39;, &#39;, l.country) as place </span>
<span class="s2">FROM reviews r</span>
<span class="s2">INNER JOIN locations l</span>
<span class="s2">    ON r.location_id = l.location_id;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>variety</th>
      <th>price</th>
      <th>place</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Casas del Bosque 2011 Reserva Sauvignon Blanc ...</td>
      <td>Sauvignon Blanc</td>
      <td>12.0</td>
      <td>Casablanca Valley, Chile</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Marqués de Terán 2009 Selección Especial  (Rioja)</td>
      <td>Tempranillo</td>
      <td>24.0</td>
      <td>Northern Spain, Spain</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Maurice Ecard 2009  Bourgogne</td>
      <td>Chardonnay</td>
      <td>NaN</td>
      <td>Burgundy, France</td>
    </tr>
    <tr>
      <th>3</th>
      <td>McGregor 2010 Semi-Dry Riesling (Finger Lakes)</td>
      <td>Riesling</td>
      <td>18.0</td>
      <td>New York, US</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Jules Taylor 2009 Ballochdale Estate Pinot Noi...</td>
      <td>Pinot Noir</td>
      <td>22.0</td>
      <td>Marlborough, New Zealand</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>103722</th>
      <td>Glenora 2010 Gewürztraminer (Finger Lakes)</td>
      <td>Gewürztraminer</td>
      <td>15.0</td>
      <td>New York, US</td>
    </tr>
    <tr>
      <th>103723</th>
      <td>Hard Row To Hoe 2010 Marsanne (Yakima Valley)</td>
      <td>Marsanne</td>
      <td>18.0</td>
      <td>Washington, US</td>
    </tr>
    <tr>
      <th>103724</th>
      <td>Animale 2009 Dolcetto (Columbia Valley (WA))</td>
      <td>Dolcetto</td>
      <td>24.0</td>
      <td>Washington, US</td>
    </tr>
    <tr>
      <th>103725</th>
      <td>Beresan 2008 The Buzz Yellow Jacket Vineyard R...</td>
      <td>Red Blend</td>
      <td>19.0</td>
      <td>Washington, US</td>
    </tr>
    <tr>
      <th>103726</th>
      <td>Cabot Vineyards 2007 Syrah (Humboldt County)</td>
      <td>Syrah</td>
      <td>24.0</td>
      <td>California, US</td>
    </tr>
  </tbody>
</table>
<p>103727 rows × 4 columns</p>
</div></div></div>
</div>
<p>What are the shortest descriptions in the data? To find out we use the <code class="docutils literal notranslate"><span class="pre">LENGTH()</span></code> function to count the number of characters in each description, and sort these lengths in ascending order:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT title, points, price, description,</span>
<span class="s2">    LENGTH(description) as length</span>
<span class="s2">FROM reviews</span>
<span class="s2">ORDER BY length ASC;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>points</th>
      <th>price</th>
      <th>description</th>
      <th>length</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Craggy Range 2007 Kidnappers Vineyard Chardonn...</td>
      <td>88</td>
      <td>24.0</td>
      <td>Imported by Kobrand.</td>
      <td>20</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Chasing Venus 2007 Sauvignon Blanc (Marlborough)</td>
      <td>88</td>
      <td>16.0</td>
      <td>Imported by JL Giguiere.</td>
      <td>24</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Philip Shaw 2007 No. 19 Sauvignon Blanc (Orange)</td>
      <td>86</td>
      <td>20.0</td>
      <td>Imported by Lion Nathan USA.</td>
      <td>28</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Peconic Bay Winery 2001 Riesling (North Fork o...</td>
      <td>84</td>
      <td>13.0</td>
      <td>Review not available at this time.</td>
      <td>34</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Mount Baker Vineyards 2006 Barrel Select Sangi...</td>
      <td>82</td>
      <td>16.0</td>
      <td>Very light, could almost be a rosé.</td>
      <td>35</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>103722</th>
      <td>René Muré 2015 Clos Saint Landelin Vorbourg Gr...</td>
      <td>97</td>
      <td>50.0</td>
      <td>The heady aromatic scent of fresh tangerine pe...</td>
      <td>698</td>
    </tr>
    <tr>
      <th>103723</th>
      <td>Domaine Marcel Deiss 2009 Altenberg de Berghei...</td>
      <td>95</td>
      <td>66.0</td>
      <td>Lifted notes of dried pear, dried chamomile fl...</td>
      <td>699</td>
    </tr>
    <tr>
      <th>103724</th>
      <td>De Toren 2014 Book 17 XVII Red (Stellenbosch)</td>
      <td>95</td>
      <td>330.0</td>
      <td>Only 95 cases were made of this Bordeaux-style...</td>
      <td>723</td>
    </tr>
    <tr>
      <th>103725</th>
      <td>Domaine Ostertag 2015 Muenchberg Grand Cru Rie...</td>
      <td>97</td>
      <td>66.0</td>
      <td>There is something incredibly fruity and simul...</td>
      <td>753</td>
    </tr>
    <tr>
      <th>103726</th>
      <td>Saggi 2007 Red (Columbia Valley (WA))</td>
      <td>91</td>
      <td>45.0</td>
      <td>Dark, dusty, strongly scented with barrel toas...</td>
      <td>829</td>
    </tr>
  </tbody>
</table>
<p>103727 rows × 5 columns</p>
</div></div></div>
</div>
</section>
<section id="data-aggregation">
<h3><a class="toc-backref" href="#id29" role="doc-backlink"><span class="section-number">7.6.7. </span>Data Aggregation</a><a class="headerlink" href="#data-aggregation" title="Permalink to this heading">#</a></h3>
<p>If there are columns in the data output that have repeated values, then each distinct value forms a group in the data. Data aggregation is the process of collapsing the data to one row for each group, while summarizing other columns by taking the within-group mean, sum, count, or another statistic.</p>
<p>Aggregating data requires more attention to the ordering of the clauses in an SQL query than is necessary with other tasks. That is, certain clauses must be entered into the query in a particular order. An SQL query that aggregates data should follow this template:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">aggregationfunctions</span> <span class="n">FROM</span> <span class="n">table</span>
<span class="p">(</span><span class="nb">any</span> <span class="n">joins</span> <span class="n">happen</span> <span class="n">here</span><span class="p">)</span>
<span class="p">(</span><span class="n">filtering</span> <span class="n">rows</span> <span class="k">with</span> <span class="n">the</span> <span class="n">WHERE</span> <span class="n">clause</span> <span class="n">happens</span> <span class="n">here</span><span class="p">)</span>
<span class="n">GROUP</span> <span class="n">BY</span> <span class="n">groupingcolumns</span>
<span class="n">HAVING</span> <span class="p">(</span><span class="n">a</span> <span class="n">logical</span> <span class="n">condition</span> <span class="n">involving</span> <span class="n">aggregation</span> <span class="n">functions</span><span class="p">)</span>
<span class="p">(</span><span class="n">sorting</span> <span class="k">with</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">happens</span> <span class="n">here</span><span class="p">);</span>
</pre></div>
</div>
<p>Let’s break down this template line by line. First,</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">aggregationfunctions</span> <span class="pre">FROM</span> <span class="pre">table</span></code></p></li>
</ul>
<p>Aggregation functions work like the arithmetic functions described above. The difference is that instead of working with a single value, like <code class="docutils literal notranslate"><span class="pre">SQRT()</span></code> and <code class="docutils literal notranslate"><span class="pre">POWER()</span></code> do, aggregation functions work with vectors of data and generate summary statistics. They describe how existing columns should be summarized when the data are collapsed. The aggregation functions are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">COUNT(*)</span></code> - an overall count of the number of rows within each group</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">COUNT(a)</span></code> - a count of the number of non-missing observations of column <code class="docutils literal notranslate"><span class="pre">a</span></code> within each group</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">COUNT(DISTINCT</span> <span class="pre">a)</span></code> - a count of the number of distinct observations of column <code class="docutils literal notranslate"><span class="pre">a</span></code> within each group</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AVG(a)</span></code> - the mean of the values of <code class="docutils literal notranslate"><span class="pre">a</span></code> within each group</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SUM(a)</span></code> - the sum of the values of <code class="docutils literal notranslate"><span class="pre">a</span></code> within each group</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MAX(a)</span></code>- the maximum value of <code class="docutils literal notranslate"><span class="pre">a</span></code> within each group</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MIN(a)</span></code>- the minimum value of <code class="docutils literal notranslate"><span class="pre">a</span></code> within each group</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VARIANCE(a)</span></code> and <code class="docutils literal notranslate"><span class="pre">VAR_SAMP(a)</span></code> - the population and sample variances, respectively, of the values of <code class="docutils literal notranslate"><span class="pre">a</span></code> within each group</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">STDDEV(a)</span></code> and <code class="docutils literal notranslate"><span class="pre">STDDEV_SAMP(a)</span></code> - the population and sample standard deviations, respectively, of the values of <code class="docutils literal notranslate"><span class="pre">a</span></code> within each group</p></li>
</ul>
<p>Additional statistics, like the median, mode, and various quantiles are not included in standard SQL but are available in extensions that are specific to a DBMS, such as the <a class="reference external" href="https://pgxn.org/dist/quantile/">quantile extension</a> for PostgreSQL.</p>
<p>One important point about the aggregation functions is that, with the exception of <code class="docutils literal notranslate"><span class="pre">COUNT()</span></code>, they <strong>ignore NULL values</strong>. Suppose that we have a data vector with values (1,3,8,NULL). Because we do not know the value of the fourth value, we cannot calculate the true sum and true mean of the values. However the <code class="docutils literal notranslate"><span class="pre">SUM()</span></code> function in SQL ignores the NULL value and reports the sum as 12, which makes a strong tacit assumption that the NULL value is equal to 0. The <code class="docutils literal notranslate"><span class="pre">AVG()</span></code> function calculates the mean from the observed values, and reports (1+3+8)/3 = 4, but this too makes a strong assumption that the NULL value is exactly 4. There are situations in which calculations from the non-NULL values are appropriate, but it is not correct to make broad claims from these summary statistics when there are missing values in the columns being summarized.</p>
<p>The next two lines in the template are placeholders for the syntax we use to join data tables and the syntax we use to filter rows with the <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause. There is a great deal of similarity between <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> and <code class="docutils literal notranslate"><span class="pre">HAVING</span></code>, which we will discuss shortly.</p>
<p>The fourth line in the template,</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span> <span class="pre">groupingcolumns</span></code></p></li>
</ul>
<p>is the key line for activating the aggregation functionality of SQL. <code class="docutils literal notranslate"><span class="pre">groupingcolumns</span></code> can include one or more columns. If one column is listed, the unique values of that column define the groups that will comprise the rows of the output data. If there is more than one column listed, the unique combinations of values from the columns define the groups.</p>
<p>The fifth line in the template uses the <code class="docutils literal notranslate"><span class="pre">HAVING</span></code> clause. <code class="docutils literal notranslate"><span class="pre">HAVING</span></code> is very similar to <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> in that both use logical conditions to identify a selection of the rows to include in the output data. The difference between <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> and <code class="docutils literal notranslate"><span class="pre">HAVING</span></code> is that <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> operates on rows in the original data prior to aggregation, and <code class="docutils literal notranslate"><span class="pre">HAVING</span></code> works on rows after aggregation has occurred. One limitation of <code class="docutils literal notranslate"><span class="pre">HAVING</span></code> is that it will not recognize new column names defined in <code class="docutils literal notranslate"><span class="pre">SELECT</span></code>, so the same aggregation functions used in <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> need to be used again in the logical conditions for <code class="docutils literal notranslate"><span class="pre">HAVING</span></code>. Finally, if we want to sort, we can include the <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span></code> clause last.</p>
<p>For example, let’s find out which country produces wines with the highest average score. To do that, we need a query that joins reviews and locations together, includes country name, the average score across wines from that country, and for good measure, a count of the number of wines reviewed from that country. To collapse on country, we can use <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code>, and to produce the average score and the count of wines we use the <code class="docutils literal notranslate"><span class="pre">AVG()</span></code> and <code class="docutils literal notranslate"><span class="pre">COUNT()</span></code> functions. For presentation purposes, I choose to round the average score to one decimal and to sort the rows from the highest to lowest average score, so that we can immediately see which countries produce the highest-rated wines. The query is:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT l.country,</span>
<span class="s2">    ROUND(AVG(points),1) as average_points,</span>
<span class="s2">    COUNT(*) as numberofwines</span>
<span class="s2">FROM reviews r</span>
<span class="s2">INNER JOIN locations l</span>
<span class="s2">    ON r.location_id = l.location_id</span>
<span class="s2">GROUP BY l.country</span>
<span class="s2">ORDER BY average_points DESC;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>country</th>
      <th>average_points</th>
      <th>numberofwines</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>England</td>
      <td>91.6</td>
      <td>74</td>
    </tr>
    <tr>
      <th>1</th>
      <td>India</td>
      <td>90.2</td>
      <td>9</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Austria</td>
      <td>90.1</td>
      <td>3337</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Germany</td>
      <td>89.9</td>
      <td>2134</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Canada</td>
      <td>89.4</td>
      <td>256</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Hungary</td>
      <td>89.2</td>
      <td>145</td>
    </tr>
    <tr>
      <th>6</th>
      <td>China</td>
      <td>89.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>7</th>
      <td>US</td>
      <td>89.0</td>
      <td>37730</td>
    </tr>
    <tr>
      <th>8</th>
      <td>France</td>
      <td>88.9</td>
      <td>21828</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Italy</td>
      <td>88.8</td>
      <td>11042</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Australia</td>
      <td>88.8</td>
      <td>2037</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Luxembourg</td>
      <td>88.7</td>
      <td>6</td>
    </tr>
    <tr>
      <th>12</th>
      <td>None</td>
      <td>88.6</td>
      <td>63</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Morocco</td>
      <td>88.6</td>
      <td>28</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Switzerland</td>
      <td>88.6</td>
      <td>7</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Israel</td>
      <td>88.5</td>
      <td>500</td>
    </tr>
    <tr>
      <th>16</th>
      <td>New Zealand</td>
      <td>88.3</td>
      <td>1311</td>
    </tr>
    <tr>
      <th>17</th>
      <td>South Africa</td>
      <td>88.2</td>
      <td>1328</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Portugal</td>
      <td>88.2</td>
      <td>5686</td>
    </tr>
    <tr>
      <th>19</th>
      <td>Slovenia</td>
      <td>88.1</td>
      <td>87</td>
    </tr>
    <tr>
      <th>20</th>
      <td>Turkey</td>
      <td>88.1</td>
      <td>90</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Bulgaria</td>
      <td>87.9</td>
      <td>141</td>
    </tr>
    <tr>
      <th>22</th>
      <td>Georgia</td>
      <td>87.7</td>
      <td>86</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Lebanon</td>
      <td>87.7</td>
      <td>35</td>
    </tr>
    <tr>
      <th>24</th>
      <td>Armenia</td>
      <td>87.5</td>
      <td>2</td>
    </tr>
    <tr>
      <th>25</th>
      <td>Serbia</td>
      <td>87.5</td>
      <td>12</td>
    </tr>
    <tr>
      <th>26</th>
      <td>Czech Republic</td>
      <td>87.3</td>
      <td>12</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Greece</td>
      <td>87.3</td>
      <td>466</td>
    </tr>
    <tr>
      <th>28</th>
      <td>Spain</td>
      <td>87.3</td>
      <td>6581</td>
    </tr>
    <tr>
      <th>29</th>
      <td>Moldova</td>
      <td>87.2</td>
      <td>59</td>
    </tr>
    <tr>
      <th>30</th>
      <td>Croatia</td>
      <td>87.2</td>
      <td>73</td>
    </tr>
    <tr>
      <th>31</th>
      <td>Cyprus</td>
      <td>87.2</td>
      <td>11</td>
    </tr>
    <tr>
      <th>32</th>
      <td>Slovakia</td>
      <td>87.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>33</th>
      <td>Uruguay</td>
      <td>86.8</td>
      <td>109</td>
    </tr>
    <tr>
      <th>34</th>
      <td>Macedonia</td>
      <td>86.8</td>
      <td>12</td>
    </tr>
    <tr>
      <th>35</th>
      <td>Argentina</td>
      <td>86.7</td>
      <td>3797</td>
    </tr>
    <tr>
      <th>36</th>
      <td>Bosnia and Herzegovina</td>
      <td>86.5</td>
      <td>2</td>
    </tr>
    <tr>
      <th>37</th>
      <td>Chile</td>
      <td>86.5</td>
      <td>4361</td>
    </tr>
    <tr>
      <th>38</th>
      <td>Romania</td>
      <td>86.4</td>
      <td>120</td>
    </tr>
    <tr>
      <th>39</th>
      <td>Mexico</td>
      <td>85.3</td>
      <td>65</td>
    </tr>
    <tr>
      <th>40</th>
      <td>Brazil</td>
      <td>84.7</td>
      <td>52</td>
    </tr>
    <tr>
      <th>41</th>
      <td>Ukraine</td>
      <td>84.1</td>
      <td>14</td>
    </tr>
    <tr>
      <th>42</th>
      <td>Egypt</td>
      <td>84.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>43</th>
      <td>Peru</td>
      <td>83.6</td>
      <td>16</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>So the country that produces the best wine is … England? Wait, that can’t be right. Looking at the results, I see that some of the countries only have a small number of wines reviewed. China, for example, only has one wine review in the database, so we definitely should not put as much confidence in China’s mean score as we can for countries with many more reviews like France and the U.S. For a more fair comparison, let’s restrict the output to only those countries with at least 500 wines in the database. To filter rows on this condition, we use <code class="docutils literal notranslate"><span class="pre">HAVING</span></code> and not <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> because the condition involves an aggregation function - specifically the count of the number of wines per country. We can rerun the previous query, including the <code class="docutils literal notranslate"><span class="pre">HAVING</span></code> clause:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT l.country,</span>
<span class="s2">    ROUND(AVG(points),1) as average_points,</span>
<span class="s2">    COUNT(*) as numberofwines</span>
<span class="s2">FROM reviews r</span>
<span class="s2">INNER JOIN locations l</span>
<span class="s2">    ON r.location_id = l.location_id</span>
<span class="s2">GROUP BY l.country</span>
<span class="s2">    HAVING COUNT(*) &gt;= 500</span>
<span class="s2">ORDER BY average_points DESC;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>country</th>
      <th>average_points</th>
      <th>numberofwines</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Austria</td>
      <td>90.1</td>
      <td>3337</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Germany</td>
      <td>89.9</td>
      <td>2134</td>
    </tr>
    <tr>
      <th>2</th>
      <td>US</td>
      <td>89.0</td>
      <td>37730</td>
    </tr>
    <tr>
      <th>3</th>
      <td>France</td>
      <td>88.9</td>
      <td>21828</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Italy</td>
      <td>88.8</td>
      <td>11042</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Australia</td>
      <td>88.8</td>
      <td>2037</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Israel</td>
      <td>88.5</td>
      <td>500</td>
    </tr>
    <tr>
      <th>7</th>
      <td>New Zealand</td>
      <td>88.3</td>
      <td>1311</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Portugal</td>
      <td>88.2</td>
      <td>5686</td>
    </tr>
    <tr>
      <th>9</th>
      <td>South Africa</td>
      <td>88.2</td>
      <td>1328</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Spain</td>
      <td>87.3</td>
      <td>6581</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Argentina</td>
      <td>86.7</td>
      <td>3797</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Chile</td>
      <td>86.5</td>
      <td>4361</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Suppose we were interested in ranking the countries according to their scores for a particular type of wine. To filter rows from the original data, we use a <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause prior to <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code>. If we write <code class="docutils literal notranslate"><span class="pre">WHERE</span> <span class="pre">r.variety</span> <span class="pre">=</span> <span class="pre">'Riesling'</span></code> prior to <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code>, the DBMS first extracts only the rows from the reviews table that refer to Riesling wines, then proceeds with the rest of the query. The following code ranks the countries based on their average scores for Rieslings, given at least 100 Rieslings from that country in the database:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT l.country,</span>
<span class="s2">    ROUND(AVG(points),1) as average_points,</span>
<span class="s2">    COUNT(*) as numberofwines</span>
<span class="s2">FROM reviews r</span>
<span class="s2">INNER JOIN locations l</span>
<span class="s2">    ON r.location_id = l.location_id</span>
<span class="s2">WHERE r.variety = &#39;Riesling&#39;</span>
<span class="s2">GROUP BY l.country</span>
<span class="s2">    HAVING COUNT(*) &gt;= 100</span>
<span class="s2">ORDER BY average_points DESC;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>country</th>
      <th>average_points</th>
      <th>numberofwines</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Austria</td>
      <td>91.4</td>
      <td>581</td>
    </tr>
    <tr>
      <th>1</th>
      <td>France</td>
      <td>90.5</td>
      <td>691</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Germany</td>
      <td>90.1</td>
      <td>1768</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Australia</td>
      <td>89.4</td>
      <td>111</td>
    </tr>
    <tr>
      <th>4</th>
      <td>US</td>
      <td>88.1</td>
      <td>1600</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Sometimes the groups in the data are formed by more than one column. In that case, simply add the second column name to the <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> clause. For example, if we wanted to know the top rated combination of country and variety (with a minimum of 50 wines for that combination), we can use the following code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT l.country, r.variety,</span>
<span class="s2">    ROUND(AVG(points),1) as average_points,</span>
<span class="s2">    COUNT(*) as numberofwines</span>
<span class="s2">FROM reviews r</span>
<span class="s2">INNER JOIN locations l</span>
<span class="s2">    ON r.location_id = l.location_id</span>
<span class="s2">GROUP BY l.country, r.variety</span>
<span class="s2">    HAVING COUNT(*) &gt;= 50</span>
<span class="s2">ORDER BY average_points DESC;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>country</th>
      <th>variety</th>
      <th>average_points</th>
      <th>numberofwines</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>France</td>
      <td>Tannat</td>
      <td>91.5</td>
      <td>59</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Austria</td>
      <td>Riesling</td>
      <td>91.4</td>
      <td>581</td>
    </tr>
    <tr>
      <th>2</th>
      <td>South Africa</td>
      <td>Bordeaux-style Red Blend</td>
      <td>90.6</td>
      <td>84</td>
    </tr>
    <tr>
      <th>3</th>
      <td>France</td>
      <td>Riesling</td>
      <td>90.5</td>
      <td>691</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Austria</td>
      <td>Chardonnay</td>
      <td>90.4</td>
      <td>62</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>190</th>
      <td>Argentina</td>
      <td>Chardonnay</td>
      <td>84.9</td>
      <td>295</td>
    </tr>
    <tr>
      <th>191</th>
      <td>Spain</td>
      <td>Rosé</td>
      <td>84.9</td>
      <td>149</td>
    </tr>
    <tr>
      <th>192</th>
      <td>Portugal</td>
      <td>Rosé</td>
      <td>84.6</td>
      <td>235</td>
    </tr>
    <tr>
      <th>193</th>
      <td>Spain</td>
      <td>Rosado</td>
      <td>84.6</td>
      <td>71</td>
    </tr>
    <tr>
      <th>194</th>
      <td>Argentina</td>
      <td>Sauvignon Blanc</td>
      <td>84.3</td>
      <td>78</td>
    </tr>
  </tbody>
</table>
<p>195 rows × 4 columns</p>
</div></div></div>
</div>
</section>
<section id="subqueries">
<h3><a class="toc-backref" href="#id30" role="doc-backlink"><span class="section-number">7.6.8. </span>Subqueries</a><a class="headerlink" href="#subqueries" title="Permalink to this heading">#</a></h3>
<p>There are situations in which it makes sense to use data aggregation techniques to generate new columns filled with group-level summary statistics, then to place these summary statistics into the original data table. To do this work, we can use <strong>subqueries</strong>. A subquery is a full SQL query that is used inside another SQL query. There are three types of subquery:</p>
<ol class="arabic simple">
<li><p>Subqueries, like the ones for the mean and standard deviation above, that yield a single datapoint. These subqueries can be used anywhere we might write a value in the query, such as when defining new columns in <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> or filtering rows with <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> or <code class="docutils literal notranslate"><span class="pre">HAVING</span></code>.</p></li>
<li><p>Subqueries that yield a list of values that can be used inside logical statements that include the <code class="docutils literal notranslate"><span class="pre">IN</span></code> operator.</p></li>
<li><p>Subqueries that yield a data table that can be joined to existing data tables.</p></li>
</ol>
<p>Suppose for example that we wanted to generate a Z-score standardized version of the wine review points. A Z-score subtracts the mean of a column from every value in the column, then divides every value by the standard deviation of the column. When a Z-score equals 1, it means that the original value is one standard deviation above the mean of the column. To calculate the Z-score, we need to calculate the mean of the points column,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT AVG(points) FROM reviews;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>avg</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>88.612107</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>and the sample standard deviation of the points column,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT STDDEV_SAMP(points) FROM reviews;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>stddev_samp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2.955039</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can type these values in manually with a query that looks like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">title</span><span class="p">,</span> <span class="n">variety</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span>
<span class="p">(</span><span class="n">points</span> <span class="o">-</span> <span class="mf">88.612107</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">2.955039</span><span class="p">)</span> <span class="k">as</span> <span class="n">points_z</span> 
<span class="n">FROM</span> <span class="n">reviews</span><span class="p">;</span>
</pre></div>
</div>
<p>The problem with typing these values in by hand is that it is easy to make a mistake and accidentially corrupt the <code class="docutils literal notranslate"><span class="pre">points_z</span></code> column because of a typo. Also these values will have to be changed by hand every time the data inside the database is updated. A better solution is to have SQL do the work of calculating the mean and standard deviation for us by using subqueries. All we need to do is replace the values with the queries (contained in parentheses) that generate those single values. In this case, the query is</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT title, variety, points,</span>
<span class="s2">(points - (SELECT AVG(points) FROM reviews))/(SELECT STDDEV(points) FROM reviews) as points_z </span>
<span class="s2">FROM reviews;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>variety</th>
      <th>points</th>
      <th>points_z</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Casas del Bosque 2011 Reserva Sauvignon Blanc ...</td>
      <td>Sauvignon Blanc</td>
      <td>86</td>
      <td>-0.88395</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Marqués de Terán 2009 Selección Especial  (Rioja)</td>
      <td>Tempranillo</td>
      <td>86</td>
      <td>-0.88395</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Maurice Ecard 2009  Bourgogne</td>
      <td>Chardonnay</td>
      <td>86</td>
      <td>-0.88395</td>
    </tr>
    <tr>
      <th>3</th>
      <td>McGregor 2010 Semi-Dry Riesling (Finger Lakes)</td>
      <td>Riesling</td>
      <td>86</td>
      <td>-0.88395</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Jules Taylor 2009 Ballochdale Estate Pinot Noi...</td>
      <td>Pinot Noir</td>
      <td>86</td>
      <td>-0.88395</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>103722</th>
      <td>Glenora 2010 Gewürztraminer (Finger Lakes)</td>
      <td>Gewürztraminer</td>
      <td>86</td>
      <td>-0.88395</td>
    </tr>
    <tr>
      <th>103723</th>
      <td>Hard Row To Hoe 2010 Marsanne (Yakima Valley)</td>
      <td>Marsanne</td>
      <td>86</td>
      <td>-0.88395</td>
    </tr>
    <tr>
      <th>103724</th>
      <td>Animale 2009 Dolcetto (Columbia Valley (WA))</td>
      <td>Dolcetto</td>
      <td>86</td>
      <td>-0.88395</td>
    </tr>
    <tr>
      <th>103725</th>
      <td>Beresan 2008 The Buzz Yellow Jacket Vineyard R...</td>
      <td>Red Blend</td>
      <td>86</td>
      <td>-0.88395</td>
    </tr>
    <tr>
      <th>103726</th>
      <td>Cabot Vineyards 2007 Syrah (Humboldt County)</td>
      <td>Syrah</td>
      <td>86</td>
      <td>-0.88395</td>
    </tr>
  </tbody>
</table>
<p>103727 rows × 4 columns</p>
</div></div></div>
</div>
<p>Suppose that we wanted to restrict the rows to only the wines from wineries with at least 100 wines in the data. The problem is we don’t know which wineries have at least 100 reviewed wines. But we can find out with a query:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT winery_id FROM reviews</span>
<span class="s2">GROUP BY winery_id</span>
<span class="s2">    HAVING COUNT(*) &gt;= 100;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>winery_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>9112</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4562</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9557</td>
    </tr>
    <tr>
      <th>3</th>
      <td>13540</td>
    </tr>
    <tr>
      <th>4</th>
      <td>13381</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1547</td>
    </tr>
    <tr>
      <th>6</th>
      <td>4257</td>
    </tr>
    <tr>
      <th>7</th>
      <td>13118</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2007</td>
    </tr>
    <tr>
      <th>9</th>
      <td>7060</td>
    </tr>
    <tr>
      <th>10</th>
      <td>224</td>
    </tr>
    <tr>
      <th>11</th>
      <td>9995</td>
    </tr>
    <tr>
      <th>12</th>
      <td>8022</td>
    </tr>
    <tr>
      <th>13</th>
      <td>5076</td>
    </tr>
    <tr>
      <th>14</th>
      <td>4586</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2375</td>
    </tr>
    <tr>
      <th>16</th>
      <td>14401</td>
    </tr>
    <tr>
      <th>17</th>
      <td>12042</td>
    </tr>
    <tr>
      <th>18</th>
      <td>9111</td>
    </tr>
    <tr>
      <th>19</th>
      <td>4124</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>This query gives us a list of winery ID numbers that match the wineries with at least 100 reviewed wines in the data. We can now use this list inside another query that restricts the reviews data to only the wines from this list of wineries:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT winery_id, title, variety, points, price FROM reviews</span>
<span class="s2">WHERE winery_id IN (</span>
<span class="s2">    SELECT winery_id FROM reviews r</span>
<span class="s2">    GROUP BY winery_id</span>
<span class="s2">        HAVING COUNT(*) &gt;= 100</span>
<span class="s2">    );</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>winery_id</th>
      <th>title</th>
      <th>variety</th>
      <th>points</th>
      <th>price</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>14401</td>
      <td>Wines &amp; Winemakers 2012 Pegos Claros Colheita ...</td>
      <td>Castelão</td>
      <td>87</td>
      <td>15.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>14401</td>
      <td>Wines &amp; Winemakers 2013 Lua Cheia em Vinhas Ve...</td>
      <td>Portuguese Red</td>
      <td>87</td>
      <td>18.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>14401</td>
      <td>Wines &amp; Winemakers 2013 Lua Cheia em Vinhas Ve...</td>
      <td>Portuguese Red</td>
      <td>87</td>
      <td>12.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4124</td>
      <td>Chateau Ste. Michelle 2008 Syrah (Columbia Val...</td>
      <td>Syrah</td>
      <td>87</td>
      <td>13.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4586</td>
      <td>Concha y Toro 2010 Gravas del Maipo Syrah (Mai...</td>
      <td>Syrah</td>
      <td>91</td>
      <td>200.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2742</th>
      <td>13381</td>
      <td>Trapiche 2016 Pure Malbec (Uco Valley)</td>
      <td>Malbec</td>
      <td>88</td>
      <td>15.0</td>
    </tr>
    <tr>
      <th>2743</th>
      <td>9111</td>
      <td>Louis Jadot 2005 La Dominode Premier Cru  (Sav...</td>
      <td>Pinot Noir</td>
      <td>90</td>
      <td>37.0</td>
    </tr>
    <tr>
      <th>2744</th>
      <td>9995</td>
      <td>Montes 2009 Limited Selection Pinot Noir (Casa...</td>
      <td>Pinot Noir</td>
      <td>89</td>
      <td>20.0</td>
    </tr>
    <tr>
      <th>2745</th>
      <td>4124</td>
      <td>Chateau Ste. Michelle 2012 Canoe Ridge Estate ...</td>
      <td>Chardonnay</td>
      <td>89</td>
      <td>22.0</td>
    </tr>
    <tr>
      <th>2746</th>
      <td>14401</td>
      <td>Wines &amp; Winemakers 2015 Nostalgia Alvarinho (V...</td>
      <td>Alvarinho</td>
      <td>88</td>
      <td>23.0</td>
    </tr>
  </tbody>
</table>
<p>2747 rows × 5 columns</p>
</div></div></div>
</div>
<p>Suppose we wanted a data table with the top rated wine from each winery. The problem is we don’t know which wine is the top rated for each winery. Again, we can find out with a query that groups the reviews data by winery ID and uses the <code class="docutils literal notranslate"><span class="pre">MAX()</span></code> aggregation function to identify the maximum score achieved for any wine from that winery:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT winery_id, MAX(points) as maxpoints</span>
<span class="s2">FROM reviews</span>
<span class="s2">GROUP BY winery_id;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>winery_id</th>
      <th>maxpoints</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>11233</td>
      <td>91</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4790</td>
      <td>95</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3936</td>
      <td>87</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12502</td>
      <td>87</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5468</td>
      <td>92</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>14566</th>
      <td>4035</td>
      <td>89</td>
    </tr>
    <tr>
      <th>14567</th>
      <td>9180</td>
      <td>92</td>
    </tr>
    <tr>
      <th>14568</th>
      <td>4827</td>
      <td>94</td>
    </tr>
    <tr>
      <th>14569</th>
      <td>790</td>
      <td>83</td>
    </tr>
    <tr>
      <th>14570</th>
      <td>10896</td>
      <td>91</td>
    </tr>
  </tbody>
</table>
<p>14571 rows × 2 columns</p>
</div></div></div>
</div>
<p>Suppose that this last table already existed in the database with the name “bestscores”. We would be able to join bestscores and reviews, then filter the rows to only those wines whose scores are equal to the maximum scores achieved by the winery with the following code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">r</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">variety</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">price</span> <span class="n">FROM</span> <span class="n">reviews</span> <span class="n">r</span>
<span class="n">INNER</span> <span class="n">JOIN</span> <span class="n">bestscores</span> <span class="n">b</span>
    <span class="n">ON</span> <span class="n">r</span><span class="o">.</span><span class="n">winery_id</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">winery_id</span>
<span class="n">WHERE</span> <span class="n">r</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">maxpoints</span><span class="p">;</span>
</pre></div>
</div>
<p>But because we do not have a table named “bestscores”, we can replace the reference to this table with the subquery that generates this table:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT r.title, r.variety, r.points, r.price FROM reviews r</span>
<span class="s2">INNER JOIN (</span>
<span class="s2">    SELECT winery_id, MAX(points) as maxpoints</span>
<span class="s2">    FROM reviews</span>
<span class="s2">    GROUP BY winery_id) b</span>
<span class="s2">    ON r.winery_id = b.winery_id</span>
<span class="s2">WHERE r.points = b.maxpoints;</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
      <th>variety</th>
      <th>points</th>
      <th>price</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Marqués de Terán 2009 Selección Especial  (Rioja)</td>
      <td>Tempranillo</td>
      <td>86</td>
      <td>24.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Alessandro Veglio 2011 Gattera  (Barolo)</td>
      <td>Nebbiolo</td>
      <td>87</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Pingao 2013  Rioja</td>
      <td>Tempranillo</td>
      <td>87</td>
      <td>13.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Chateau Walla Walla 2008 Syrah (Walla Walla Va...</td>
      <td>Syrah</td>
      <td>87</td>
      <td>40.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Sweet Valley 2008 Cabernet Sauvignon (Walla Wa...</td>
      <td>Cabernet Sauvignon</td>
      <td>87</td>
      <td>35.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>20643</th>
      <td>Kicker Cane 2014 Cabernet Sauvignon (Alexander...</td>
      <td>Cabernet Sauvignon</td>
      <td>88</td>
      <td>20.0</td>
    </tr>
    <tr>
      <th>20644</th>
      <td>Tenuta Grimani 2015 Farinaldo  (Soave)</td>
      <td>Garganega</td>
      <td>88</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>20645</th>
      <td>Vin Vault NV Cabernet Sauvignon (California)</td>
      <td>Cabernet Sauvignon</td>
      <td>88</td>
      <td>20.0</td>
    </tr>
    <tr>
      <th>20646</th>
      <td>Dachshund NV Bubbles Sparkling (Germany)</td>
      <td>Sparkling Blend</td>
      <td>88</td>
      <td>17.0</td>
    </tr>
    <tr>
      <th>20647</th>
      <td>Domaine Guillot-Broux 2009 Beaumont  (Mâcon-Cr...</td>
      <td>Pinot Noir</td>
      <td>88</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>20648 rows × 4 columns</p>
</div></div></div>
</div>
<p>Finally, once we are finished working with the PostgreSQL server, we close it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dbserver</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="sql-security">
<h2><a class="toc-backref" href="#id31" role="doc-backlink"><span class="section-number">7.7. </span>SQL Security</a><a class="headerlink" href="#sql-security" title="Permalink to this heading">#</a></h2>
<p>One criticism of SQL is that it can be manipulated to give unauthorized and hostile users access to perform CRUD operations on the data. This kind of <a class="reference external" href="https://en.wikipedia.org/wiki/SQL_injection">attack</a> is called an <strong>SQL injection attack</strong>, and the best illustration of this attack comes from an <a class="reference external" href="https://xkcd.com">XKCD</a> web comic:</p>
<p><a href="https://xkcd.com/327/"><img src="https://imgs.xkcd.com/comics/exploits_of_a_mom.png" width="500"></a></p>
<p>The following discussion borrows heavily from <a class="reference external" href="https://explainxkcd.com/wiki/index.php/327:_Exploits_of_a_Mom">this blog’s</a> explaination of this XKCD comic.</p>
<p>An SQL injection attack starts with an entry field on the user interface of an application that works with a database, like a field where users write their name. The application reads the name and creates an SQL INSERT operation to create a new record in the data with the name. If I were to enter Jonathan into the name field, the app should generate an SQL command that looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">Students</span> <span class="p">(</span><span class="n">firstname</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;Jonathan&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>This command specifically places the value “Jonathan” into the <code class="docutils literal notranslate"><span class="pre">firstname</span></code> attribute of the <code class="docutils literal notranslate"><span class="pre">Students</span></code> entity. In SQL, different commands are separated by semicolons, so if I wanted to issue two SQL commands I could type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">Students</span> <span class="p">(</span><span class="n">firstname</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;Jonathan&#39;</span><span class="p">);</span> <span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">Students</span> <span class="p">(</span><span class="n">lastname</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;Kropko&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>An SQL injection attack works by writing SQL code in a field that is designed to collect data to input into a database. So If I type my name as <code class="docutils literal notranslate"><span class="pre">Jonathan');</span> <span class="pre">DROP</span> <span class="pre">TABLE</span> <span class="pre">Students;</span> <span class="pre">--;</span></code>, then the SQL create operation becomes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">Students</span> <span class="p">(</span><span class="n">firstname</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;Jonathan&#39;</span><span class="p">);</span> <span class="n">DROP</span> <span class="n">TABLE</span> <span class="n">Students</span><span class="p">;</span> <span class="o">--</span><span class="p">;</span><span class="s1">&#39;);</span>
</pre></div>
</div>
<p>This line consists of three commands</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">INSERT</span> <span class="pre">INTO</span> <span class="pre">Students</span> <span class="pre">(firstname)</span> <span class="pre">VALUES</span> <span class="pre">('Jonathan');</span></code> which inputs “Jonathan” into the database,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DROP</span> <span class="pre">TABLE</span> <span class="pre">Students;</span></code> which deletes the entire <code class="docutils literal notranslate"><span class="pre">Students</span></code> table, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--;');</span></code>: the <code class="docutils literal notranslate"><span class="pre">--</span></code> symbol is an SQL comment, and tells the parser to ignore the remainder of the code, which would avoid a parsing error.</p></li>
</ul>
<p>So just by inserting specific code into a seemingly innocuous field, like name, I can delete the entire <code class="docutils literal notranslate"><span class="pre">Students</span></code> entity in the database.</p>
<p>There are two ways to combat SQL injection attacks. First, it is possible to “sanitize” database inputs by using code that automatically places a slash before a single quote. That puts an <a class="reference external" href="https://en.wikipedia.org/wiki/Escape_character">escape character</a> in front of the quote, which makes it part of the input string and prevents it from being read as the end of the input string. Another approach is to use <a class="reference external" href="https://en.wikipedia.org/wiki/Prepared_statement">prepared statements</a> when converting user-entered data into an SQL query. A prepared statement uses placeholders to stand in for the user-supplied data, and treats the data like input into a function: treating the user data this way prevents the entire SQL query from being read as a single string, and prevents SQL injection. For example, instead of inputing the name directly into the query, the database manager can construct the query in Python code (where a database cursor exists and is named <code class="docutils literal notranslate"><span class="pre">curs</span></code>) like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO Students (firstname) VALUES (</span><span class="si">%s</span><span class="s2">)&quot;</span>
<span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,))</span>
</pre></div>
</div>
<p>In MySQL and PostgreSQL, <code class="docutils literal notranslate"><span class="pre">%s</span></code> stands in for a parameter to be passed into the query (in SQlite, the stand-in symbol is <code class="docutils literal notranslate"><span class="pre">?</span></code> instead of <code class="docutils literal notranslate"><span class="pre">%s</span></code>). Constructing a query in this way prevents SQL injection attacks. More information about formatting secure SQL code is available at <a class="reference external" href="https://bobby-tables.com/">https://bobby-tables.com/</a>, named in honor of this XKCD comic.</p>
<p>As a data scientist mostly issuing read operations, it is unethical for you to attack a database in this way. If you are testing whether a database is secured against SQL injection attacks, don’t try to issue any <code class="docutils literal notranslate"><span class="pre">DROP</span></code> commands as other commands like <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> will reveal the insecurity but won’t make changes in the database. If you are building a database that is connected to an interface for users to enter data, please be aware of the SQL injection vulnerability and use prepared statements to guard against it.</p>
</section>
<section id="mongodb-queries">
<h2><a class="toc-backref" href="#id32" role="doc-backlink"><span class="section-number">7.8. </span>MongoDB Queries</a><a class="headerlink" href="#mongodb-queries" title="Permalink to this heading">#</a></h2>
<p>SQL is a universal language for issuing queries to relational databases, whether the database is managed by SQLite, MySQL, PostgreSQL, or another RDBMS. For NoSQL databases, however, there is no universal query language. Every DBMS has its own query language, and will provide a guide for learning that language. Some of these guides include the ones for key-value stores in <a class="reference external" href="https://redis.io/commands">Redis</a> and wide column stores in <a class="reference external" href="https://cassandra.apache.org/doc/latest/cql/index.html">Cassandra</a>. Neo4j has developed a programming language called <a class="reference external" href="https://neo4j.com/developer/cypher-query-language/">Cypher</a> that is explicitly for issuing queries to graph databases. Of all of these query protocols, the language used by <a class="reference external" href="https://docs.mongodb.com/guides/server/read_queries/">MongoDB</a> for issuing queries to document stores is one of the most universal because it works entirely with JSONs: queries are written in JSON format and the output is organized in JSON format. All of these query languages include methods for all of the CRUD operations.</p>
<p>The most important difference between relational and NoSQL databases is the rigidity of the schema that organizes the data. The advantage of the strict organization of a relational database, as illustrated in an ER diagram, is that the data that can be extracted from the database using an SQL query will be clean and mostly immediately ready to be analyzed. The disadvantage is that relational databases have schema that are hard to change once they’ve been created and populated with data. SQL also, despite the best intentions of the originators of SQL, can be very difficult for people use for some tasks. For extremely large datasets with many tables, it can be extremely difficult to keep track of what data exists in which table. In contrast, NoSQL databases generally have flexible schema that can be changed easily and can vary even from record to record. There are no rules, like the normalization rules, that require that the data be split into different tables, so there is no need for visual maps like ER diagrams. Also, because all of the data for one record exists in the same JSON dictionary, it is easy to use remote, distributed storage to store all of the records. The disadvantage of NoSQL databases is that the data are rarely ready for analysis after a query. It’s a buy-now-pay-later situation: the price we pay for the convenience of NoSQL storage and organization is that the output requires more work to use.</p>
<p>Some concepts that are crucial to SQL are not relevant to NoSQL. There are <strong>no joins</strong> in a document store because all the data for a record exist in the same JSON code. As such, we don’t have to worry about accomplishing these tasks within a NoSQL query. NoSQL queries in general focus narrowly on the CRUD operations, although MongoDB provides some advanced functionality for searching for patterns within text and ranking documents based on their relevance to given search terms.</p>
<p>For the following examples, I will use the document store database that we created in module 6, containing the same data on wine reviews that we practiced with above, only in JSON format. First I load the <code class="docutils literal notranslate"><span class="pre">pymongo</span></code> package and the <code class="docutils literal notranslate"><span class="pre">dumps()</span></code> and <code class="docutils literal notranslate"><span class="pre">loads()</span></code> functions from the <code class="docutils literal notranslate"><span class="pre">json_util</span></code> module of the <code class="docutils literal notranslate"><span class="pre">bson</span></code> package:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pymongo</span>
<span class="kn">from</span> <span class="nn">bson.json_util</span> <span class="kn">import</span> <span class="n">dumps</span><span class="p">,</span> <span class="n">loads</span>
</pre></div>
</div>
</div>
</div>
<p>The wine reviews database is stored as a collection <code class="docutils literal notranslate"><span class="pre">winecollection</span></code> within the <code class="docutils literal notranslate"><span class="pre">winedb</span></code> database on my local machine. I load it with the following code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myclient</span> <span class="o">=</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost/&quot;</span><span class="p">)</span>
<span class="n">winedb</span> <span class="o">=</span> <span class="n">myclient</span><span class="p">[</span><span class="s2">&quot;winedb&quot;</span><span class="p">]</span>
<span class="n">winecollection</span> <span class="o">=</span> <span class="n">winedb</span><span class="p">[</span><span class="s2">&quot;winecollection&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We will discuss more advanced read techniques below, but to see one record, we can issue a query using JSON code and we can see the output in JSON format. To see all of the data for the “Nicosia 2013 Vulkà Bianco”, we search for the record based on the title of this wine with the following code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Nicosia 2013 Vulkà Bianco  (Etna)&#39;</span><span class="p">}</span>
<span class="n">mywine</span> <span class="o">=</span> <span class="n">winecollection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">myquery</span><span class="p">)</span> 
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mywine</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;_id&#39;: ObjectId(&#39;5ed80dbca25fcf746119e3aa&#39;), &#39;wine_id&#39;: 0, &#39;country&#39;: &#39;Italy&#39;, &#39;description&#39;: &quot;Aromas include tropical fruit, broom, brimstone and dried herb. The palate isn&#39;t overly expressive, offering unripened apple, citrus and dried sage alongside brisk acidity.&quot;, &#39;points&#39;: 87, &#39;price&#39;: None, &#39;province&#39;: &#39;Sicily &amp; Sardinia&#39;, &#39;region&#39;: &#39;Etna&#39;, &#39;taster_name&#39;: &#39;Kerin O’Keefe&#39;, &#39;taster_twitter_handle&#39;: &#39;@kerinokeefe&#39;, &#39;title&#39;: &#39;Nicosia 2013 Vulkà Bianco  (Etna)&#39;, &#39;variety&#39;: &#39;White Blend&#39;, &#39;winery&#39;: &#39;Nicosia&#39;}
</pre></div>
</div>
</div>
</div>
<p>Notice that all of the data for this wine exists in this JSON dictionary, including data from the reviews, locations, wineries, and tasters tables in the PostgreSQL database. When we created this MongoDB database, the DBMS automatically created a unique ID for each record designated with the key <code class="docutils literal notranslate"><span class="pre">_id</span></code>.</p>
<p>We can now use the methods in <code class="docutils literal notranslate"><span class="pre">pymongo</span></code> for creating, reading, updating, and deleting records and we will apply these methods to the <code class="docutils literal notranslate"><span class="pre">winecollection</span></code> variable that accesses the data.</p>
<section id="creating-and-deleting-records">
<h3><a class="toc-backref" href="#id33" role="doc-backlink"><span class="section-number">7.8.1. </span>Creating and Deleting Records</a><a class="headerlink" href="#creating-and-deleting-records" title="Permalink to this heading">#</a></h3>
<p>Did you know that former NBA all-star Dwyane Wade has a winery? It’s called <a class="reference external" href="https://dwadecellars.com/">D Wade Cellars</a> and it is based in the Napa Valley in California. Let’s add the <a class="reference external" href="https://dwadecellars.vinespring.com/purchase/detail?item=2016-napa-valley-three-by-wade-red-blend">2016 Napa Valley Three By Wade Red Blend</a> into the database. The first step is to express all of the data we want to associate with a new record in JSON format:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dwadewine</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;2016 Napa Valley Three By Wade Red Blend&#39;</span><span class="p">,</span> 
<span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s2">&quot;This wine goes great with dinner just like Dwyane Wade goes great with LeBron James or Shaq.&quot;</span><span class="p">,</span> 
<span class="s1">&#39;taster_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Jonathan Kropko&#39;</span><span class="p">,</span> 
<span class="s1">&#39;taster_twitter_handle&#39;</span><span class="p">:</span> <span class="s1">&#39;@jmk5131&#39;</span><span class="p">,</span> 
<span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="s1">&#39;35&#39;</span><span class="p">,</span> 
<span class="s1">&#39;variety&#39;</span><span class="p">:</span> <span class="s1">&#39;Red Blend&#39;</span><span class="p">,</span> 
<span class="s1">&#39;location&#39;</span><span class="p">:{</span>
    <span class="s1">&#39;region_1&#39;</span><span class="p">:</span> <span class="s1">&#39;Napa Valley&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;region_2&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="s1">&#39;province&#39;</span><span class="p">:</span> <span class="s1">&#39;California&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;country&#39;</span><span class="p">:</span> <span class="s1">&#39;U.S.&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;winery&#39;</span><span class="p">:</span> <span class="s1">&#39;D Wade Cellars&#39;</span><span class="p">}}</span>
</pre></div>
</div>
</div>
</div>
<p>In creating this JSON record, I tried to follow the standards that exist elsewhere in the data by using the same feature names. I departed from the format of other records in two ways. First, I omitted the points and designation features. Second, I placed all the information about the location and name of the winery under the “location” key, which induces some nesting structure.</p>
<p>To add this one record to the database, I use the <code class="docutils literal notranslate"><span class="pre">.insert_one()</span></code> method on the <code class="docutils literal notranslate"><span class="pre">winecollection</span></code> database, with the following code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">winecollection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">dwadewine</span><span class="p">)</span>
</pre></div>
</div>
<p>By default, the <code class="docutils literal notranslate"><span class="pre">insert_one()</span></code> method automatically checks to see whether the record already exists in the data, and throws an error if it does, unless we specify the <code class="docutils literal notranslate"><span class="pre">bypass_document_validation=True</span></code> argument, which allows duplicate records to be input into the database. For the purposes of this notebook, I rerun these cells many times while writing, and I don’t want to place many duplicate records into the database. Instead, I can delete the record if it already exists. The code</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">winecollection</span><span class="o">.</span><span class="n">count_documents</span><span class="p">({</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;2016 Napa Valley Three By Wade Red Blend&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>generates a count of the records of wines in the database that have this title. If there are any existing records, I can delete all of these records with the <code class="docutils literal notranslate"><span class="pre">.delete_many()</span></code> method, in which the argument is a JSON with enough fields specified to exactly match the records we want to delete:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">winecollection</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;2016 Napa Valley Three By Wade Red Blend&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>In constrast, the <code class="docutils literal notranslate"><span class="pre">.delete_one()</span></code> method will only delete the first record, when sorting by <code class="docutils literal notranslate"><span class="pre">_id</span></code>, that matches the query. If there are no documents that match the query, he <code class="docutils literal notranslate"><span class="pre">.delete_all()</span></code> or <code class="docutils literal notranslate"><span class="pre">.delete_one()</span></code> methods will both still process the query without error, but will not change anything in the database.</p>
<p>We first delete any records of wines with the title “2016 Napa Valley Three By Wade Red Blend” with <code class="docutils literal notranslate"><span class="pre">.delete_all()</span></code>, then we insert the entire record of this wine with <code class="docutils literal notranslate"><span class="pre">.insert_one()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">winecollection</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;2016 Napa Valley Three By Wade Red Blend&#39;</span><span class="p">})</span>
<span class="n">winecollection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">dwadewine</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;pymongo.results.InsertOneResult at 0x12b264a48&gt;
</pre></div>
</div>
</div>
</div>
<p>Now that this record exists in the database, we can find this record by any of the fields associated with the record, such as the title of the wine for example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;2016 Napa Valley Three By Wade Red Blend&#39;</span><span class="p">}</span>
<span class="n">mywine</span> <span class="o">=</span> <span class="n">winecollection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">myquery</span><span class="p">)</span> 
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mywine</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;_id&#39;: ObjectId(&#39;5edd56e5b4e58ce3841e5dea&#39;), &#39;title&#39;: &#39;2016 Napa Valley Three By Wade Red Blend&#39;, &#39;description&#39;: &#39;This wine goes great with dinner just like Dwyane Wade goes great with LeBron James or Shaq.&#39;, &#39;taster_name&#39;: &#39;Jonathan Kropko&#39;, &#39;taster_twitter_handle&#39;: &#39;@jmk5131&#39;, &#39;price&#39;: &#39;35&#39;, &#39;variety&#39;: &#39;Red Blend&#39;, &#39;location&#39;: {&#39;region_1&#39;: &#39;Napa Valley&#39;, &#39;region_2&#39;: None, &#39;province&#39;: &#39;California&#39;, &#39;country&#39;: &#39;U.S.&#39;, &#39;winery&#39;: &#39;D Wade Cellars&#39;}}
</pre></div>
</div>
</div>
</div>
<p>Note that MongoDB automatically generates a unique ID value for this document and includes it under the <code class="docutils literal notranslate"><span class="pre">_id</span></code> field in the JSON output.</p>
<p>Wikipedia lists <a class="reference external" href="https://en.wikipedia.org/wiki/List_of_celebrities_who_own_wineries_and_vineyards">93 other celebrities</a> other than Dwyane Wade who own wineries and vineyards, including <a class="reference external" href="https://www.decanter.com/wine-news/antonio-banderas-32255/">Antonio Banderas</a>, <a class="reference external" href="https://thewinesiren.com/drew-barrymore-vintner/">Drew Barrymore</a>, and <a class="reference external" href="http://www.today.com/id/23945035/ns/today-today_entertainment/t/rapper-lil-jon-starts-his-own-wine-label/#.XtV1BZp7l24">Lil Jon</a>. If we want to add more than one record to the wine collection database, we need to create a list of individual JSON dictionaries with code that looks like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">newrecords</span> <span class="o">=</span> <span class="p">[{</span><span class="n">JSON</span> <span class="n">dictionary</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="n">JSON</span> <span class="n">dictionary</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="n">JSON</span> <span class="n">dictionary</span> <span class="mi">3</span><span class="p">}]</span>
</pre></div>
</div>
<p>In this case, I can create entries for Antonio Banderas, Drew Barrymore, and Lil Jon’s wines and store them in one list:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">newwines</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Anta Banderas A 10 2008&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s2">&quot;This wine will make you speak differently. Maybe not with a charming Spanish accent, but you might think you sound that way.&quot;</span><span class="p">,</span> 
             <span class="s1">&#39;taster_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Jonathan Kropko&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;taster_twitter_handle&#39;</span><span class="p">:</span> <span class="s1">&#39;@jmk5131&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="s1">&#39;40.99&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;variety&#39;</span><span class="p">:</span> <span class="s1">&#39;Red Blend&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;location&#39;</span><span class="p">:{</span>
                 <span class="s1">&#39;region_1&#39;</span><span class="p">:</span> <span class="s1">&#39;Ribera del Duoro&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;region_2&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="s1">&#39;province&#39;</span><span class="p">:</span> <span class="s1">&#39;Valladolid&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;country&#39;</span><span class="p">:</span> <span class="s1">&#39;Spain&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;winery&#39;</span><span class="p">:</span> <span class="s1">&#39;Anta Banderas&#39;</span><span class="p">}},</span>
           <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Barrymore Rose 2013&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s2">&quot;Someone drank my entire bottle of wine!&quot;</span><span class="p">,</span> 
             <span class="s1">&#39;taster_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Jonathan Kropko&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;taster_twitter_handle&#39;</span><span class="p">:</span> <span class="s1">&#39;@jmk5131&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="s1">&#39;14.99&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;variety&#39;</span><span class="p">:</span> <span class="s1">&#39;Rose&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;location&#39;</span><span class="p">:{</span>
                 <span class="s1">&#39;region_1&#39;</span><span class="p">:</span> <span class="s1">&#39;Monterey&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;region_2&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="s1">&#39;province&#39;</span><span class="p">:</span> <span class="s1">&#39;California&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;country&#39;</span><span class="p">:</span> <span class="s1">&#39;U.S.&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;winery&#39;</span><span class="p">:</span> <span class="s1">&#39;Barrymore Vineyard&#39;</span><span class="p">}},</span>
           <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;2006 Little Jonathan Winery Cabernet Sauvignon&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s2">&quot;This upscale crunk juice is OOOKAAAAAAY.&quot;</span><span class="p">,</span> 
             <span class="s1">&#39;taster_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Jonathan Kropko&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;taster_twitter_handle&#39;</span><span class="p">:</span> <span class="s1">&#39;@jmk5131&#39;</span><span class="p">,</span>  
             <span class="s1">&#39;variety&#39;</span><span class="p">:</span> <span class="s1">&#39;Cabernet Sauvignon&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;location&#39;</span><span class="p">:{</span>
                 <span class="s1">&#39;region_1&#39;</span><span class="p">:</span> <span class="s1">&#39;Central Coast&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;region_2&#39;</span><span class="p">:</span> <span class="s1">&#39;Paso Robles&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;province&#39;</span><span class="p">:</span> <span class="s1">&#39;California&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;country&#39;</span><span class="p">:</span> <span class="s1">&#39;U.S.&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;winery&#39;</span><span class="p">:</span> <span class="s1">&#39;Little Jonathan Winery&#39;</span><span class="p">}}]</span>
</pre></div>
</div>
</div>
</div>
<p>To add these three records to the database with one line of code, we use the <code class="docutils literal notranslate"><span class="pre">.insert_many()</span></code> method. To avoid duplicates, we first delete any records of wines titled “Anta Banderas A 10 2008”, “Barrymore Rose 2013”, or “2006 Little Jonathan Winery Cabernet Sauvignon”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">winecollection</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Anta Banderas A 10 2008&#39;</span><span class="p">})</span>
<span class="n">winecollection</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Barrymore Rose 2013&#39;</span><span class="p">})</span>
<span class="n">winecollection</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;2006 Little Jonathan Winery Cabernet Sauvignon&#39;</span><span class="p">})</span>
<span class="n">winecollection</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">newwines</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;pymongo.results.InsertManyResult at 0x1268132c8&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="reading-data-and-selecting-records">
<h3><a class="toc-backref" href="#id34" role="doc-backlink"><span class="section-number">7.8.2. </span>Reading Data and Selecting Records</a><a class="headerlink" href="#reading-data-and-selecting-records" title="Permalink to this heading">#</a></h3>
<p>To read all of the records in a MongoDB collection, use the <code class="docutils literal notranslate"><span class="pre">.find()</span></code> method and pass an empty JSON dictionary to this method. For the wine reviews collection, we can query the entire collection by typing</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="n">winecollection</span><span class="o">.</span><span class="n">find</span><span class="p">({})</span>
</pre></div>
</div>
</div>
</div>
<p>Here, the queried data exist within the variable <code class="docutils literal notranslate"><span class="pre">cursor</span></code>. The data are not displayed automatically. To see the data in JSON format, we can employ the <code class="docutils literal notranslate"><span class="pre">print()</span></code> function on elements of the cursor. To see the first element:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">myquery</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;_id&#39;: ObjectId(&#39;5ed80dbca25fcf746119e3aa&#39;), &#39;wine_id&#39;: 0, &#39;country&#39;: &#39;Italy&#39;, &#39;description&#39;: &quot;Aromas include tropical fruit, broom, brimstone and dried herb. The palate isn&#39;t overly expressive, offering unripened apple, citrus and dried sage alongside brisk acidity.&quot;, &#39;points&#39;: 87, &#39;price&#39;: None, &#39;province&#39;: &#39;Sicily &amp; Sardinia&#39;, &#39;region&#39;: &#39;Etna&#39;, &#39;taster_name&#39;: &#39;Kerin O’Keefe&#39;, &#39;taster_twitter_handle&#39;: &#39;@kerinokeefe&#39;, &#39;title&#39;: &#39;Nicosia 2013 Vulkà Bianco  (Etna)&#39;, &#39;variety&#39;: &#39;White Blend&#39;, &#39;winery&#39;: &#39;Nicosia&#39;}
</pre></div>
</div>
</div>
</div>
<p>And to see more elements, we can use a loop. Here’s code to view the first three wines:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">myquery</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;_id&#39;: ObjectId(&#39;5ed80dbca25fcf746119e3aa&#39;), &#39;wine_id&#39;: 0, &#39;country&#39;: &#39;Italy&#39;, &#39;description&#39;: &quot;Aromas include tropical fruit, broom, brimstone and dried herb. The palate isn&#39;t overly expressive, offering unripened apple, citrus and dried sage alongside brisk acidity.&quot;, &#39;points&#39;: 87, &#39;price&#39;: None, &#39;province&#39;: &#39;Sicily &amp; Sardinia&#39;, &#39;region&#39;: &#39;Etna&#39;, &#39;taster_name&#39;: &#39;Kerin O’Keefe&#39;, &#39;taster_twitter_handle&#39;: &#39;@kerinokeefe&#39;, &#39;title&#39;: &#39;Nicosia 2013 Vulkà Bianco  (Etna)&#39;, &#39;variety&#39;: &#39;White Blend&#39;, &#39;winery&#39;: &#39;Nicosia&#39;}
{&#39;_id&#39;: ObjectId(&#39;5ed80dcca25fcf746119e3ab&#39;), &#39;wine_id&#39;: 1, &#39;country&#39;: &#39;Portugal&#39;, &#39;description&#39;: &quot;This is ripe and fruity, a wine that is smooth while still structured. Firm tannins are filled out with juicy red berry fruits and freshened with acidity. It&#39;s  already drinkable, although it will certainly be better from 2016.&quot;, &#39;points&#39;: 87, &#39;price&#39;: 15.0, &#39;province&#39;: &#39;Douro&#39;, &#39;region&#39;: None, &#39;taster_name&#39;: &#39;Roger Voss&#39;, &#39;taster_twitter_handle&#39;: &#39;@vossroger&#39;, &#39;title&#39;: &#39;Quinta dos Avidagos 2011 Avidagos Red (Douro)&#39;, &#39;variety&#39;: &#39;Portuguese Red&#39;, &#39;winery&#39;: &#39;Quinta dos Avidagos&#39;}
{&#39;_id&#39;: ObjectId(&#39;5ed80dcca25fcf746119e3ac&#39;), &#39;wine_id&#39;: 2, &#39;country&#39;: &#39;US&#39;, &#39;description&#39;: &#39;Tart and snappy, the flavors of lime flesh and rind dominate. Some green pineapple pokes through, with crisp acidity underscoring the flavors. The wine was all stainless-steel fermented.&#39;, &#39;points&#39;: 87, &#39;price&#39;: 14.0, &#39;province&#39;: &#39;Oregon&#39;, &#39;region&#39;: &#39;Willamette Valley&#39;, &#39;taster_name&#39;: &#39;Paul Gregutt&#39;, &#39;taster_twitter_handle&#39;: &#39;@paulgwine\xa0&#39;, &#39;title&#39;: &#39;Rainstorm 2013 Pinot Gris (Willamette Valley)&#39;, &#39;variety&#39;: &#39;Pinot Gris&#39;, &#39;winery&#39;: &#39;Rainstorm&#39;}
</pre></div>
</div>
</div>
</div>
<p>Displaying the query output data as a list of JSON dictionaries, however, is not the most useful way to store the data. We need a way to put these data into a dataframe. For that we can use the <code class="docutils literal notranslate"><span class="pre">dumps()</span></code> and <code class="docutils literal notranslate"><span class="pre">loads()</span></code> functions from the <code class="docutils literal notranslate"><span class="pre">bson</span></code> library. These functions work exactly like the <code class="docutils literal notranslate"><span class="pre">dumps()</span></code> and <code class="docutils literal notranslate"><span class="pre">loads()</span></code> functions from the <code class="docutils literal notranslate"><span class="pre">json</span></code> library, but they remove some of the extra components of these JSON dictionaries associated with the database. To query all of the data and to place all of it into a dataframe, we pass the query output to <code class="docutils literal notranslate"><span class="pre">dumps()</span></code>, which converts the query output to plain text. Next we pass this text to <code class="docutils literal notranslate"><span class="pre">loads()</span></code>, which registers the text as a list of JSON dictionaries. Finally we use this list as the argument of <code class="docutils literal notranslate"><span class="pre">pd.DataFrame.from_records()</span></code> to convert the output to a dataframe. For the wine collection, this code is:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="n">winecollection</span><span class="o">.</span><span class="n">find</span><span class="p">({})</span>
<span class="n">wine_text</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">(</span><span class="n">myquery</span><span class="p">)</span>
<span class="n">wine_records</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">wine_text</span><span class="p">)</span>
<span class="n">wine_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">wine_records</span><span class="p">)</span>
<span class="n">wine_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>_id</th>
      <th>wine_id</th>
      <th>country</th>
      <th>description</th>
      <th>points</th>
      <th>price</th>
      <th>province</th>
      <th>region</th>
      <th>taster_name</th>
      <th>taster_twitter_handle</th>
      <th>title</th>
      <th>variety</th>
      <th>winery</th>
      <th>location</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5ed80dbca25fcf746119e3aa</td>
      <td>0.0</td>
      <td>Italy</td>
      <td>Aromas include tropical fruit, broom, brimston...</td>
      <td>87.0</td>
      <td>None</td>
      <td>Sicily &amp; Sardinia</td>
      <td>Etna</td>
      <td>Kerin O’Keefe</td>
      <td>@kerinokeefe</td>
      <td>Nicosia 2013 Vulkà Bianco  (Etna)</td>
      <td>White Blend</td>
      <td>Nicosia</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5ed80dcca25fcf746119e3ab</td>
      <td>1.0</td>
      <td>Portugal</td>
      <td>This is ripe and fruity, a wine that is smooth...</td>
      <td>87.0</td>
      <td>15</td>
      <td>Douro</td>
      <td>None</td>
      <td>Roger Voss</td>
      <td>@vossroger</td>
      <td>Quinta dos Avidagos 2011 Avidagos Red (Douro)</td>
      <td>Portuguese Red</td>
      <td>Quinta dos Avidagos</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5ed80dcca25fcf746119e3ac</td>
      <td>2.0</td>
      <td>US</td>
      <td>Tart and snappy, the flavors of lime flesh and...</td>
      <td>87.0</td>
      <td>14</td>
      <td>Oregon</td>
      <td>Willamette Valley</td>
      <td>Paul Gregutt</td>
      <td>@paulgwine</td>
      <td>Rainstorm 2013 Pinot Gris (Willamette Valley)</td>
      <td>Pinot Gris</td>
      <td>Rainstorm</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5ed80dcca25fcf746119e3ad</td>
      <td>3.0</td>
      <td>US</td>
      <td>Pineapple rind, lemon pith and orange blossom ...</td>
      <td>87.0</td>
      <td>13</td>
      <td>Michigan</td>
      <td>Lake Michigan Shore</td>
      <td>Alexander Peartree</td>
      <td>None</td>
      <td>St. Julian 2013 Reserve Late Harvest Riesling ...</td>
      <td>Riesling</td>
      <td>St. Julian</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5ed80dcca25fcf746119e3ae</td>
      <td>4.0</td>
      <td>US</td>
      <td>Much like the regular bottling from 2012, this...</td>
      <td>87.0</td>
      <td>65</td>
      <td>Oregon</td>
      <td>Willamette Valley</td>
      <td>Paul Gregutt</td>
      <td>@paulgwine</td>
      <td>Sweet Cheeks 2012 Vintner's Reserve Wild Child...</td>
      <td>Pinot Noir</td>
      <td>Sweet Cheeks</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>103726</th>
      <td>5ed80dcfa25fcf74611b78d8</td>
      <td>129970.0</td>
      <td>France</td>
      <td>Big, rich and off-dry, this is powered by inte...</td>
      <td>90.0</td>
      <td>21</td>
      <td>Alsace</td>
      <td>Alsace</td>
      <td>Roger Voss</td>
      <td>@vossroger</td>
      <td>Domaine Schoffit 2012 Lieu-dit Harth Cuvée Car...</td>
      <td>Gewürztraminer</td>
      <td>Domaine Schoffit</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>103727</th>
      <td>5edd56e5b4e58ce3841e5dea</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>This wine goes great with dinner just like Dwy...</td>
      <td>NaN</td>
      <td>35</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Jonathan Kropko</td>
      <td>@jmk5131</td>
      <td>2016 Napa Valley Three By Wade Red Blend</td>
      <td>Red Blend</td>
      <td>NaN</td>
      <td>{'region_1': 'Napa Valley', 'region_2': None, ...</td>
    </tr>
    <tr>
      <th>103728</th>
      <td>5edd56e6b4e58ce3841e5deb</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>This wine will make you speak differently. May...</td>
      <td>NaN</td>
      <td>40.99</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Jonathan Kropko</td>
      <td>@jmk5131</td>
      <td>Anta Banderas A 10 2008</td>
      <td>Red Blend</td>
      <td>NaN</td>
      <td>{'region_1': 'Ribera del Duoro', 'region_2': N...</td>
    </tr>
    <tr>
      <th>103729</th>
      <td>5edd56e6b4e58ce3841e5dec</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Someone drank my entire bottle of wine!</td>
      <td>NaN</td>
      <td>14.99</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Jonathan Kropko</td>
      <td>@jmk5131</td>
      <td>Barrymore Rose 2013</td>
      <td>Rose</td>
      <td>NaN</td>
      <td>{'region_1': 'Monterey', 'region_2': None, 'pr...</td>
    </tr>
    <tr>
      <th>103730</th>
      <td>5edd56e6b4e58ce3841e5ded</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>This upscale crunk juice is OOOKAAAAAAY.</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Jonathan Kropko</td>
      <td>@jmk5131</td>
      <td>2006 Little Jonathan Winery Cabernet Sauvignon</td>
      <td>Cabernet Sauvignon</td>
      <td>NaN</td>
      <td>{'region_1': 'Central Coast', 'region_2': 'Pas...</td>
    </tr>
  </tbody>
</table>
<p>103731 rows × 14 columns</p>
</div></div></div>
</div>
<p>Like SQL, read operations in MongoDB can filter records based on logical conditions. Unlike SQL, MongoDB uses different symbols for the common logical operators, and these symbols need to be listed within the JSON formatted query.  A couple of the operators are implicit in the JSON syntax. To search on an equality condition, the general syntax is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;key&#39;</span> <span class="p">:</span> <span class="n">value</span><span class="p">}</span>
</pre></div>
</div>
<p>For example, to find all of the wines in the database that are from virginia, we can use the following query:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;province&#39;</span> <span class="p">:</span> <span class="s1">&#39;Virginia&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>The other implicit operator is “and”, which is expressed simply by including more than one key-value pair within the syntax. To specify that a feature <code class="docutils literal notranslate"><span class="pre">key1</span></code> is equal to <code class="docutils literal notranslate"><span class="pre">value1</span></code> AND that <code class="docutils literal notranslate"><span class="pre">key2</span></code> is equal to <code class="docutils literal notranslate"><span class="pre">value2</span></code>, type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;key1&#39;</span> <span class="p">:</span> <span class="n">value1</span><span class="p">,</span>
 <span class="s1">&#39;key2&#39;</span> <span class="p">:</span> <span class="n">value2</span><span class="p">}</span>
</pre></div>
</div>
<p>For example, to filter the data to Pinot Noir wines from Virginia, we can type</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;variety&#39;</span> <span class="p">:</span> <span class="s1">&#39;Pinot Noir&#39;</span><span class="p">,</span>
 <span class="s1">&#39;province&#39;</span> <span class="p">:</span> <span class="s1">&#39;Virginia&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>For all other logical operators, MongoDB uses special syntax, described below. To use these operators in a query, the general template is general syntax for using an operator within a MongoDB query is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;key&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$operator&#39;</span> <span class="p">:</span> <span class="n">value</span> <span class="p">}</span> <span class="p">}</span>
</pre></div>
</div>
<p>The operators are listed in the following table:</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Operator</p></th>
<th class="head"><p>Syntax</p></th>
<th class="head"><p>Example query</p></th>
<th class="head"><p>Example code</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Equal to</p></td>
<td><p>implicit</p></td>
<td><p>All wines with scores of 100</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{'points':</span> <span class="pre">100}</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Greater than</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'$gt'</span></code></p></td>
<td><p>All wines that are more expensive than \$30</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{'price':</span> <span class="pre">{'$gt':</span> <span class="pre">30}}</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Greater than or equal to</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'$gte'</span></code></p></td>
<td><p>All wines with scores of 95 or higher</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{'points':</span> <span class="pre">{'$gte':</span> <span class="pre">95}}</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Less than</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'$lt'</span></code></p></td>
<td><p>All wines that are cheaper than \$20</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{'price':</span> <span class="pre">{'$lt':</span> <span class="pre">20}}</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Less than or equal to</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'$lte'</span></code></p></td>
<td><p>All wines with scores of 85 or lower</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{'points':</span> <span class="pre">{'$lte':</span> <span class="pre">85}}</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Not equal</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'$ne'</span></code></p></td>
<td><p>Wines that are not red blends</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{'variety':</span> <span class="pre">{'$ne':</span> <span class="pre">'Red</span> <span class="pre">Blend'}</span></code></p></td>
</tr>
<tr class="row-even"><td><p>And</p></td>
<td><p>implicit</p></td>
<td><p>All wines with scores of 100 and prices of \$20 or less</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{'points':</span> <span class="pre">100,</span> <span class="pre">'price':</span> <span class="pre">{'$lte':</span> <span class="pre">20}}</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Or</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'$or':</span> <span class="pre">[{condition1},</span> <span class="pre">{condition2}]</span></code></p></td>
<td><p>All wines with scores of 100, or prices of \$20 or less</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{'$or':</span> <span class="pre">[{'points':</span> <span class="pre">100},</span> <span class="pre">{'price:</span> <span class="pre">{'$lte':</span> <span class="pre">20}}]}</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Exists in a set</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'$in':</span> <span class="pre">[value1,</span> <span class="pre">value2,</span> <span class="pre">...]</span></code></p></td>
<td><p>All wines from Virginia, Maryland, or North Carolina</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{'province':</span> <span class="pre">{'$in':</span> <span class="pre">['Virginia',</span> <span class="pre">'Maryland',</span> <span class="pre">'North</span> <span class="pre">Carolina']}}</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Not in a set</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'$nin'</span></code></p></td>
<td><p>All wines except those from Virginia, Maryland, and North Carolina</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{'province':</span> <span class="pre">{'$nin':</span> <span class="pre">['Virginia',</span> <span class="pre">'Maryland',</span> <span class="pre">'North</span> <span class="pre">Carolina']}}</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Use logical conditions that compare two or more keys</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{'$expr':</span> <span class="pre">&lt;expression&gt;}</span></code></p></td>
<td><p>All wines whose price is greater than their score</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{'$expr':</span> <span class="pre">{'$gt':</span> <span class="pre">['$price',</span> <span class="pre">'$points']}}</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Logical negation (only recommended for use with <code class="docutils literal notranslate"><span class="pre">$text</span></code> and <code class="docutils literal notranslate"><span class="pre">$regex</span></code>)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'$not'</span></code></p></td>
<td><p>All wines whose descriptions do not contain the word “chocolate”, treating capital and lower-case letters the same</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{'$not':</span> <span class="pre">{'description':</span> <span class="pre">{'$text':</span> <span class="pre">{'$search':</span> <span class="pre">'chocolate',</span> <span class="pre">'$caseSensitive':</span> <span class="pre">false}}}}</span></code></p></td>
</tr>
</tbody>
</table>
<p>To quickly see the data that is output by queries that use these operators, I write a function that takes a JSON dictionary as an input, and outputs a <code class="docutils literal notranslate"><span class="pre">pandas</span></code> dataframe:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mongo_read_query</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="n">qtext</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
    <span class="n">qrec</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">qtext</span><span class="p">)</span>
    <span class="n">qdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">qrec</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">qdf</span>
</pre></div>
</div>
</div>
</div>
<p>To see all wines with a score of 100</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;points&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>
<span class="n">mongo_read_query</span><span class="p">(</span><span class="n">winecollection</span><span class="p">,</span> <span class="n">myquery</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>_id</th>
      <th>wine_id</th>
      <th>country</th>
      <th>description</th>
      <th>points</th>
      <th>price</th>
      <th>province</th>
      <th>region</th>
      <th>taster_name</th>
      <th>taster_twitter_handle</th>
      <th>title</th>
      <th>variety</th>
      <th>winery</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5ed80dcca25fcf746119e498</td>
      <td>345</td>
      <td>Australia</td>
      <td>This wine contains some material over 100 year...</td>
      <td>100</td>
      <td>350.0</td>
      <td>Victoria</td>
      <td>Rutherglen</td>
      <td>Joe Czerwinski</td>
      <td>@JoeCz</td>
      <td>Chambers Rosewood Vineyards NV Rare Muscat (Ru...</td>
      <td>Muscat</td>
      <td>Chambers Rosewood Vineyards</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5ed80dcea25fcf74611a5511</td>
      <td>36528</td>
      <td>France</td>
      <td>This is a fabulous wine from the greatest Cham...</td>
      <td>100</td>
      <td>259.0</td>
      <td>Champagne</td>
      <td>Champagne</td>
      <td>Roger Voss</td>
      <td>@vossroger</td>
      <td>Krug 2002 Brut  (Champagne)</td>
      <td>Champagne Blend</td>
      <td>Krug</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5ed80dcea25fcf74611a66df</td>
      <td>42197</td>
      <td>Portugal</td>
      <td>This is the latest release of what has long be...</td>
      <td>100</td>
      <td>450.0</td>
      <td>Douro</td>
      <td>None</td>
      <td>Roger Voss</td>
      <td>@vossroger</td>
      <td>Casa Ferreirinha 2008 Barca-Velha Red (Douro)</td>
      <td>Portuguese Red</td>
      <td>Casa Ferreirinha</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5ed80dcea25fcf74611a7214</td>
      <td>45781</td>
      <td>Italy</td>
      <td>This gorgeous, fragrant wine opens with classi...</td>
      <td>100</td>
      <td>550.0</td>
      <td>Tuscany</td>
      <td>Brunello di Montalcino</td>
      <td>Kerin O’Keefe</td>
      <td>@kerinokeefe</td>
      <td>Biondi Santi 2010 Riserva  (Brunello di Montal...</td>
      <td>Sangiovese</td>
      <td>Biondi Santi</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5ed80dcea25fcf74611a9877</td>
      <td>58352</td>
      <td>France</td>
      <td>This is a magnificently solid wine, initially ...</td>
      <td>100</td>
      <td>150.0</td>
      <td>Bordeaux</td>
      <td>Saint-Julien</td>
      <td>Roger Voss</td>
      <td>@vossroger</td>
      <td>Château Léoville Barton 2010  Saint-Julien</td>
      <td>Bordeaux-style Red Blend</td>
      <td>Château Léoville Barton</td>
    </tr>
    <tr>
      <th>5</th>
      <td>5ed80dcfa25fcf74611afacd</td>
      <td>89728</td>
      <td>France</td>
      <td>This latest incarnation of the famous brand is...</td>
      <td>100</td>
      <td>250.0</td>
      <td>Champagne</td>
      <td>Champagne</td>
      <td>Roger Voss</td>
      <td>@vossroger</td>
      <td>Louis Roederer 2008 Cristal Vintage Brut  (Cha...</td>
      <td>Champagne Blend</td>
      <td>Louis Roederer</td>
    </tr>
    <tr>
      <th>6</th>
      <td>5ed80dcfa25fcf74611aface</td>
      <td>89729</td>
      <td>France</td>
      <td>This new release from a great vintage for Char...</td>
      <td>100</td>
      <td>617.0</td>
      <td>Champagne</td>
      <td>Champagne</td>
      <td>Roger Voss</td>
      <td>@vossroger</td>
      <td>Salon 2006 Le Mesnil Blanc de Blancs Brut Char...</td>
      <td>Chardonnay</td>
      <td>Salon</td>
    </tr>
    <tr>
      <th>7</th>
      <td>5ed80dcfa25fcf74611b3fc4</td>
      <td>111753</td>
      <td>France</td>
      <td>Almost black in color, this stunning wine is g...</td>
      <td>100</td>
      <td>1500.0</td>
      <td>Bordeaux</td>
      <td>Pauillac</td>
      <td>Roger Voss</td>
      <td>@vossroger</td>
      <td>Château Lafite Rothschild 2010  Pauillac</td>
      <td>Bordeaux-style Red Blend</td>
      <td>Château Lafite Rothschild</td>
    </tr>
    <tr>
      <th>8</th>
      <td>5ed80dcfa25fcf74611b3fc5</td>
      <td>111755</td>
      <td>France</td>
      <td>This is the finest Cheval Blanc for many years...</td>
      <td>100</td>
      <td>1500.0</td>
      <td>Bordeaux</td>
      <td>Saint-Émilion</td>
      <td>Roger Voss</td>
      <td>@vossroger</td>
      <td>Château Cheval Blanc 2010  Saint-Émilion</td>
      <td>Bordeaux-style Red Blend</td>
      <td>Château Cheval Blanc</td>
    </tr>
    <tr>
      <th>9</th>
      <td>5ed80dcfa25fcf74611b3fc6</td>
      <td>111756</td>
      <td>France</td>
      <td>A hugely powerful wine, full of dark, brooding...</td>
      <td>100</td>
      <td>359.0</td>
      <td>Bordeaux</td>
      <td>Saint-Julien</td>
      <td>Roger Voss</td>
      <td>@vossroger</td>
      <td>Château Léoville Las Cases 2010  Saint-Julien</td>
      <td>Bordeaux-style Red Blend</td>
      <td>Château Léoville Las Cases</td>
    </tr>
    <tr>
      <th>10</th>
      <td>5ed80dcfa25fcf74611b4648</td>
      <td>113929</td>
      <td>US</td>
      <td>In 2005 Charles Smith introduced three high-en...</td>
      <td>100</td>
      <td>80.0</td>
      <td>Washington</td>
      <td>Columbia Valley (WA)</td>
      <td>Paul Gregutt</td>
      <td>@paulgwine</td>
      <td>Charles Smith 2006 Royal City Syrah (Columbia ...</td>
      <td>Syrah</td>
      <td>Charles Smith</td>
    </tr>
    <tr>
      <th>11</th>
      <td>5ed80dcfa25fcf74611b499d</td>
      <td>114972</td>
      <td>Portugal</td>
      <td>A powerful and ripe wine, strongly influenced ...</td>
      <td>100</td>
      <td>650.0</td>
      <td>Port</td>
      <td>None</td>
      <td>Roger Voss</td>
      <td>@vossroger</td>
      <td>Quinta do Noval 2011 Nacional Vintage  (Port)</td>
      <td>Port</td>
      <td>Quinta do Noval</td>
    </tr>
    <tr>
      <th>12</th>
      <td>5ed80dcfa25fcf74611b6300</td>
      <td>122935</td>
      <td>France</td>
      <td>Full of ripe fruit, opulent and concentrated, ...</td>
      <td>100</td>
      <td>848.0</td>
      <td>Bordeaux</td>
      <td>Pessac-Léognan</td>
      <td>Roger Voss</td>
      <td>@vossroger</td>
      <td>Château Haut-Brion 2014  Pessac-Léognan</td>
      <td>Bordeaux-style White Blend</td>
      <td>Château Haut-Brion</td>
    </tr>
    <tr>
      <th>13</th>
      <td>5ed80dcfa25fcf74611b64d4</td>
      <td>123545</td>
      <td>US</td>
      <td>Initially a rather subdued Frog; as if it has ...</td>
      <td>100</td>
      <td>80.0</td>
      <td>Washington</td>
      <td>Walla Walla Valley (WA)</td>
      <td>Paul Gregutt</td>
      <td>@paulgwine</td>
      <td>Cayuse 2008 Bionic Frog Syrah (Walla Walla Val...</td>
      <td>Syrah</td>
      <td>Cayuse</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>To see wines with a score of 100 and a cost of less than \<span class="math notranslate nohighlight">\(100, we can use the `\)</span>lt` operator:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;points&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$lt&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}}</span>
<span class="n">mongo_read_query</span><span class="p">(</span><span class="n">winecollection</span><span class="p">,</span> <span class="n">myquery</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>_id</th>
      <th>wine_id</th>
      <th>country</th>
      <th>description</th>
      <th>points</th>
      <th>price</th>
      <th>province</th>
      <th>region</th>
      <th>taster_name</th>
      <th>taster_twitter_handle</th>
      <th>title</th>
      <th>variety</th>
      <th>winery</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5ed80dcfa25fcf74611b4648</td>
      <td>113929</td>
      <td>US</td>
      <td>In 2005 Charles Smith introduced three high-en...</td>
      <td>100</td>
      <td>80.0</td>
      <td>Washington</td>
      <td>Columbia Valley (WA)</td>
      <td>Paul Gregutt</td>
      <td>@paulgwine</td>
      <td>Charles Smith 2006 Royal City Syrah (Columbia ...</td>
      <td>Syrah</td>
      <td>Charles Smith</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5ed80dcfa25fcf74611b64d4</td>
      <td>123545</td>
      <td>US</td>
      <td>Initially a rather subdued Frog; as if it has ...</td>
      <td>100</td>
      <td>80.0</td>
      <td>Washington</td>
      <td>Walla Walla Valley (WA)</td>
      <td>Paul Gregutt</td>
      <td>@paulgwine</td>
      <td>Cayuse 2008 Bionic Frog Syrah (Walla Walla Val...</td>
      <td>Syrah</td>
      <td>Cayuse</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>To see wines that are from Ohio or North Carolina, we use the <code class="docutils literal notranslate"><span class="pre">$in</span></code> operator:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;province&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$in&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Ohio&#39;</span><span class="p">,</span><span class="s1">&#39;North Carolina&#39;</span><span class="p">]}}</span>
<span class="n">mongo_read_query</span><span class="p">(</span><span class="n">winecollection</span><span class="p">,</span> <span class="n">myquery</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>_id</th>
      <th>wine_id</th>
      <th>country</th>
      <th>description</th>
      <th>points</th>
      <th>price</th>
      <th>province</th>
      <th>region</th>
      <th>taster_name</th>
      <th>taster_twitter_handle</th>
      <th>title</th>
      <th>variety</th>
      <th>winery</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5ed80dcea25fcf74611a0d3f</td>
      <td>13402</td>
      <td>US</td>
      <td>Clove and pepper spice the dark red cherry aro...</td>
      <td>86</td>
      <td>17.0</td>
      <td>North Carolina</td>
      <td>Swan Creek</td>
      <td>Anna Lee C. Iijima</td>
      <td>None</td>
      <td>Raffaldini 2007 Montepulciano (Swan Creek)</td>
      <td>Montepulciano</td>
      <td>Raffaldini</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5ed80dcea25fcf74611a167b</td>
      <td>16270</td>
      <td>US</td>
      <td>The nose shows an aroma of blackberry that is ...</td>
      <td>86</td>
      <td>17.0</td>
      <td>North Carolina</td>
      <td>Yadkin Valley</td>
      <td>Alexander Peartree</td>
      <td>None</td>
      <td>Shadow Springs 2011 Cabernet Franc (Yadkin Val...</td>
      <td>Cabernet Franc</td>
      <td>Shadow Springs</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5ed80dcea25fcf74611a20a2</td>
      <td>19566</td>
      <td>US</td>
      <td>Fruits, flowers and spice should lead the nose...</td>
      <td>80</td>
      <td>15.0</td>
      <td>Ohio</td>
      <td>Ohio</td>
      <td>Susan Kostrzewa</td>
      <td>@suskostrzewa</td>
      <td>Hermes 2006 Estate Bottled Nebbiolo (Ohio)</td>
      <td>Nebbiolo</td>
      <td>Hermes</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5ed80dcea25fcf74611a23ee</td>
      <td>20592</td>
      <td>US</td>
      <td>Stewed blackberries and muddled cherries perva...</td>
      <td>86</td>
      <td>23.0</td>
      <td>North Carolina</td>
      <td>Swan Creek</td>
      <td>Alexander Peartree</td>
      <td>None</td>
      <td>Raffaldini 2012 Riserva Sangiovese (Swan Creek)</td>
      <td>Sangiovese</td>
      <td>Raffaldini</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5ed80dcea25fcf74611a5fc4</td>
      <td>39935</td>
      <td>US</td>
      <td>Friendly, appealing flavors fo pear, lychee, a...</td>
      <td>84</td>
      <td>12.0</td>
      <td>Ohio</td>
      <td>Grand River Valley</td>
      <td>Susan Kostrzewa</td>
      <td>@suskostrzewa</td>
      <td>Debonné 2008 Reserve Riesling (Grand River Val...</td>
      <td>Riesling</td>
      <td>Debonné</td>
    </tr>
    <tr>
      <th>5</th>
      <td>5ed80dcea25fcf74611a686c</td>
      <td>42692</td>
      <td>US</td>
      <td>Friendly, appealing flavors fo pear, lychee, a...</td>
      <td>84</td>
      <td>12.0</td>
      <td>Ohio</td>
      <td>Grand River Valley</td>
      <td>Susan Kostrzewa</td>
      <td>@suskostrzewa</td>
      <td>Debonné 2008 Reserve Riesling (Grand River Val...</td>
      <td>Riesling</td>
      <td>Debonné</td>
    </tr>
    <tr>
      <th>6</th>
      <td>5ed80dcea25fcf74611a7033</td>
      <td>45209</td>
      <td>US</td>
      <td>Freshly squeezed lemons, lime and pretty white...</td>
      <td>84</td>
      <td>16.0</td>
      <td>North Carolina</td>
      <td>Swan Creek</td>
      <td>Anna Lee C. Iijima</td>
      <td>None</td>
      <td>Raffaldini 2009 Pinot Grigio (Swan Creek)</td>
      <td>Pinot Grigio</td>
      <td>Raffaldini</td>
    </tr>
    <tr>
      <th>7</th>
      <td>5ed80dcea25fcf74611a74db</td>
      <td>46670</td>
      <td>US</td>
      <td>Black fruit aromas show over toasted vanilla a...</td>
      <td>85</td>
      <td>29.0</td>
      <td>North Carolina</td>
      <td>Swan Creek</td>
      <td>Alexander Peartree</td>
      <td>None</td>
      <td>Raffaldini 2012 Riserva Montepulciano (Swan Cr...</td>
      <td>Montepulciano</td>
      <td>Raffaldini</td>
    </tr>
    <tr>
      <th>8</th>
      <td>5ed80dcea25fcf74611a7c95</td>
      <td>49154</td>
      <td>US</td>
      <td>Lean and racy, with limes and tart green apple...</td>
      <td>86</td>
      <td>10.0</td>
      <td>North Carolina</td>
      <td>North Carolina</td>
      <td>Joe Czerwinski</td>
      <td>@JoeCz</td>
      <td>Shelton Vineyards 2002 Riesling (North Carolina)</td>
      <td>Riesling</td>
      <td>Shelton Vineyards</td>
    </tr>
    <tr>
      <th>9</th>
      <td>5ed80dcea25fcf74611a8518</td>
      <td>52078</td>
      <td>US</td>
      <td>Charred oak, green herbs and vanilla spice not...</td>
      <td>82</td>
      <td>18.0</td>
      <td>North Carolina</td>
      <td>Yadkin Valley</td>
      <td>Anna Lee C. Iijima</td>
      <td>None</td>
      <td>Divine Llama 2007 In a Heart Beat Red (Yadkin ...</td>
      <td>R. Blend</td>
      <td>Divine Llama</td>
    </tr>
    <tr>
      <th>10</th>
      <td>5ed80dcea25fcf74611a8fe5</td>
      <td>55687</td>
      <td>US</td>
      <td>Mostly Sangiovese with a small dose of Petit V...</td>
      <td>84</td>
      <td>17.0</td>
      <td>North Carolina</td>
      <td>Swan Creek</td>
      <td>Anna Lee C. Iijima</td>
      <td>None</td>
      <td>Raffaldini 2007 Riserva Sangiovese (Swan Creek)</td>
      <td>Sangiovese</td>
      <td>Raffaldini</td>
    </tr>
    <tr>
      <th>11</th>
      <td>5ed80dcea25fcf74611a8fe9</td>
      <td>55693</td>
      <td>US</td>
      <td>Aromas of toasted oak, green leaves, vanilla a...</td>
      <td>84</td>
      <td>25.0</td>
      <td>North Carolina</td>
      <td>North Carolina</td>
      <td>Anna Lee C. Iijima</td>
      <td>None</td>
      <td>RayLen 2006 Eagle's Select Red Wine Red (North...</td>
      <td>Bordeaux-style Red Blend</td>
      <td>RayLen</td>
    </tr>
    <tr>
      <th>12</th>
      <td>5ed80dcfa25fcf74611ac51f</td>
      <td>72535</td>
      <td>US</td>
      <td>Who knew Ohio made such tasty Chardonnay? Brig...</td>
      <td>87</td>
      <td>11.0</td>
      <td>Ohio</td>
      <td>Grand River Valley</td>
      <td>Anna Lee C. Iijima</td>
      <td>None</td>
      <td>Debonné 2009 Chardonnay (Grand River Valley)</td>
      <td>Chardonnay</td>
      <td>Debonné</td>
    </tr>
    <tr>
      <th>13</th>
      <td>5ed80dcfa25fcf74611ae168</td>
      <td>81619</td>
      <td>US</td>
      <td>Strawberry and raspberry Kool-Aid aromas are s...</td>
      <td>85</td>
      <td>21.0</td>
      <td>North Carolina</td>
      <td>Swan Creek</td>
      <td>Alexander Peartree</td>
      <td>None</td>
      <td>Laurel Gray 2012 Estate Grown Cabernet Franc (...</td>
      <td>Cabernet Franc</td>
      <td>Laurel Gray</td>
    </tr>
    <tr>
      <th>14</th>
      <td>5ed80dcfa25fcf74611af839</td>
      <td>88841</td>
      <td>US</td>
      <td>This is a vibrant, energetic Chardonnay that s...</td>
      <td>84</td>
      <td>17.0</td>
      <td>Ohio</td>
      <td>Grand River Valley</td>
      <td>Susan Kostrzewa</td>
      <td>@suskostrzewa</td>
      <td>Debonné 2007 Vintner's Selection Chardonnay (G...</td>
      <td>Chardonnay</td>
      <td>Debonné</td>
    </tr>
    <tr>
      <th>15</th>
      <td>5ed80dcfa25fcf74611b08bb</td>
      <td>94267</td>
      <td>US</td>
      <td>Although the nose offers darker notes of petro...</td>
      <td>83</td>
      <td>15.0</td>
      <td>Ohio</td>
      <td>Grand River Valley</td>
      <td>Anna Lee C. Iijima</td>
      <td>None</td>
      <td>Debonné 2008 Lot 807 Reserve Riesling (Grand R...</td>
      <td>Riesling</td>
      <td>Debonné</td>
    </tr>
    <tr>
      <th>16</th>
      <td>5ed80dcfa25fcf74611b08be</td>
      <td>94275</td>
      <td>US</td>
      <td>The nose on this bright red blend from Sanders...</td>
      <td>83</td>
      <td>18.0</td>
      <td>North Carolina</td>
      <td>Yadkin Valley</td>
      <td>Anna Lee C. Iijima</td>
      <td>None</td>
      <td>Sanders Ridge 2008 Big Woods Red (Yadkin Valley)</td>
      <td>Bordeaux-style Red Blend</td>
      <td>Sanders Ridge</td>
    </tr>
    <tr>
      <th>17</th>
      <td>5ed80dcfa25fcf74611b13ff</td>
      <td>97836</td>
      <td>US</td>
      <td>Smoke wafts over pressed apple and lemon notes...</td>
      <td>83</td>
      <td>13.0</td>
      <td>North Carolina</td>
      <td>North Carolina</td>
      <td>Anna Lee C. Iijima</td>
      <td>None</td>
      <td>RayLen 2009 Riesling (North Carolina)</td>
      <td>Riesling</td>
      <td>RayLen</td>
    </tr>
    <tr>
      <th>18</th>
      <td>5ed80dcfa25fcf74611b1c1f</td>
      <td>100445</td>
      <td>US</td>
      <td>Fresh minerality and dancing floral notes make...</td>
      <td>84</td>
      <td>11.0</td>
      <td>Ohio</td>
      <td>Grand River Valley</td>
      <td>Susan Kostrzewa</td>
      <td>@suskostrzewa</td>
      <td>Debonné 2006 Reserve Riesling (Grand River Val...</td>
      <td>Riesling</td>
      <td>Debonné</td>
    </tr>
    <tr>
      <th>19</th>
      <td>5ed80dcfa25fcf74611b1c23</td>
      <td>100452</td>
      <td>US</td>
      <td>A slightly floral but lively nose is followed ...</td>
      <td>84</td>
      <td>15.0</td>
      <td>Ohio</td>
      <td>Grand River Valley</td>
      <td>Susan Kostrzewa</td>
      <td>@suskostrzewa</td>
      <td>Debonné 2006 Lot 707 Reserve Riesling (Grand R...</td>
      <td>Riesling</td>
      <td>Debonné</td>
    </tr>
    <tr>
      <th>20</th>
      <td>5ed80dcfa25fcf74611b29f1</td>
      <td>104722</td>
      <td>US</td>
      <td>There are enticing hints of berries and cream ...</td>
      <td>86</td>
      <td>15.0</td>
      <td>North Carolina</td>
      <td>North Carolina</td>
      <td>Anna Lee C. Iijima</td>
      <td>None</td>
      <td>Biltmore Estate 2010 Reserve Chardonnay (North...</td>
      <td>Chardonnay</td>
      <td>Biltmore Estate</td>
    </tr>
    <tr>
      <th>21</th>
      <td>5ed80dcfa25fcf74611b4fb6</td>
      <td>116912</td>
      <td>US</td>
      <td>Black cherry aromas are dwarfed by notes of wi...</td>
      <td>83</td>
      <td>24.0</td>
      <td>North Carolina</td>
      <td>Swan Creek</td>
      <td>Alexander Peartree</td>
      <td>None</td>
      <td>Raffaldini 2012 Montepulciano (Swan Creek)</td>
      <td>Montepulciano</td>
      <td>Raffaldini</td>
    </tr>
    <tr>
      <th>22</th>
      <td>5ed80dcfa25fcf74611b55ee</td>
      <td>118895</td>
      <td>US</td>
      <td>Bright red fruits achieve a decent amount of r...</td>
      <td>84</td>
      <td>18.0</td>
      <td>North Carolina</td>
      <td>North Carolina</td>
      <td>Anna Lee C. Iijima</td>
      <td>None</td>
      <td>RayLen 2008 Category 5 Red Wine Red (North Car...</td>
      <td>R. Blend</td>
      <td>RayLen</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>To illustrate the “or” operator, we can query all wines that are either from Virginia, or have a score of 100:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;$or&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;points&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;province&#39;</span><span class="p">:</span> <span class="s1">&#39;Virginia&#39;</span><span class="p">}]}</span>
<span class="n">mongo_read_query</span><span class="p">(</span><span class="n">winecollection</span><span class="p">,</span> <span class="n">myquery</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>_id</th>
      <th>wine_id</th>
      <th>country</th>
      <th>description</th>
      <th>points</th>
      <th>price</th>
      <th>province</th>
      <th>region</th>
      <th>taster_name</th>
      <th>taster_twitter_handle</th>
      <th>title</th>
      <th>variety</th>
      <th>winery</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5ed80dcca25fcf746119e3bd</td>
      <td>19</td>
      <td>US</td>
      <td>Red fruit aromas pervade on the nose, with cig...</td>
      <td>87</td>
      <td>32.0</td>
      <td>Virginia</td>
      <td>Virginia</td>
      <td>Alexander Peartree</td>
      <td>None</td>
      <td>Quiévremont 2012 Meritage (Virginia)</td>
      <td>Meritage</td>
      <td>Quiévremont</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5ed80dcca25fcf746119e3be</td>
      <td>20</td>
      <td>US</td>
      <td>Ripe aromas of dark berries mingle with ample ...</td>
      <td>87</td>
      <td>23.0</td>
      <td>Virginia</td>
      <td>Virginia</td>
      <td>Alexander Peartree</td>
      <td>None</td>
      <td>Quiévremont 2012 Vin de Maison Red (Virginia)</td>
      <td>R. Blend</td>
      <td>Quiévremont</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5ed80dcca25fcf746119e498</td>
      <td>345</td>
      <td>Australia</td>
      <td>This wine contains some material over 100 year...</td>
      <td>100</td>
      <td>350.0</td>
      <td>Victoria</td>
      <td>Rutherglen</td>
      <td>Joe Czerwinski</td>
      <td>@JoeCz</td>
      <td>Chambers Rosewood Vineyards NV Rare Muscat (Ru...</td>
      <td>Muscat</td>
      <td>Chambers Rosewood Vineyards</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5ed80dcea25fcf746119e8d0</td>
      <td>1625</td>
      <td>US</td>
      <td>Popping with aromas of lychee, rose, geranium ...</td>
      <td>85</td>
      <td>16.0</td>
      <td>Virginia</td>
      <td>Virginia</td>
      <td>Carrie Dykes</td>
      <td>None</td>
      <td>The Williamsburg Winery 2015 A Midsummer Night...</td>
      <td>White Blend</td>
      <td>The Williamsburg Winery</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5ed80dcea25fcf746119e8d6</td>
      <td>1631</td>
      <td>US</td>
      <td>Powerful aromas of lychee, mango and peach giv...</td>
      <td>85</td>
      <td>22.0</td>
      <td>Virginia</td>
      <td>Middleburg</td>
      <td>Carrie Dykes</td>
      <td>None</td>
      <td>Blue Valley 2015 Muskat Ottonel (Middleburg)</td>
      <td>Muskat Ottonel</td>
      <td>Blue Valley</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>388</th>
      <td>5ed80dcfa25fcf74611b71b3</td>
      <td>127736</td>
      <td>US</td>
      <td>Dense with alluring aromas, this wine is full ...</td>
      <td>88</td>
      <td>30.0</td>
      <td>Virginia</td>
      <td>Virginia</td>
      <td>Carrie Dykes</td>
      <td>None</td>
      <td>Early Mountain 2015 Elevation Red (Virginia)</td>
      <td>R. Blend</td>
      <td>Early Mountain</td>
    </tr>
    <tr>
      <th>389</th>
      <td>5ed80dcfa25fcf74611b71bd</td>
      <td>127746</td>
      <td>US</td>
      <td>A grape known in Uruguay and Madiran has prove...</td>
      <td>88</td>
      <td>25.0</td>
      <td>Virginia</td>
      <td>Virginia</td>
      <td>Carrie Dykes</td>
      <td>None</td>
      <td>Horton 2014 Tannat (Virginia)</td>
      <td>Tannat</td>
      <td>Horton</td>
    </tr>
    <tr>
      <th>390</th>
      <td>5ed80dcfa25fcf74611b7447</td>
      <td>128576</td>
      <td>US</td>
      <td>Peach and steely lemon aromas carry to a citru...</td>
      <td>87</td>
      <td>28.0</td>
      <td>Virginia</td>
      <td>Monticello</td>
      <td>Alexander Peartree</td>
      <td>None</td>
      <td>Pollak 2012 Reserve Chardonnay (Monticello)</td>
      <td>Chardonnay</td>
      <td>Pollak</td>
    </tr>
    <tr>
      <th>391</th>
      <td>5ed80dcfa25fcf74611b7708</td>
      <td>129422</td>
      <td>US</td>
      <td>The nose of this wine is bursting with raspber...</td>
      <td>89</td>
      <td>32.0</td>
      <td>Virginia</td>
      <td>Monticello</td>
      <td>Carrie Dykes</td>
      <td>None</td>
      <td>Stinson 2014 Meritage (Monticello)</td>
      <td>Meritage</td>
      <td>Stinson</td>
    </tr>
    <tr>
      <th>392</th>
      <td>5ed80dcfa25fcf74611b772a</td>
      <td>129459</td>
      <td>US</td>
      <td>Somehow, winemaker Luca Paschina manages to ma...</td>
      <td>87</td>
      <td>23.0</td>
      <td>Virginia</td>
      <td>Virginia</td>
      <td>Carrie Dykes</td>
      <td>None</td>
      <td>Barboursville Vineyards 2015 Reserve Vermentin...</td>
      <td>Vermentino</td>
      <td>Barboursville Vineyards</td>
    </tr>
  </tbody>
</table>
<p>393 rows × 13 columns</p>
</div></div></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">$expr</span></code> requires an operator that compares two keys, and creates a sentence like “X is greater than or equal to Y”. Next it requires a list that specifies what X in the sentence should be, then what Y should be. To search for all wines in which the price is greater than the score we use the <code class="docutils literal notranslate"><span class="pre">$expr</span></code> operator as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;$expr&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$gt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;$price&#39;</span><span class="p">,</span> <span class="s1">&#39;$points&#39;</span><span class="p">]}}</span>
<span class="n">mongo_read_query</span><span class="p">(</span><span class="n">winecollection</span><span class="p">,</span> <span class="n">myquery</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>_id</th>
      <th>wine_id</th>
      <th>country</th>
      <th>description</th>
      <th>points</th>
      <th>price</th>
      <th>province</th>
      <th>region</th>
      <th>taster_name</th>
      <th>taster_twitter_handle</th>
      <th>title</th>
      <th>variety</th>
      <th>winery</th>
      <th>location</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5ed80dcca25fcf746119e3d4</td>
      <td>60.0</td>
      <td>US</td>
      <td>Syrupy and dense, this wine is jammy in plum a...</td>
      <td>86.0</td>
      <td>100</td>
      <td>California</td>
      <td>Napa Valley</td>
      <td>Virginie Boone</td>
      <td>@vboone</td>
      <td>Okapi 2013 Estate Cabernet Sauvignon (Napa Val...</td>
      <td>Cabernet Sauvignon</td>
      <td>Okapi</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5ed80dcca25fcf746119e42c</td>
      <td>168.0</td>
      <td>US</td>
      <td>A fairly elegant expression of the variety, th...</td>
      <td>91.0</td>
      <td>95</td>
      <td>California</td>
      <td>Napa Valley</td>
      <td>Virginie Boone</td>
      <td>@vboone</td>
      <td>Duckhorn 2012 Rector Creek Vineyard Merlot (Na...</td>
      <td>Merlot</td>
      <td>Duckhorn</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5ed80dcca25fcf746119e476</td>
      <td>284.0</td>
      <td>Argentina</td>
      <td>This huge Malbec defines jammy and concentrate...</td>
      <td>92.0</td>
      <td>215</td>
      <td>Mendoza Province</td>
      <td>Perdriel</td>
      <td>Michael Schachner</td>
      <td>@wineschach</td>
      <td>Viña Cobos 2011 Marchiori Vineyard Block C2 Ma...</td>
      <td>Malbec</td>
      <td>Viña Cobos</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5ed80dcca25fcf746119e498</td>
      <td>345.0</td>
      <td>Australia</td>
      <td>This wine contains some material over 100 year...</td>
      <td>100.0</td>
      <td>350</td>
      <td>Victoria</td>
      <td>Rutherglen</td>
      <td>Joe Czerwinski</td>
      <td>@JoeCz</td>
      <td>Chambers Rosewood Vineyards NV Rare Muscat (Ru...</td>
      <td>Muscat</td>
      <td>Chambers Rosewood Vineyards</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5ed80dcca25fcf746119e499</td>
      <td>346.0</td>
      <td>Australia</td>
      <td>This deep brown wine smells like a damp, mossy...</td>
      <td>98.0</td>
      <td>350</td>
      <td>Victoria</td>
      <td>Rutherglen</td>
      <td>Joe Czerwinski</td>
      <td>@JoeCz</td>
      <td>Chambers Rosewood Vineyards NV Rare Muscadelle...</td>
      <td>Muscadelle</td>
      <td>Chambers Rosewood Vineyards</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3697</th>
      <td>5ed80dcfa25fcf74611b78a8</td>
      <td>129919.0</td>
      <td>US</td>
      <td>This ripe, rich, almost decadently thick wine ...</td>
      <td>91.0</td>
      <td>105</td>
      <td>Washington</td>
      <td>Walla Walla Valley (WA)</td>
      <td>Paul Gregutt</td>
      <td>@paulgwine</td>
      <td>Nicholas Cole Cellars 2004 Reserve Red (Walla ...</td>
      <td>R. Blend</td>
      <td>Nicholas Cole Cellars</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3698</th>
      <td>5ed80dcfa25fcf74611b78b2</td>
      <td>129931.0</td>
      <td>France</td>
      <td>A powerful, chunky wine, packed with solid tan...</td>
      <td>91.0</td>
      <td>107</td>
      <td>Burgundy</td>
      <td>Grands-Echezeaux</td>
      <td>Roger Voss</td>
      <td>@vossroger</td>
      <td>Henri de Villamont 2005  Grands-Echezeaux</td>
      <td>Pinot Noir</td>
      <td>Henri de Villamont</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3699</th>
      <td>5edd56e5b4e58ce3841e5dea</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>This wine goes great with dinner just like Dwy...</td>
      <td>NaN</td>
      <td>35</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Jonathan Kropko</td>
      <td>@jmk5131</td>
      <td>2016 Napa Valley Three By Wade Red Blend</td>
      <td>Red Blend</td>
      <td>NaN</td>
      <td>{'region_1': 'Napa Valley', 'region_2': None, ...</td>
    </tr>
    <tr>
      <th>3700</th>
      <td>5edd56e6b4e58ce3841e5deb</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>This wine will make you speak differently. May...</td>
      <td>NaN</td>
      <td>40.99</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Jonathan Kropko</td>
      <td>@jmk5131</td>
      <td>Anta Banderas A 10 2008</td>
      <td>Red Blend</td>
      <td>NaN</td>
      <td>{'region_1': 'Ribera del Duoro', 'region_2': N...</td>
    </tr>
    <tr>
      <th>3701</th>
      <td>5edd56e6b4e58ce3841e5dec</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Someone drank my entire bottle of wine!</td>
      <td>NaN</td>
      <td>14.99</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Jonathan Kropko</td>
      <td>@jmk5131</td>
      <td>Barrymore Rose 2013</td>
      <td>Rose</td>
      <td>NaN</td>
      <td>{'region_1': 'Monterey', 'region_2': None, 'pr...</td>
    </tr>
  </tbody>
</table>
<p>3702 rows × 14 columns</p>
</div></div></div>
</div>
<p>In the previous section, we entered a record for a wine released by former NBA all-star Dwyane Wade, and we purposely included a nested structure in this JSON record. The <code class="docutils literal notranslate"><span class="pre">location</span></code> key has subkeys <code class="docutils literal notranslate"><span class="pre">region_1</span></code>, <code class="docutils literal notranslate"><span class="pre">region_2</span></code>, <code class="docutils literal notranslate"><span class="pre">province</span></code>, <code class="docutils literal notranslate"><span class="pre">country</span></code>, and <code class="docutils literal notranslate"><span class="pre">winery</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dwadewine</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;title&#39;: &#39;2016 Napa Valley Three By Wade Red Blend&#39;,
 &#39;description&#39;: &#39;This wine goes great with dinner just like Dwyane Wade goes great with LeBron James or Shaq.&#39;,
 &#39;taster_name&#39;: &#39;Jonathan Kropko&#39;,
 &#39;taster_twitter_handle&#39;: &#39;@jmk5131&#39;,
 &#39;price&#39;: &#39;35&#39;,
 &#39;variety&#39;: &#39;Red Blend&#39;,
 &#39;location&#39;: {&#39;region_1&#39;: &#39;Napa Valley&#39;,
  &#39;region_2&#39;: None,
  &#39;province&#39;: &#39;California&#39;,
  &#39;country&#39;: &#39;U.S.&#39;,
  &#39;winery&#39;: &#39;D Wade Cellars&#39;},
 &#39;_id&#39;: ObjectId(&#39;5edd56e5b4e58ce3841e5dea&#39;)}
</pre></div>
</div>
</div>
</div>
<p>To query a subrecord, use dot notation of the form <code class="docutils literal notranslate"><span class="pre">'key.subkey'</span></code> to identify the path to the value you need. To query for the winery name “D Wade Cellars”, we can type:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myquery</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;location.winery&#39;</span><span class="p">:</span> <span class="s1">&#39;D Wade Cellars&#39;</span><span class="p">}</span>
<span class="n">mongo_read_query</span><span class="p">(</span><span class="n">winecollection</span><span class="p">,</span> <span class="n">myquery</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>_id</th>
      <th>title</th>
      <th>description</th>
      <th>taster_name</th>
      <th>taster_twitter_handle</th>
      <th>price</th>
      <th>variety</th>
      <th>location</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5edd56e5b4e58ce3841e5dea</td>
      <td>2016 Napa Valley Three By Wade Red Blend</td>
      <td>This wine goes great with dinner just like Dwy...</td>
      <td>Jonathan Kropko</td>
      <td>@jmk5131</td>
      <td>35</td>
      <td>Red Blend</td>
      <td>{'region_1': 'Napa Valley', 'region_2': None, ...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="selecting-features">
<h3><a class="toc-backref" href="#id35" role="doc-backlink"><span class="section-number">7.8.3. </span>Selecting Features</a><a class="headerlink" href="#selecting-features" title="Permalink to this heading">#</a></h3>
<p>A read query in MongoDB will return the entire JSON dictionary for every record that matches the query. Sometimes, however, the entirety of the data for one record will be more information than we can feasibly work with. In some situations there might be an unmanagable number of features contained within each dictionary, and we only want to use a couple of these features. In other situations a feature might contain values that are so large that we want to avoid dealing with this feature if possible.</p>
<p>To extract only a selection of the features, add a second JSON clause to the <code class="docutils literal notranslate"><span class="pre">.find()</span></code> method. The general syntax for selecting features is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="n">query</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;feature&#39;</span><span class="o">=</span><span class="mi">1</span><span class="p">}}</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">{query}</span></code> is code, as described above, for extracting a selection of the records, and <code class="docutils literal notranslate"><span class="pre">{'feature'=1}</span></code> instructs MongoDB to include only the field named <code class="docutils literal notranslate"><span class="pre">feature</span></code> in the output. Alternatively, it is possible to list as many keys in this second clause as we want, so <code class="docutils literal notranslate"><span class="pre">{'feature1'=1,</span> <span class="pre">'feature2'=1}</span></code> extracts <code class="docutils literal notranslate"><span class="pre">feature1</span></code> and <code class="docutils literal notranslate"><span class="pre">feature2</span></code>. In addition, setting the key equal to 0 instead of 1 instructs MongoDB to extract all features <em>except</em> the one specified with <code class="docutils literal notranslate"><span class="pre">'feature'=0</span></code>.</p>
<p>In the wine collection, we can extract only the titles of Merlot wines with the following code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cursor</span> <span class="o">=</span> <span class="n">winecollection</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;variety&#39;</span><span class="p">:</span> <span class="s1">&#39;Merlot&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="n">qtext</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
<span class="n">qrec</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">qtext</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">qrec</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>_id</th>
      <th>title</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5ed80dcca25fcf746119e3c1</td>
      <td>Bianchi 2011 Signature Selection Merlot (Paso ...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5ed80dcca25fcf746119e3cd</td>
      <td>Sundance 2011 Merlot (Maule Valley)</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5ed80dcca25fcf746119e3ef</td>
      <td>Passaggio 2014 Blau Vineyards Merlot (Knights ...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5ed80dcca25fcf746119e42c</td>
      <td>Duckhorn 2012 Rector Creek Vineyard Merlot (Na...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5ed80dcca25fcf746119e437</td>
      <td>Viña Bisquertt 2007 Casa La Joya Reserve Merlo...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2094</th>
      <td>5ed80dcfa25fcf74611b77f0</td>
      <td>Castillo de Monjardin 2009 Deyo Merlot (Navarra)</td>
    </tr>
    <tr>
      <th>2095</th>
      <td>5ed80dcfa25fcf74611b7862</td>
      <td>Bonair 2006 Chateau Puryear Vineyard Merlot (R...</td>
    </tr>
    <tr>
      <th>2096</th>
      <td>5ed80dcfa25fcf74611b7865</td>
      <td>Hyatt 2005 Merlot (Rattlesnake Hills)</td>
    </tr>
    <tr>
      <th>2097</th>
      <td>5ed80dcfa25fcf74611b786b</td>
      <td>Ca' Momi 2013 Reserve Merlot (Carneros)</td>
    </tr>
    <tr>
      <th>2098</th>
      <td>5ed80dcfa25fcf74611b7896</td>
      <td>Psagot 2014 Merlot</td>
    </tr>
  </tbody>
</table>
<p>2099 rows × 2 columns</p>
</div></div></div>
</div>
<p>By default, the only field that is extracted other than the ones we directly specify is <code class="docutils literal notranslate"><span class="pre">_id</span></code>, but we can exclude <code class="docutils literal notranslate"><span class="pre">_id</span></code> as well by typing</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cursor</span> <span class="o">=</span> <span class="n">winecollection</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;variety&#39;</span><span class="p">:</span> <span class="s1">&#39;Merlot&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
<span class="n">qtext</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
<span class="n">qrec</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">qtext</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">qrec</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>title</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Bianchi 2011 Signature Selection Merlot (Paso ...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Sundance 2011 Merlot (Maule Valley)</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Passaggio 2014 Blau Vineyards Merlot (Knights ...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Duckhorn 2012 Rector Creek Vineyard Merlot (Na...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Viña Bisquertt 2007 Casa La Joya Reserve Merlo...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2094</th>
      <td>Castillo de Monjardin 2009 Deyo Merlot (Navarra)</td>
    </tr>
    <tr>
      <th>2095</th>
      <td>Bonair 2006 Chateau Puryear Vineyard Merlot (R...</td>
    </tr>
    <tr>
      <th>2096</th>
      <td>Hyatt 2005 Merlot (Rattlesnake Hills)</td>
    </tr>
    <tr>
      <th>2097</th>
      <td>Ca' Momi 2013 Reserve Merlot (Carneros)</td>
    </tr>
    <tr>
      <th>2098</th>
      <td>Psagot 2014 Merlot</td>
    </tr>
  </tbody>
</table>
<p>2099 rows × 1 columns</p>
</div></div></div>
</div>
<p>To keep the title, variety, points, and price, we type</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cursor</span> <span class="o">=</span> <span class="n">winecollection</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s1">&#39;variety&#39;</span><span class="p">:</span> <span class="s1">&#39;Merlot&#39;</span><span class="p">},</span> 
                             <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                             <span class="s1">&#39;variety&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                             <span class="s1">&#39;points&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                             <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                             <span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
<span class="n">qtext</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
<span class="n">qrec</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">qtext</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">qrec</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>points</th>
      <th>price</th>
      <th>title</th>
      <th>variety</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>87</td>
      <td>22.0</td>
      <td>Bianchi 2011 Signature Selection Merlot (Paso ...</td>
      <td>Merlot</td>
    </tr>
    <tr>
      <th>1</th>
      <td>86</td>
      <td>9.0</td>
      <td>Sundance 2011 Merlot (Maule Valley)</td>
      <td>Merlot</td>
    </tr>
    <tr>
      <th>2</th>
      <td>86</td>
      <td>55.0</td>
      <td>Passaggio 2014 Blau Vineyards Merlot (Knights ...</td>
      <td>Merlot</td>
    </tr>
    <tr>
      <th>3</th>
      <td>91</td>
      <td>95.0</td>
      <td>Duckhorn 2012 Rector Creek Vineyard Merlot (Na...</td>
      <td>Merlot</td>
    </tr>
    <tr>
      <th>4</th>
      <td>88</td>
      <td>11.0</td>
      <td>Viña Bisquertt 2007 Casa La Joya Reserve Merlo...</td>
      <td>Merlot</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2094</th>
      <td>87</td>
      <td>18.0</td>
      <td>Castillo de Monjardin 2009 Deyo Merlot (Navarra)</td>
      <td>Merlot</td>
    </tr>
    <tr>
      <th>2095</th>
      <td>86</td>
      <td>20.0</td>
      <td>Bonair 2006 Chateau Puryear Vineyard Merlot (R...</td>
      <td>Merlot</td>
    </tr>
    <tr>
      <th>2096</th>
      <td>86</td>
      <td>10.0</td>
      <td>Hyatt 2005 Merlot (Rattlesnake Hills)</td>
      <td>Merlot</td>
    </tr>
    <tr>
      <th>2097</th>
      <td>90</td>
      <td>44.0</td>
      <td>Ca' Momi 2013 Reserve Merlot (Carneros)</td>
      <td>Merlot</td>
    </tr>
    <tr>
      <th>2098</th>
      <td>91</td>
      <td>32.0</td>
      <td>Psagot 2014 Merlot</td>
      <td>Merlot</td>
    </tr>
  </tbody>
</table>
<p>2099 rows × 4 columns</p>
</div></div></div>
</div>
</section>
<section id="updating-records">
<h3><a class="toc-backref" href="#id36" role="doc-backlink"><span class="section-number">7.8.4. </span>Updating Records</a><a class="headerlink" href="#updating-records" title="Permalink to this heading">#</a></h3>
<p>Updating records in MongoDB is similar to selecting records in that we use the same logical conditions we use for selecting records for identifying the records we want to edit. The <code class="docutils literal notranslate"><span class="pre">.update_one()</span></code> method, applied to a collection, has two arguments. First we specify a logical condition that identifies the records we want to edit. Then we use the <code class="docutils literal notranslate"><span class="pre">$set</span></code> operator to choose specific fields within the existing JSON record to change. If we want, we can even write an entire replacement dictionary for this record, and write it along with <code class="docutils literal notranslate"><span class="pre">$set</span></code>. For example, to identify the record of the wine from Dwyane Wade’s winery, we can query <code class="docutils literal notranslate"><span class="pre">{'location.winery':</span> <span class="pre">'D</span> <span class="pre">Wade</span> <span class="pre">Cellars'}</span></code> as we did in the previous section. Suppose that we want to edit this record so that the price increases to \$45. We can do so with the following code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">winecollection</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s1">&#39;location.winery&#39;</span><span class="p">:</span> <span class="s1">&#39;D Wade Cellars&#39;</span><span class="p">},</span>
                     <span class="p">{</span><span class="s1">&#39;$set&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">45</span><span class="p">}})</span>
<span class="n">mongo_read_query</span><span class="p">(</span><span class="n">winecollection</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;location.winery&#39;</span><span class="p">:</span> <span class="s1">&#39;D Wade Cellars&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>_id</th>
      <th>title</th>
      <th>description</th>
      <th>taster_name</th>
      <th>taster_twitter_handle</th>
      <th>price</th>
      <th>variety</th>
      <th>location</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5edd56e5b4e58ce3841e5dea</td>
      <td>2016 Napa Valley Three By Wade Red Blend</td>
      <td>This wine goes great with dinner just like Dwy...</td>
      <td>Jonathan Kropko</td>
      <td>@jmk5131</td>
      <td>45</td>
      <td>Red Blend</td>
      <td>{'region_1': 'Napa Valley', 'region_2': None, ...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Suppose that we wanted to add a field that does not currently exist in the record, like <code class="docutils literal notranslate"><span class="pre">points</span></code>. We can use the same syntax to add fields:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">winecollection</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s1">&#39;location.winery&#39;</span><span class="p">:</span> <span class="s1">&#39;D Wade Cellars&#39;</span><span class="p">},</span>
                     <span class="p">{</span><span class="s1">&#39;$set&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">90</span><span class="p">}})</span>
<span class="n">mongo_read_query</span><span class="p">(</span><span class="n">winecollection</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;location.winery&#39;</span><span class="p">:</span> <span class="s1">&#39;D Wade Cellars&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>_id</th>
      <th>title</th>
      <th>description</th>
      <th>taster_name</th>
      <th>taster_twitter_handle</th>
      <th>price</th>
      <th>variety</th>
      <th>location</th>
      <th>score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5edd56e5b4e58ce3841e5dea</td>
      <td>2016 Napa Valley Three By Wade Red Blend</td>
      <td>This wine goes great with dinner just like Dwy...</td>
      <td>Jonathan Kropko</td>
      <td>@jmk5131</td>
      <td>45</td>
      <td>Red Blend</td>
      <td>{'region_1': 'Napa Valley', 'region_2': None, ...</td>
      <td>90</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can change more than one field at a time within one call to the <code class="docutils literal notranslate"><span class="pre">$set</span></code> operator. To change both the score and the price of the Dwyane Wade wine, we can type:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">winecollection</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s1">&#39;location.winery&#39;</span><span class="p">:</span> <span class="s1">&#39;D Wade Cellars&#39;</span><span class="p">},</span>
                     <span class="p">{</span><span class="s1">&#39;$set&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">95</span><span class="p">,</span>
                               <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">}})</span>
<span class="n">mongo_read_query</span><span class="p">(</span><span class="n">winecollection</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;location.winery&#39;</span><span class="p">:</span> <span class="s1">&#39;D Wade Cellars&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>_id</th>
      <th>title</th>
      <th>description</th>
      <th>taster_name</th>
      <th>taster_twitter_handle</th>
      <th>price</th>
      <th>variety</th>
      <th>location</th>
      <th>score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5edd56e5b4e58ce3841e5dea</td>
      <td>2016 Napa Valley Three By Wade Red Blend</td>
      <td>This wine goes great with dinner just like Dwy...</td>
      <td>Jonathan Kropko</td>
      <td>@jmk5131</td>
      <td>50</td>
      <td>Red Blend</td>
      <td>{'region_1': 'Napa Valley', 'region_2': None, ...</td>
      <td>95</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Suppose that the wine is reviewed by LeBron James, NBA star and noted <a class="reference external" href="https://twitter.com/KingJames/status/1239424365621469184?s=20">wine connoisseur</a>, who provided a new score and description. We can update the entire record by first defining a Python variable that contains the record:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dwadewine2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;2016 Napa Valley Three By Wade Red Blend&#39;</span><span class="p">,</span> 
<span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s2">&quot;This wine is very good. Not as great as me. But plenty great enough for Miami.&quot;</span><span class="p">,</span> 
<span class="s1">&#39;taster_name&#39;</span><span class="p">:</span> <span class="s1">&#39;LeBron James&#39;</span><span class="p">,</span> 
<span class="s1">&#39;taster_twitter_handle&#39;</span><span class="p">:</span> <span class="s1">&#39;@kingjames&#39;</span><span class="p">,</span> 
<span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span>
<span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">99</span><span class="p">,</span>
<span class="s1">&#39;variety&#39;</span><span class="p">:</span> <span class="s1">&#39;Red Blend&#39;</span><span class="p">,</span> 
<span class="s1">&#39;location&#39;</span><span class="p">:{</span>
    <span class="s1">&#39;region_1&#39;</span><span class="p">:</span> <span class="s1">&#39;Napa Valley&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;region_2&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="s1">&#39;province&#39;</span><span class="p">:</span> <span class="s1">&#39;California&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;country&#39;</span><span class="p">:</span> <span class="s1">&#39;U.S.&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;winery&#39;</span><span class="p">:</span> <span class="s1">&#39;D Wade Cellars&#39;</span><span class="p">}}</span>
</pre></div>
</div>
</div>
</div>
<p>We can replace the existing record for this wine by specifying this dictionary as the second argument of the <code class="docutils literal notranslate"><span class="pre">.update_one()</span></code> method:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">winecollection</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s1">&#39;location.winery&#39;</span><span class="p">:</span> <span class="s1">&#39;D Wade Cellars&#39;</span><span class="p">},</span>
                     <span class="p">{</span><span class="s1">&#39;$set&#39;</span> <span class="p">:</span> <span class="n">dwadewine2</span><span class="p">})</span>
<span class="n">mongo_read_query</span><span class="p">(</span><span class="n">winecollection</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;location.winery&#39;</span><span class="p">:</span> <span class="s1">&#39;D Wade Cellars&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>_id</th>
      <th>title</th>
      <th>description</th>
      <th>taster_name</th>
      <th>taster_twitter_handle</th>
      <th>price</th>
      <th>variety</th>
      <th>location</th>
      <th>score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5edd56e5b4e58ce3841e5dea</td>
      <td>2016 Napa Valley Three By Wade Red Blend</td>
      <td>This wine is very good. Not as great as me. Bu...</td>
      <td>LeBron James</td>
      <td>@kingjames</td>
      <td>45</td>
      <td>Red Blend</td>
      <td>{'region_1': 'Napa Valley', 'region_2': None, ...</td>
      <td>99</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>A second method for editing records is <code class="docutils literal notranslate"><span class="pre">.update_all()</span></code> which revises every document that matches a query. I don’t recommend using this method except in very specific cases, because it is easy to destroy large portions of a database with a mistyped query. But for the sake of illustration, suppose we wanted to change the names of the “Red Blend” varieties of wines to “R. Blend”. We can do that with the following code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">winecollection</span><span class="o">.</span><span class="n">update_many</span><span class="p">({</span><span class="s1">&#39;variety&#39;</span><span class="p">:</span> <span class="s1">&#39;Red Blend&#39;</span><span class="p">},</span>
                          <span class="p">{</span><span class="s1">&#39;$set&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;variety&#39;</span><span class="p">:</span> <span class="s1">&#39;R. Blend&#39;</span><span class="p">}})</span>
<span class="n">mongo_read_query</span><span class="p">(</span><span class="n">winecollection</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;variety&#39;</span><span class="p">:</span> <span class="s1">&#39;R. Blend&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>_id</th>
      <th>wine_id</th>
      <th>country</th>
      <th>description</th>
      <th>points</th>
      <th>price</th>
      <th>province</th>
      <th>region</th>
      <th>taster_name</th>
      <th>taster_twitter_handle</th>
      <th>title</th>
      <th>variety</th>
      <th>winery</th>
      <th>location</th>
      <th>score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5ed80dcca25fcf746119e3be</td>
      <td>20.0</td>
      <td>US</td>
      <td>Ripe aromas of dark berries mingle with ample ...</td>
      <td>87.0</td>
      <td>23</td>
      <td>Virginia</td>
      <td>Virginia</td>
      <td>Alexander Peartree</td>
      <td>None</td>
      <td>Quiévremont 2012 Vin de Maison Red (Virginia)</td>
      <td>R. Blend</td>
      <td>Quiévremont</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5ed80dcca25fcf746119e3c6</td>
      <td>28.0</td>
      <td>Italy</td>
      <td>Aromas suggest mature berry, scorched earth, a...</td>
      <td>87.0</td>
      <td>17</td>
      <td>Sicily &amp; Sardinia</td>
      <td>Cerasuolo di Vittoria</td>
      <td>Kerin O’Keefe</td>
      <td>@kerinokeefe</td>
      <td>Terre di Giurfo 2011 Mascaria Barricato  (Cera...</td>
      <td>R. Blend</td>
      <td>Terre di Giurfo</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5ed80dcca25fcf746119e3dc</td>
      <td>68.0</td>
      <td>US</td>
      <td>Very deep in color and spicy-smoky in flavor, ...</td>
      <td>86.0</td>
      <td>12</td>
      <td>California</td>
      <td>California</td>
      <td>Jim Gordon</td>
      <td>@gordone_cellars</td>
      <td>Cocobon 2014 Red (California)</td>
      <td>R. Blend</td>
      <td>Cocobon</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5ed80dcca25fcf746119e3f2</td>
      <td>90.0</td>
      <td>US</td>
      <td>This blend of Sangiovese, Malbec, Cabernet Sau...</td>
      <td>88.0</td>
      <td>23</td>
      <td>California</td>
      <td>Sonoma County</td>
      <td>Virginie Boone</td>
      <td>@vboone</td>
      <td>Ferrari-Carano 2014 Siena Red (Sonoma County)</td>
      <td>R. Blend</td>
      <td>Ferrari-Carano</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5ed80dcca25fcf746119e400</td>
      <td>104.0</td>
      <td>Italy</td>
      <td>Made with 65% Sangiovese, 20% Merlot and 15% C...</td>
      <td>87.0</td>
      <td>16</td>
      <td>Tuscany</td>
      <td>Toscana</td>
      <td>Kerin O’Keefe</td>
      <td>@kerinokeefe</td>
      <td>Madonna Alta 2014 Nativo Red (Toscana)</td>
      <td>R. Blend</td>
      <td>Madonna Alta</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>7106</th>
      <td>5ed80dcfa25fcf74611b78b3</td>
      <td>129932.0</td>
      <td>Argentina</td>
      <td>Andeluna's top wines tend to be ripe and plump...</td>
      <td>91.0</td>
      <td>55</td>
      <td>Mendoza Province</td>
      <td>Uco Valley</td>
      <td>Michael Schachner</td>
      <td>@wineschach</td>
      <td>Andeluna 2004 Pasionado Red (Uco Valley)</td>
      <td>R. Blend</td>
      <td>Andeluna</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>7107</th>
      <td>5ed80dcfa25fcf74611b78bd</td>
      <td>129943.0</td>
      <td>Italy</td>
      <td>A blend of Nero d'Avola and Syrah, this convey...</td>
      <td>90.0</td>
      <td>29</td>
      <td>Sicily &amp; Sardinia</td>
      <td>Sicilia</td>
      <td>Kerin O’Keefe</td>
      <td>@kerinokeefe</td>
      <td>Baglio del Cristo di Campobello 2012 Adènzia R...</td>
      <td>R. Blend</td>
      <td>Baglio del Cristo di Campobello</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>7108</th>
      <td>5ed80dcfa25fcf74611b78c1</td>
      <td>129947.0</td>
      <td>Italy</td>
      <td>A blend of 65% Cabernet Sauvignon, 30% Merlot ...</td>
      <td>90.0</td>
      <td>20</td>
      <td>Sicily &amp; Sardinia</td>
      <td>Terre Siciliane</td>
      <td>Kerin O’Keefe</td>
      <td>@kerinokeefe</td>
      <td>Feudo Principi di Butera 2012 Symposio Red (Te...</td>
      <td>R. Blend</td>
      <td>Feudo Principi di Butera</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>7109</th>
      <td>5edd56e5b4e58ce3841e5dea</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>This wine is very good. Not as great as me. Bu...</td>
      <td>NaN</td>
      <td>45</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>LeBron James</td>
      <td>@kingjames</td>
      <td>2016 Napa Valley Three By Wade Red Blend</td>
      <td>R. Blend</td>
      <td>NaN</td>
      <td>{'region_1': 'Napa Valley', 'region_2': None, ...</td>
      <td>99.0</td>
    </tr>
    <tr>
      <th>7110</th>
      <td>5edd56e6b4e58ce3841e5deb</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>This wine will make you speak differently. May...</td>
      <td>NaN</td>
      <td>40.99</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Jonathan Kropko</td>
      <td>@jmk5131</td>
      <td>Anta Banderas A 10 2008</td>
      <td>R. Blend</td>
      <td>NaN</td>
      <td>{'region_1': 'Ribera del Duoro', 'region_2': N...</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>7111 rows × 15 columns</p>
</div></div></div>
</div>
</section>
<section id="performing-text-searches">
<h3><a class="toc-backref" href="#id37" role="doc-backlink"><span class="section-number">7.8.5. </span>Performing Text Searches</a><a class="headerlink" href="#performing-text-searches" title="Permalink to this heading">#</a></h3>
<p>One of the great advantages of a document store database is the ability to search through the text within the documents and extract records that match a certain pattern. A text search in MongoDB involves two steps:</p>
<ul class="simple">
<li><p>First, we will create a <strong>text index</strong>: a particular field in the records that contains the text we want MongoDB to search within.</p></li>
<li><p>Second, we will use the <code class="docutils literal notranslate"><span class="pre">$text</span></code> operator within a call to <code class="docutils literal notranslate"><span class="pre">.find()</span></code> to specify the search terms.</p></li>
</ul>
<p>To create a text index, we can use the syntax</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">collection</span><span class="o">.</span><span class="n">create_index</span><span class="p">[(</span><span class="s1">&#39;keytosearch&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<p>We will replace <code class="docutils literal notranslate"><span class="pre">'keytosearch'</span> <span class="pre">with</span> <span class="pre">the</span> <span class="pre">name</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">field</span> <span class="pre">in</span> <span class="pre">the</span> <span class="pre">JSON</span> <span class="pre">dictionaries</span> <span class="pre">on</span> <span class="pre">which</span> <span class="pre">we</span> <span class="pre">want</span> <span class="pre">to</span> <span class="pre">search,</span> <span class="pre">but</span> <span class="pre">we</span> <span class="pre">will</span> <span class="pre">leave</span> </code>‘text’<code class="docutils literal notranslate"><span class="pre">as</span> <span class="pre">is</span> <span class="pre">because</span> <span class="pre">this</span> <span class="pre">code</span> <span class="pre">tells</span> <span class="pre">MongoDB</span> <span class="pre">to</span> <span class="pre">search</span> <span class="pre">for</span> <span class="pre">text.</span> <span class="pre">The</span> <span class="pre">code</span> <span class="pre">to</span> <span class="pre">set</span> <span class="pre">the</span></code>description<code class="docutils literal notranslate"><span class="pre">field</span> <span class="pre">as</span> <span class="pre">the</span> <span class="pre">text</span> <span class="pre">index</span> <span class="pre">in</span> <span class="pre">the</span></code>winecollection` database is:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">winecollection</span><span class="o">.</span><span class="n">create_index</span><span class="p">([(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;description_text&#39;
</pre></div>
</div>
</div>
</div>
<p>Now that we’ve set the text index, we can search the text in that field. The general syntax for a query with a text search is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;$text&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$search&#39;</span><span class="p">:</span> <span class="s1">&#39;searchterms&#39;</span><span class="p">,</span> <span class="s1">&#39;$caseSensitive&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}}</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">'searchterms'</span></code> contains the terms we want to search for, and <code class="docutils literal notranslate"><span class="pre">'$caseSensitive':</span> <span class="pre">False</span></code> tells MongoDB to ignore cases in the search, so that a search term of “chocolate” also matches to “Chocolate”. Alternatively, <code class="docutils literal notranslate"><span class="pre">'$caseSensitive':</span> <span class="pre">True</span></code> takes case into account when matching records to a query. If a search is not case sensitive, and if it is not diacritic sensitive (taking things like accents into account, which it can do by adding the <code class="docutils literal notranslate"><span class="pre">$diacriticSensitive=True</span></code> option), then <code class="docutils literal notranslate"><span class="pre">$search</span></code> matches on the <strong>stems</strong> of words: the <a class="reference external" href="https://en.wikipedia.org/wiki/Stemming">first several letters in the word</a>, allowing a search term of “blueberry” to also match with “blueberries”.</p>
<p>As a simple example, now that <code class="docutils literal notranslate"><span class="pre">description</span></code> has been set as the text index, we can find all wines with descriptions that contain the word “chocolate”. Here I save the output as a dataframe and display the description for the first wine in the output:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">mongo_read_query</span><span class="p">(</span><span class="n">winecollection</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;$text&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$search&#39;</span><span class="p">:</span><span class="s1">&#39;chocolate&#39;</span><span class="p">,</span> <span class="s1">&#39;$caseSensitive&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}})</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Supermodern in style, with mint, coconut, chocolate and huge black fruit aromas. Powerfully structured and thick-boned, with boysenberry, spice and chocolate in spades. Oaky, broad and layered on the finish, with tobacco, coffee and chocolate finishing notes.&#39;
</pre></div>
</div>
</div>
</div>
<p>To search on more than one term, include the terms in the same string after <code class="docutils literal notranslate"><span class="pre">'$search'</span></code>, separated by spaces. By default, these terms are combined using the “or” operator, so that the query returns any document with at least one of the terms. The following code finds all wines whose descriptions contain “chocolate” or “leather”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">mongo_read_query</span><span class="p">(</span><span class="n">winecollection</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;$text&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$search&#39;</span><span class="p">:</span><span class="s1">&#39;chocolate leather&#39;</span><span class="p">,</span> <span class="s1">&#39;$caseSensitive&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}})</span>
<span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;wine_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">109396</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="c1"># a leathery one</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5930    A whiff of leather introduces a wine with a st...
Name: description, dtype: object
</pre></div>
</div>
</div>
</div>
<p>To search for documents with a phrase that contains a space, enclose the phrase in double quotes, and precede each double-quote with an \ escape character. The following code captures descriptions with the phrase “very good”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">mongo_read_query</span><span class="p">(</span><span class="n">winecollection</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;$text&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$search&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">very good</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;$caseSensitive&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}})</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot;A good to very good wine with medicinality on the nose that takes over the aromatics. There&#39;s also the slightest bit of hard cheese and stem on the bouquet, so overall it is fighting an uphill battle. Along the way it delivers flavors of cough drop, cherry and a good, solid finish.&quot;
</pre></div>
</div>
</div>
</div>
<p>To search for documents that contain multiple search terms at once (an “and” operator), enclose each search term in double quotes with escape characters. We can search for descriptions that contain both “leather” and “chocolate” with the following code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">mongo_read_query</span><span class="p">(</span><span class="n">winecollection</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;$text&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$search&#39;</span><span class="p">:</span><span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">leather</span><span class="se">\&quot;</span><span class="s1"> </span><span class="se">\&quot;</span><span class="s1">chocolate</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;$caseSensitive&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}})</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;A blend of 85% Melnik, 10% Grenache Noir and 5% Petit Verdot, this wine has aromas of saddle leather, cassis and dark chocolate. In the mouth there are flavors of cherry, chocolate and dried blueberry. It has good balance with a soft tannic finish.&#39;
</pre></div>
</div>
</div>
</div>
<p>To exclude a term, we add a negative sign in front of the term we want to exclude. To find all wines whose descriptions contain the word “dark” but not “chocolate”, we type</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">mongo_read_query</span><span class="p">(</span><span class="n">winecollection</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;$text&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$search&#39;</span><span class="p">:</span><span class="s1">&#39;dark -chocolate&#39;</span><span class="p">,</span> <span class="s1">&#39;$caseSensitive&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}})</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Dark, dark, dark is this estate-grown Syrah, closed at the nose except for the profusion of alcohol, grippy with lots of oak and crazy, teeth-staining tannins.&#39;
</pre></div>
</div>
</div>
</div>
<p>Text searches can also be used to construct a search engine. We provide the search terms, and MongoDB generates a score for every document that represents the extent to which the search terms are relevant to the document. Once these scores have been generated, it is possible to sort the documents by the score to find the documents that are most highly related to the search terms.</p>
<p>To rank documents by search-relevancy, we add <code class="docutils literal notranslate"><span class="pre">{'score':</span> <span class="pre">{'$meta':</span> <span class="pre">'textScore'}}</span></code> to the query we pass to the <code class="docutils literal notranslate"><span class="pre">.find()</span></code> method. Here we enter five search terms, “chocolate”, “leather”, “wood”, “dark”, and “smoke”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cursor</span> <span class="o">=</span> <span class="n">winecollection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;$text&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$search&#39;</span><span class="p">:</span> <span class="s1">&#39;chocolate leather wood dark smoke&#39;</span><span class="p">}},</span>
            <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$meta&#39;</span><span class="p">:</span> <span class="s1">&#39;textScore&#39;</span><span class="p">}})</span>
</pre></div>
</div>
</div>
</div>
<p>Next we apply the <code class="docutils literal notranslate"><span class="pre">.sort()</span></code> method to the output, arranging the documents by relevancy score, with the following code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cursor</span><span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;$meta&#39;</span><span class="p">:</span> <span class="s1">&#39;textScore&#39;</span><span class="p">})])</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;pymongo.cursor.Cursor at 0x1361d6438&gt;
</pre></div>
</div>
</div>
</div>
<p>Finally we can convert the output to a dataframe with the following code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qtext</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
<span class="n">qrec</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">qtext</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">qrec</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Among all the wine reviews in the data, here is the wine whose description had the highest relevancy score for “chocolate”, “leather”, “wood”, “dark”, and “smoke”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Big and bold in character, this full-bodied and abundantly tannic wine looks black to the rim and smells like pencil shavings, leather and wood smoke. The flavors are dry but enticing, with dark chocolate, charred beef and black cherry. It needs until at least 2022 to peak.&#39;
</pre></div>
</div>
</div>
</div>
<p>To wrap up our work with the database, we apply the <code class="docutils literal notranslate"><span class="pre">.close()</span></code> method to the MongoDB server:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myclient</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="ch6.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">6. </span>Creating and Connecting to Databases</p>
      </div>
    </a>
    <a class="right-next"
       href="ch8.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">8. </span>Data Wrangling with <code class="docutils literal notranslate"><span class="pre">pandas</span></code></p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-the-history-of-the-structured-query-language-sql">7.1. Introduction: The History of the Structured Query Language (SQL)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#declarative-and-procedural-languages">7.1.1. Declarative and Procedural Languages</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#popularity-of-sql">7.1.2. Popularity of SQL</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-read-update-and-delete-crud-operations">7.2. Create, Read, Update, and Delete (CRUD) Operations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sql-style-capitalization-quotes-new-lines-indentation">7.3. SQL Style: Capitalization, Quotes, New Lines, Indentation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sql-joins">7.4. SQL Joins</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-database-nfl-and-nba-teams">7.4.1. Example Database: NFL and NBA Teams</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#types-of-joins">7.4.2. Types of Joins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inner-joins">7.4.3. Inner Joins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#left-and-right-joins">7.4.4. Left and Right Joins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#full-outer-join">7.4.5. Full (Outer) Join</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#anti-joins">7.4.6. Anti-Joins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#natural-joins">7.4.7. Natural Joins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-joins">7.4.8. Cross Joins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-joins-in-one-query">7.4.9. Multiple Joins in One Query</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#joins-on-more-than-one-index">7.4.10. Joins on More Than One Index</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sql-create-update-and-delete-operations">7.5. SQL Create, Update, and Delete Operations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-new-records">7.5.1. Creating New Records</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#editing-existing-records">7.5.2. Editing Existing Records</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deleting-records">7.5.3. Deleting Records</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cleaning-and-manipulating-data-with-sql-read-operations">7.6. Cleaning and Manipulating Data with SQL Read Operations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-wine-reviews">7.6.1. Example: Wine Reviews</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-columns">7.6.2. Selecting Columns</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#logical-statements">7.6.3. Logical Statements</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#filtering-rows">7.6.4. Filtering Rows</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sorting-data">7.6.5. Sorting Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#renaming-columns-and-transforming-data-values">7.6.6. Renaming Columns and Transforming Data Values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-aggregation">7.6.7. Data Aggregation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#subqueries">7.6.8. Subqueries</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sql-security">7.7. SQL Security</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mongodb-queries">7.8. MongoDB Queries</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-and-deleting-records">7.8.1. Creating and Deleting Records</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-data-and-selecting-records">7.8.2. Reading Data and Selecting Records</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-features">7.8.3. Selecting Features</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#updating-records">7.8.4. Updating Records</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-text-searches">7.8.5. Performing Text Searches</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Jonathan Kropko (jkropko@virginia.edu)
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>